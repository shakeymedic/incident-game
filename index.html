<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INCIDENT Command: UK Major Incident Sim</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .zone-card { transition: all 0.2s; }
        .zone-card:hover { transform: translateY(-2px); }
        .p1-bg { background-color: #fee2e2; border-left: 4px solid #dc2626; }
        .p2-bg { background-color: #fef3c7; border-left: 4px solid #d97706; }
        .p3-bg { background-color: #d1fae5; border-left: 4px solid #059669; }
        .dead-bg { background-color: #e5e7eb; border-left: 4px solid #374151; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useReducer } = React;

        // --- GAME DATA & CONSTANTS ---

        const PHASES = ['Receipt', 'Definitive Care', 'Recovery'];
        
        const ROLES = [
            { id: 'silver', name: 'Hospital Silver', ap: 4, desc: 'Tactical Command, SITREPs, Mutual Aid' },
            { id: 'bronze', name: 'ED Consultant (Bronze)', ap: 5, desc: 'ED Control, Priorities, Staff Allocation' },
            { id: 'triage', name: 'Triage Officer', ap: 5, desc: 'TST/MITT Application, Streaming' },
            { id: 'resident', name: 'ED Resident', ap: 4, desc: 'Assessments, Procedures, Prescribing' },
            { id: 'nurse', name: 'ED Nurse Lead', ap: 4, desc: 'Care delivery, Monitoring, Transfers' },
            { id: 'theatre', name: 'Theatre Coord', ap: 4, desc: 'Surgical List, Emergency Theatre' },
            { id: 'icu', name: 'ICU Coord', ap: 4, desc: 'Critical Care Beds, Vents' },
            { id: 'radio', name: 'Radiology Lead', ap: 3, desc: 'CT/X-Ray Flow' }
        ];

        const ZONES = [
            { id: 'amb', name: 'Ambulance Bay', capacity: 6, type: 'intake' },
            { id: 'triage', name: 'Triage Lane', capacity: 10, type: 'process' },
            { id: 'resus', name: 'Resus (P1)', capacity: 6, type: 'clinical' },
            { id: 'majors', name: 'Majors (P2)', capacity: 12, type: 'clinical' },
            { id: 'minors', name: 'Minors (P3)', capacity: 15, type: 'clinical' },
            { id: 'ct', name: 'CT Scanner', capacity: 1, type: 'diagnostic' },
            { id: 'theatre', name: 'Theatres', capacity: 3, type: 'treatment' },
            { id: 'icu', name: 'ICU/HDU', capacity: 8, type: 'ward' },
            { id: 'ward', name: 'Wards', capacity: 50, type: 'ward' },
            { id: 'morgue', name: 'Temporary Mortuary', capacity: 99, type: 'ward' },
            { id: 'discharged', name: 'Discharged', capacity: 999, type: 'exit' }
        ];

        // A sample of the cards provided in your text files
        const PATIENT_DECK = [
            { id: 'P1-001', category: 'P1', text: 'Gunshot Chest. HR 140, SBP 70. Needs: MTP, Chest Drain, Thoracotomy.', timer: 1, required: ['doctor', 'nurse', 'theatre'] },
            { id: 'P1-002', category: 'P1', text: 'Blast Abdo. Rigid, Distended. Needs: MTP, Laparotomy.', timer: 1, required: ['doctor', 'nurse', 'theatre'] },
            { id: 'P1-003', category: 'P1', text: 'Open Thoracic Wound. Sucking chest wound. Needs: Seal, Drain, Theatre.', timer: 1, required: ['doctor', 'nurse', 'theatre'] },
            { id: 'P1-004', category: 'P1', text: 'Crush Injury + Rhabdo. K+ 7.2. Needs: ICU, Calcium, Insulin/Dex.', timer: 1, required: ['doctor', 'nurse', 'icu'] },
            { id: 'P1-005', category: 'P1', text: 'Impaled Object Abdomen. DO NOT REMOVE. Needs: Theatre removal.', timer: 1, required: ['surgeon', 'theatre'] },
            { id: 'P1-006', category: 'P1', text: 'Near Drowning. Pink frothy sputum. Needs: Intubation, ICU.', timer: 1, required: ['anaesthetist', 'icu'] },
            { id: 'P2-001', category: 'P2', text: 'Stable Penetrating Abdo. Needs: CT, Obs.', timer: 3, required: ['doctor', 'ct'] },
            { id: 'P2-002', category: 'P2', text: 'Pelvic #. Binder on. Stable. Needs: CT, Ortho.', timer: 3, required: ['doctor', 'ct'] },
            { id: 'P2-003', category: 'P2', text: 'TBI GCS 9. Needs: CT Head, Neuro Obs.', timer: 2, required: ['doctor', 'ct', 'icu'] },
            { id: 'P2-004', category: 'P2', text: 'Vascular Limb Injury. Perfusion intact. Needs: Vascular review.', timer: 4, required: ['surgeon'] },
            { id: 'P3-001', category: 'P3', text: 'Minor Lac Arm. Needs: Suture.', timer: 6, required: ['nurse'] },
            { id: 'P3-002', category: 'P3', text: 'Head Injury No LOC. Needs: Obs/Advice.', timer: 6, required: ['nurse'] },
            { id: 'P3-003', category: 'P3', text: 'Ankle Sprain. Needs: X-Ray, splint.', timer: 6, required: ['nurse'] },
            { id: 'CBRN-01', category: 'P1', text: 'Nerve Agent. Pinpoint pupils. Needs: DECON, Atropine.', timer: 1, required: ['decon', 'doctor'] }
        ];

        const EVENTS = [
            { title: "Second Wave Early", effect: "Add 3 patients immediately to Ambulance Bay." },
            { title: "CT Scanner Failure", effect: "CT Capacity 0 for this turn." },
            { title: "Mutual Aid Arrives", effect: "Gain 2 extra Nurse AP this turn." },
            { title: "VIP Visit / Media", effect: "Silver loses 2 AP dealing with press." },
            { title: "Blood Shortage", effect: "MTP costs double AP this turn." }
        ];

        // --- COMPONENTS ---

        const Modal = ({ title, children, onClose, actions }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-slate-800 text-white rounded-t-lg">
                        <h2 className="text-xl font-bold">{title}</h2>
                        <button onClick={onClose} className="text-gray-300 hover:text-white">&times;</button>
                    </div>
                    <div className="p-6">
                        {children}
                    </div>
                    <div className="p-4 border-t border-gray-200 flex justify-end space-x-2 bg-gray-50 rounded-b-lg">
                        {actions}
                    </div>
                </div>
            </div>
        );

        const PatientCard = ({ patient, onSelect, isSelected }) => {
            let colorClass = "";
            if(patient.category === 'P1') colorClass = "p1-bg";
            else if(patient.category === 'P2') colorClass = "p2-bg";
            else if(patient.category === 'P3') colorClass = "p3-bg";
            else colorClass = "dead-bg";

            return (
                <div 
                    onClick={() => onSelect(patient)}
                    className={`p-3 rounded shadow-sm text-sm cursor-pointer border border-gray-200 ${colorClass} ${isSelected ? 'ring-2 ring-blue-500' : ''}`}
                >
                    <div className="flex justify-between font-bold">
                        <span>{patient.id}</span>
                        <span>{patient.category}</span>
                    </div>
                    <p className="mt-1 line-clamp-2 text-gray-700">{patient.text}</p>
                    <div className="mt-2 flex justify-between items-center text-xs text-gray-500">
                        <span>Gate: Turn {patient.timer}</span>
                    </div>
                </div>
            );
        };

        const ZoneDisplay = ({ zone, patients, onPatientSelect, selectedPatientId }) => {
            const zonePatients = patients.filter(p => p.location === zone.id);
            const isFull = zonePatients.length >= zone.capacity;

            return (
                <div className="bg-white rounded-lg shadow p-4 border-t-4 border-slate-600 h-full flex flex-col">
                    <div className="flex justify-between items-center mb-3">
                        <h3 className="font-bold text-gray-800">{zone.name}</h3>
                        <span className={`text-xs px-2 py-1 rounded ${isFull ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                            {zonePatients.length} / {zone.capacity}
                        </span>
                    </div>
                    <div className="flex-1 space-y-2 overflow-y-auto min-h-[100px] max-h-[300px] bg-gray-50 p-2 rounded">
                        {zonePatients.length === 0 ? (
                            <p className="text-center text-gray-400 text-sm italic py-4">Empty</p>
                        ) : (
                            zonePatients.map(p => (
                                <PatientCard 
                                    key={p.uniqueId} 
                                    patient={p} 
                                    onSelect={onPatientSelect}
                                    isSelected={selectedPatientId === p.uniqueId}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const ActionPanel = ({ role, ap, selectedPatient, onMove, onTreat, onEndTurn, allZones }) => {
            if (!role) return <div className="bg-white p-4 rounded shadow text-center text-gray-500">Select a Role to act</div>;

            return (
                <div className="bg-white p-4 rounded-lg shadow border border-blue-200">
                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                        <div>
                            <h2 className="font-bold text-lg text-blue-800">{role.name}</h2>
                            <p className="text-xs text-gray-500">{role.desc}</p>
                        </div>
                        <div className="text-center">
                            <div className="text-2xl font-bold text-blue-600">{ap}</div>
                            <div className="text-xs uppercase tracking-wide">AP Left</div>
                        </div>
                    </div>

                    {!selectedPatient ? (
                        <p className="text-center text-gray-500 py-4">Select a patient on the board to view actions.</p>
                    ) : (
                        <div className="space-y-4">
                            <div className="bg-gray-50 p-3 rounded text-sm">
                                <span className="font-bold block mb-1">Selected: {selectedPatient.id} ({selectedPatient.category})</span>
                                <p>{selectedPatient.text}</p>
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                                <button 
                                    onClick={onTreat}
                                    disabled={ap < 1}
                                    className="bg-green-600 text-white py-2 rounded hover:bg-green-700 disabled:opacity-50 text-sm font-medium"
                                >
                                    Treat / Stabilize (1 AP)
                                </button>
                                <button 
                                    disabled={ap < 1}
                                    className="bg-yellow-600 text-white py-2 rounded hover:bg-yellow-700 disabled:opacity-50 text-sm font-medium"
                                    onClick={() => document.getElementById('moveModal').showModal()} // Simple HTML dialog trigger for simplicity in this view
                                >
                                    Move Patient (1 AP)
                                </button>
                            </div>
                            
                            {/* Move Dialog Logic handled in main component for cleaner code */}
                            <div className="mt-2">
                                <label className="text-xs font-bold text-gray-600 block mb-1">Move to:</label>
                                <select 
                                    className="w-full p-2 border rounded text-sm"
                                    onChange={(e) => onMove(e.target.value)}
                                    value=""
                                >
                                    <option value="" disabled>Select Destination...</option>
                                    {allZones.filter(z => z.id !== selectedPatient.location).map(z => (
                                        <option key={z.id} value={z.id}>{z.name}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const SitrepForm = ({ turn, onSubmit }) => {
            const [methane, setMethane] = useState({ m: true, e: '', t: 'Mass Casualty', h: '', a: '', n: '', e2: '' });
            
            return (
                <div className="space-y-4">
                    <div className="bg-blue-50 p-3 rounded border border-blue-100 text-sm text-blue-800">
                        <strong>Guidance:</strong> As Silver Commander, complete the METHANE report to end the turn.
                    </div>
                    <div className="grid grid-cols-1 gap-3">
                        <label className="block"><span className="text-gray-700 font-bold">M</span>ajor Incident Declared? <input type="checkbox" checked={methane.m} readOnly /></label>
                        <label className="block"><span className="text-gray-700 font-bold">E</span>xact Location <input type="text" className="w-full border p-1 rounded" placeholder="Hospital ED..." /></label>
                        <label className="block"><span className="text-gray-700 font-bold">T</span>ype of Incident <input type="text" className="w-full border p-1 rounded" defaultValue="Mass Casualty Surge" /></label>
                        <label className="block"><span className="text-gray-700 font-bold">H</span>azards <input type="text" className="w-full border p-1 rounded" placeholder="CBRN, congestion..." /></label>
                        <label className="block"><span className="text-gray-700 font-bold">A</span>ccess <input type="text" className="w-full border p-1 rounded" placeholder="Routes clear?" /></label>
                        <label className="block"><span className="text-gray-700 font-bold">N</span>umber of Casualties <input type="number" className="w-full border p-1 rounded" placeholder="Approx count" /></label>
                        <label className="block"><span className="text-gray-700 font-bold">E</span>mergency Services <input type="text" className="w-full border p-1 rounded" placeholder="Police, Fire, Amb on scene" /></label>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        const App = () => {
            // State
            const [turn, setTurn] = useState(1);
            const [phase, setPhase] = useState(0); // 0=Receipt, 1=Definitive, 2=Recovery
            const [patients, setPatients] = useState([]);
            const [roleStates, setRoleStates] = useState(ROLES.map(r => ({ ...r, currentAp: r.ap })));
            const [currentRoleId, setCurrentRoleId] = useState(ROLES[1].id); // Default to Bronze
            const [selectedPatientId, setSelectedPatientId] = useState(null);
            const [eventLog, setEventLog] = useState(["Game Started. Major Incident Declared."]);
            const [showSitrep, setShowSitrep] = useState(false);
            const [showEventModal, setShowEventModal] = useState(false);
            const [currentEvent, setCurrentEvent] = useState(null);

            // Helpers
            const currentRole = roleStates.find(r => r.id === currentRoleId);
            const selectedPatient = patients.find(p => p.uniqueId === selectedPatientId);

            // Game Loop Functions
            const addLog = (msg) => setEventLog(prev => [`[Turn ${turn}] ${msg}`, ...prev]);

            const spawnPatients = (count) => {
                const newPatients = [];
                for(let i=0; i<count; i++) {
                    const template = PATIENT_DECK[Math.floor(Math.random() * PATIENT_DECK.length)];
                    newPatients.push({
                        ...template,
                        uniqueId: Date.now() + i,
                        location: 'amb',
                        status: 'untriaged',
                        treated: false
                    });
                }
                setPatients(prev => [...prev, ...newPatients]);
                addLog(`${count} new casualties arrived at Ambulance Bay.`);
            };

            // Initial Setup
            useEffect(() => {
                spawnPatients(5); // Initial wave
            }, []);

            // Actions
            const handleRoleChange = (roleId) => {
                setCurrentRoleId(roleId);
                setSelectedPatientId(null);
            };

            const handleMove = (targetZoneId) => {
                if (!selectedPatient || currentRole.currentAp < 1) return;
                
                const targetZone = ZONES.find(z => z.id === targetZoneId);
                const patientsInTarget = patients.filter(p => p.location === targetZoneId).length;

                if (patientsInTarget >= targetZone.capacity) {
                    alert(`${targetZone.name} is full!`);
                    return;
                }

                // AP Cost
                setRoleStates(prev => prev.map(r => r.id === currentRoleId ? { ...r, currentAp: r.currentAp - 1 } : r));
                
                // Update Patient
                setPatients(prev => prev.map(p => p.uniqueId === selectedPatient.uniqueId ? { ...p, location: targetZoneId } : p));
                
                addLog(`${currentRole.name} moved ${selectedPatient.id} to ${targetZone.name}.`);
                
                // Auto Triage check
                if (targetZoneId === 'triage' && selectedPatient.status === 'untriaged') {
                    // Simulating TST/MITT application simply by moving to triage zone
                    addLog(`MITT Applied to ${selectedPatient.id}: Confirmed ${selectedPatient.category}.`);
                }
            };

            const handleTreat = () => {
                if (!selectedPatient || currentRole.currentAp < 1) return;

                // AP Cost
                setRoleStates(prev => prev.map(r => r.id === currentRoleId ? { ...r, currentAp: r.currentAp - 1 } : r));

                setPatients(prev => prev.map(p => p.uniqueId === selectedPatient.uniqueId ? { ...p, treated: true } : p));
                addLog(`${currentRole.name} treated/stabilized ${selectedPatient.id}.`);
            };

            const nextTurn = () => {
                setShowSitrep(true);
            };

            const confirmNextTurn = () => {
                setShowSitrep(false);
                const newTurn = turn + 1;
                setTurn(newTurn);
                
                // Reset AP
                setRoleStates(prev => prev.map(r => ({ ...r, currentAp: r.ap })));

                // Update Phase
                if (newTurn > 4) setPhase(1);
                if (newTurn > 8) setPhase(2);

                // Random Event
                if (Math.random() > 0.5) {
                    const evt = EVENTS[Math.floor(Math.random() * EVENTS.length)];
                    setCurrentEvent(evt);
                    setShowEventModal(true);
                    addLog(`EVENT: ${evt.title}`);
                }

                // New Arrivals
                const arrivals = Math.floor(Math.random() * 4) + 1;
                spawnPatients(arrivals);
            };

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="bg-slate-900 text-white p-4 shadow-md">
                        <div className="container mx-auto flex justify-between items-center">
                            <div className="flex items-center space-x-4">
                                <h1 className="text-xl font-bold tracking-tight">INCIDENT Command <span className="text-red-500 text-sm font-normal">UK Edition</span></h1>
                                <span className="bg-slate-700 px-3 py-1 rounded text-sm">Turn: {turn}/12</span>
                                <span className="bg-slate-700 px-3 py-1 rounded text-sm">Phase: {PHASES[phase]}</span>
                            </div>
                            <div className="flex space-x-4 text-sm">
                                <div>P1: {patients.filter(p => p.category === 'P1' && p.location !== 'discharged').length}</div>
                                <div>P2: {patients.filter(p => p.category === 'P2' && p.location !== 'discharged').length}</div>
                                <button onClick={nextTurn} className="bg-blue-600 hover:bg-blue-500 px-4 py-1 rounded font-bold">End Turn (SITREP)</button>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 container mx-auto p-4 flex gap-4 overflow-hidden h-screen">
                        
                        {/* Left Sidebar: Roles & Actions */}
                        <div className="w-1/4 flex flex-col gap-4 overflow-y-auto">
                            {/* Role Selector */}
                            <div className="bg-white p-4 rounded-lg shadow">
                                <h3 className="font-bold text-gray-700 mb-2">Active Role</h3>
                                <div className="grid grid-cols-1 gap-2">
                                    {roleStates.map(role => (
                                        <button
                                            key={role.id}
                                            onClick={() => handleRoleChange(role.id)}
                                            className={`text-left px-3 py-2 rounded flex justify-between items-center ${currentRoleId === role.id ? 'bg-blue-100 text-blue-800 border-blue-300 border' : 'hover:bg-gray-100'}`}
                                        >
                                            <span className="text-sm font-medium">{role.name}</span>
                                            <span className={`text-xs font-bold px-2 py-0.5 rounded ${role.currentAp === 0 ? 'bg-red-100 text-red-600' : 'bg-gray-200'}`}>AP: {role.currentAp}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Action Panel */}
                            <ActionPanel 
                                role={currentRole} 
                                ap={currentRole?.currentAp}
                                selectedPatient={selectedPatient}
                                onMove={handleMove}
                                onTreat={handleTreat}
                                allZones={ZONES}
                            />

                            {/* Log */}
                            <div className="bg-white p-4 rounded-lg shadow flex-1 min-h-[200px]">
                                <h3 className="font-bold text-gray-700 mb-2">Incident Log</h3>
                                <div className="text-xs space-y-1 h-full overflow-y-auto max-h-[300px] pr-2">
                                    {eventLog.map((log, i) => (
                                        <div key={i} className="border-b border-gray-100 pb-1 text-gray-600">{log}</div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Main Board Area */}
                        <div className="w-3/4 grid grid-cols-3 gap-4 auto-rows-min overflow-y-auto pb-20">
                            {ZONES.map(zone => (
                                <div key={zone.id} className={`
                                    ${zone.id === 'resus' || zone.id === 'theatre' ? 'col-span-2' : 'col-span-1'}
                                    ${zone.id === 'ward' ? 'col-span-3' : ''}
                                `}>
                                    <ZoneDisplay 
                                        zone={zone} 
                                        patients={patients} 
                                        onPatientSelect={(p) => setSelectedPatientId(p.uniqueId)}
                                        selectedPatientId={selectedPatientId}
                                    />
                                </div>
                            ))}
                        </div>
                    </main>

                    {/* Modals */}
                    {showSitrep && (
                        <Modal title={`Turn ${turn} SITREP Required`} onClose={() => {}} 
                            actions={<button onClick={confirmNextTurn} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Submit & Start Next Turn</button>}>
                            <SitrepForm turn={turn} />
                        </Modal>
                    )}

                    {showEventModal && currentEvent && (
                        <Modal title="INCIDENT UPDATE" onClose={() => setShowEventModal(false)}
                            actions={<button onClick={() => setShowEventModal(false)} className="bg-red-600 text-white px-4 py-2 rounded">Acknowledge</button>}>
                            <div className="text-center">
                                <h3 className="text-xl font-bold text-red-600 mb-2">{currentEvent.title}</h3>
                                <p className="text-gray-800">{currentEvent.effect}</p>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
