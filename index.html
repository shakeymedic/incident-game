<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMEBEM Incident Command</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; user-select: none; overflow: hidden; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        /* Zone Styling */
        .zone-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .zone-card.dimmed { opacity: 0.4; filter: grayscale(0.8); }
        .zone-card:active { transform: scale(0.98); background-color: #f8fafc; }
        .zone-card.drag-over { background-color: #f0f9ff; border-color: #0284c7; box-shadow: 0 0 0 4px #0284c7 inset; }
        
        /* Patient Colours */
        .p1-bg { background-color: #fee2e2; border-left: 5px solid #dc2626; } 
        .p2-bg { background-color: #fef3c7; border-left: 5px solid #d97706; } 
        .p3-bg { background-color: #d1fae5; border-left: 5px solid #059669; } 
        .dead-bg { background-color: #e2e8f0; border-left: 5px solid #1e293b; }
        .neutral-bg { background-color: #f1f5f9; border-left: 5px solid #94a3b8; } 
        
        /* Tutorial Highlight */
        .tutorial-highlight { 
            box-shadow: 0 0 0 4px #facc15, 0 0 20px #facc15; 
            z-index: 50; 
            position: relative;
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0px rgba(250, 204, 21, 0.7); }
            100% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); }
        }

        /* Animations */
        .hud-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .vital-red { color: #dc2626; font-weight: 900; animation: pulse 2s infinite; }
        .vital-amber { color: #d97706; font-weight: bold; }
        .vital-normal { color: #059669; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Mobile Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        
        .logo-h { height: 2rem; width: auto; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- AUDIO MANAGER ---
        let audioCtx = null;
        const getAudioCtx = () => {
            if (!audioCtx && (window.AudioContext || window.webkitAudioContext)) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioCtx;
        };
        const initAudio = () => {
             const ctx = getAudioCtx();
             if (ctx && ctx.state === 'suspended') { ctx.resume(); }
        };
        const playSound = (type) => {
            try {
                const ctx = getAudioCtx();
                if (!ctx) return;
                if (ctx.state === 'suspended') ctx.resume().catch(() => {});
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;
                if (type === 'ping') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.5);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'treat') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(880, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1);
                    const osc2 = ctx.createOscillator(); const gain2 = ctx.createGain(); osc2.connect(gain2); gain2.connect(ctx.destination);
                    osc2.type = 'triangle'; osc2.frequency.setValueAtTime(880, now + 0.15); gain2.gain.setValueAtTime(0.1, now + 0.15); gain2.gain.linearRampToValueAtTime(0, now + 0.25); osc2.start(now + 0.15); osc2.stop(now + 0.25);
                } else if (type === 'flatline') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); gain.gain.setValueAtTime(0.15, now); gain.gain.linearRampToValueAtTime(0, now + 2.5); osc.start(now); osc.stop(now + 2.5);
                } else if (type === 'move') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(300, now); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.05); osc.start(now); osc.stop(now + 0.05);
                } else if (type === 'alert') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.linearRampToValueAtTime(880, now + 0.3); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3); osc.start(now); osc.stop(now + 0.3);
                }
            } catch (e) { }
        };

        // --- ICONS ---
        const IconWrapper = ({ children, size = 20, strokeWidth = 2, className = "", ...props }) => ( <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg> );
        const ClipboardCheck = (p) => <IconWrapper {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></IconWrapper>;
        const Scan = (p) => <IconWrapper {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></IconWrapper>;
        const Stethoscope = (p) => <IconWrapper {...p}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v6"/><path d="M16 15v6a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-6"/><circle cx="12" cy="20" r="2"/></IconWrapper>;
        const DoorOpen = (p) => <IconWrapper {...p}><path d="M13 4h3a2 2 0 0 1 2 2v14"/><path d="M2 20h3"/><path d="M13 20h9"/><path d="M10 12v.01"/><path d="M13 4.562v16.157a1 1 0 0 1-1.242.97L5 20V5.562a2 2 0 0 1 1.515-1.94l4-1A2 2 0 0 1 13 4.561Z"/></IconWrapper>;
        const Check = (p) => <IconWrapper {...p}><path d="M20 6 9 17l-5-5"/></IconWrapper>;
        const CheckCircle = (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></IconWrapper>;
        const ShieldAlert = (p) => <IconWrapper {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></IconWrapper>;
        const X = (p) => <IconWrapper {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const Users = (p) => <IconWrapper {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>;
        const Droplet = (p) => <IconWrapper {...p}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></IconWrapper>;
        const Wind = (p) => <IconWrapper {...p}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></IconWrapper>;
        const Syringe = (p) => <IconWrapper {...p}><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/><path d="m9 11 4 4"/><path d="m5 19-3 3"/></IconWrapper>;
        const Activity = (p) => <IconWrapper {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
        const Bed = (p) => <IconWrapper {...p}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></IconWrapper>;
        const BookOpen = (p) => <IconWrapper {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>;
        const BadgeInfo = (p) => <IconWrapper {...p}><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.78 4.78 4 4 0 0 1-6.74 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z"/><line x1="12" x2="12" y1="8" y2="8"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>;
        const FileText = (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconWrapper>;
        const Menu = (p) => <IconWrapper {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconWrapper>;
        const Minus = (p) => <IconWrapper {...p}><path d="M5 12h14"/></IconWrapper>;
        const Plus = (p) => <IconWrapper {...p}><path d="M12 5v14"/><path d="M5 12h14"/></IconWrapper>;
        const RotateCcw = (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>;
        const AlertTriangle = (p) => <IconWrapper {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>;
        const Volume2 = (p) => <IconWrapper {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></IconWrapper>;
        const VolumeX = (p) => <IconWrapper {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></IconWrapper>;
        const Lightbulb = (p) => <IconWrapper {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconWrapper>;

        // --- CONSTANTS ---
        const LOGO_URL = "https://iili.io/KGQOvkl.md.png";
        
        // --- EVENTS ---
        const RANDOM_EVENTS = [
            { id: 'needlestick', title: 'Needlestick Injury', desc: 'A Nurse has sustained a needlestick injury and must report to Occ Health.', effect: 'One Nurse removed for 1 turn.' },
            { id: 'ct_overheat', title: 'Scanner Overheat', desc: 'The CT Scanner cooling system has failed.', effect: 'CT Scanner disabled for this turn.' },
            { id: 'norovirus', title: 'Norovirus Outbreak', desc: 'Ward 4 closed due to D&V.', effect: 'Ward Capacity reduced by 5.' },
            { id: 'med_student', title: 'Keen Med Student', desc: 'A final year student offers to help with bloods.', effect: 'Senior Doctor gains +2 AP.' },
            { id: 'rapid_offload', title: 'Rapid Offload', desc: 'Multiple ambulances arrive at once.', effect: '3 Extra Patients added to Ambulance Bay.' },
            { id: 'it_failure', title: 'IT Systems Failure', desc: 'EPR is down. We are on paper.', effect: 'Triage costs 2 AP this turn.' }
        ];

        const SCENARIOS = {
            standard: { name: "Standard Incident", desc: "A major incident has been declared. Balanced mix of trauma and medical casualties.", p1: 0.2, p2: 0.3, p3: 0.5 },
            chemical: { name: "Chemical Attack", desc: "CBRN incident. High number of airway risks (P1) requiring advanced skills.", p1: 0.5, p2: 0.3, p3: 0.2, type: 'chem' },
            bus_crash: { name: "Bus Crash", desc: "Multi-vehicle collision. High volume of blunt trauma (Head/Chest/Abdo).", p1: 0.3, p2: 0.4, p3: 0.3, type: 'trauma' },
            collapse: { name: "Structural Collapse", desc: "Building collapse. Crush injuries and dust inhalation.", p1: 0.25, p2: 0.4, p3: 0.35, type: 'crush' }
        };

        // Role Templates
        const ROLE_TEMPLATES = {
            bronze_cmd: { type: 'command', theme: 'slate', icon: Activity, name: 'Bronze Commander', ap: 4, desc: 'Operational Lead', ability: 'Emergency Resupply', abilityCost: 2, abilityEffect: '+2 Blood / +1 Vent', actionText: 'Review', canTriage: true, skills: ['triage', 'care'] },
            senior_doc: { type: 'command', theme: 'slate', icon: ClipboardCheck, name: 'Senior Doctor', ap: 5, desc: 'Clinical Lead', ability: 'Rapid Triage', abilityCost: 2, abilityEffect: 'Reveal All Intake', actionText: 'Review', canTriage: true, canTreat: true, skills: ['advanced_trauma', 'care', 'triage'] },
            nurse_ic: { type: 'nursing', theme: 'blue', icon: Users, name: 'Nurse in Charge', ap: 4, desc: 'Coordination', ability: 'Team Huddle', abilityCost: 1, abilityEffect: 'Reveal Triage', actionText: 'Coordinate', skills: ['triage', 'care'] },
            nurse_staff: { type: 'nursing', theme: 'blue', icon: Syringe, name: 'ED Nurse', ap: 4, desc: 'Care & Triage', ability: 'Stream to Minors', abilityCost: 1, abilityEffect: 'Move P3 Free', actionText: 'Care / Triage', canTriage: true, canTreat: true, skills: ['care', 'triage'] },
            resident: { type: 'medical', theme: 'emerald', icon: Stethoscope, name: 'ED Resident', ap: 4, desc: 'Treatment', ability: 'Fast Track', abilityCost: 2, abilityEffect: 'Instant Treat P3', actionText: 'Procedure', canTreat: true, skills: ['advanced_trauma', 'care', 'triage'] },
            radiology: { type: 'support', theme: 'purple', icon: Scan, name: 'Radiology Lead', ap: 3, desc: 'Diagnostics', ability: 'Rapid Scan', abilityCost: 1, abilityEffect: 'Move to CT Free', actionText: 'Scan', canScan: true, skills: [] },
            bed_manager: { type: 'logistics', theme: 'amber', icon: Bed, name: 'Bed Manager', ap: 3, desc: 'Flow', ability: 'Force Discharge', abilityCost: 1, abilityEffect: 'Clear Ward Bed', actionText: 'Breach', skills: [] }
        };

        const generateRoster = (counts) => {
            const roles = [];
            roles.push({ id: 'bronze_cmd', ...ROLE_TEMPLATES.bronze_cmd });
            roles.push({ id: 'nurse_ic', ...ROLE_TEMPLATES.nurse_ic });
            roles.push({ id: 'radiology', ...ROLE_TEMPLATES.radiology });
            roles.push({ id: 'bed_manager', ...ROLE_TEMPLATES.bed_manager });
            for (let i = 0; i < counts.senior; i++) roles.push({ id: `senior_doc_${i}`, ...ROLE_TEMPLATES.senior_doc, name: counts.senior > 1 ? `Senior Doctor ${i+1}` : 'Senior Doctor' });
            for (let i = 0; i < counts.resident; i++) roles.push({ id: `resident_${i}`, ...ROLE_TEMPLATES.resident, name: counts.resident > 1 ? `ED Resident ${i+1}` : 'ED Resident' });
            for (let i = 0; i < counts.nurse; i++) roles.push({ id: `nurse_staff_${i}`, ...ROLE_TEMPLATES.nurse_staff, name: counts.nurse > 1 ? `ED Nurse ${i+1}` : 'ED Nurse' });
            return roles;
        };

        const ZONES = [
            { id: 'amb', name: 'Ambulance Bay', capacity: 12, type: 'intake' },
            { id: 'triage', name: 'Triage', capacity: 10, type: 'process' },
            { id: 'resus', name: 'Resus (P1)', capacity: 4, type: 'clinical' },
            { id: 'majors', name: 'Majors (P2)', capacity: 10, type: 'clinical' },
            { id: 'ct', name: 'CT Scan', capacity: 1, type: 'diagnostic' },
            { id: 'minors', name: 'Minors (P3)', capacity: 15, type: 'clinical' },
            { id: 'icu', name: 'ICU/HDU', capacity: 6, type: 'ward' },
            { id: 'ward', name: 'Wards', capacity: 30, type: 'ward' },
            { id: 'theatre', name: 'Theatres', capacity: 2, type: 'treatment' },
            { id: 'discharged', name: 'Home', capacity: 999, type: 'exit' },
            { id: 'morgue', name: 'Mortuary', capacity: 999, type: 'exit' }
        ];

        const getPatientNeeds = (p) => {
            const needs = [];
            if (!p.triaged) needs.push({ id: 'triage', label: 'Triage', icon: ClipboardCheck, color: 'text-slate-600', bg: 'bg-slate-100', borderColor: 'border-slate-300' });
            if (p.triaged && !p.treated) {
                const needsScan = (p.injuryLoc === 'head' || p.injuryLoc === 'abdo') && !p.scanned;
                if (needsScan) needs.push({ id: 'scan', label: 'CT Scan', icon: Scan, color: 'text-purple-600', bg: 'bg-purple-100', borderColor: 'border-purple-300' });
                if (!needsScan) {
                    const label = p.reqSkill === 'advanced_trauma' ? 'Needs Doctor' : 'Treatment';
                    needs.push({ id: 'treat', label: label, icon: Stethoscope, color: 'text-emerald-600', bg: 'bg-emerald-100', borderColor: 'border-emerald-300', reqSkill: p.reqSkill });
                }
            }
            if (p.treated && !['discharged','ward','icu','morgue'].includes(p.location)) {
                needs.push({ id: 'move', label: 'Admit/Discharge', icon: DoorOpen, color: 'text-amber-600', bg: 'bg-amber-100', borderColor: 'border-amber-300' });
            }
            return needs;
        };

        const getColorStyle = (theme) => ({
            slate: 'border-slate-500 hover:bg-slate-50 text-slate-800',
            blue: 'border-blue-500 hover:bg-blue-50 text-blue-800',
            emerald: 'border-emerald-500 hover:bg-emerald-50 text-emerald-800',
            purple: 'border-purple-500 hover:bg-purple-50 text-purple-800',
            amber: 'border-amber-500 hover:bg-amber-50 text-amber-800'
        }[theme] || 'border-gray-500');

        const getActiveStyle = (theme) => ({
            slate: 'bg-slate-800 text-white border-slate-800',
            blue: 'bg-blue-700 text-white border-blue-700',
            emerald: 'bg-emerald-700 text-white border-emerald-700',
            purple: 'bg-purple-700 text-white border-purple-700',
            amber: 'bg-amber-700 text-white border-amber-700'
        }[theme] || 'bg-gray-800');

        // --- SUB COMPONENTS ---

        const RoleKey = () => {
            const uniqueRoles = Object.values(ROLE_TEMPLATES);
            return (
                <div className="space-y-2">
                    {uniqueRoles.map(role => {
                        const RoleIcon = role.icon;
                        return (
                            <div key={role.name} className={`flex items-start gap-3 p-3 rounded border ${getColorStyle(role.theme)} bg-white`}>
                                <div className={`p-2 rounded bg-${role.theme}-100 text-${role.theme}-700 shrink-0`}><RoleIcon size={20} /></div>
                                <div className="flex-1">
                                    <div className="flex justify-between items-center mb-1"><h4 className="font-bold text-sm">{role.name}</h4><span className="text-[10px] font-bold uppercase tracking-wider bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">{role.type}</span></div>
                                    <p className="text-xs text-gray-600 mb-2">{role.desc}</p>
                                    <div className="grid grid-cols-2 gap-2 text-[10px]"><div className="bg-gray-50 p-1.5 rounded border"><span className="font-bold block text-gray-500">Primary Action</span>{role.actionText}</div><div className="bg-gray-50 p-1.5 rounded border"><span className="font-bold block text-gray-500">Special Ability ({role.abilityCost} AP)</span>{role.ability}: {role.abilityEffect}</div></div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const Counter = ({ label, value, onChange, min, max }) => (
            <div className="flex justify-between items-center bg-slate-50 p-3 rounded border border-slate-200"><span className="text-sm font-bold text-slate-700">{label}</span><div className="flex items-center gap-3"><button type="button" onClick={() => onChange(Math.max(min, value - 1))} disabled={value <= min} className="w-8 h-8 rounded bg-white border flex items-center justify-center hover:bg-slate-100 disabled:opacity-50 text-slate-600 cursor-pointer"><Minus size={16}/></button><span className="w-6 text-center font-bold">{value}</span><button type="button" onClick={() => onChange(Math.min(max, value + 1))} disabled={value >= max} className="w-8 h-8 rounded bg-white border flex items-center justify-center hover:bg-slate-100 disabled:opacity-50 text-slate-600 cursor-pointer"><Plus size={16}/></button></div></div>
        );
        
        const TutorialOverlay = ({ step, children }) => (
             <div className="fixed inset-0 pointer-events-none z-[60] flex items-center justify-center bg-black/20">
                 <div className="bg-white p-6 rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.5)] max-w-md text-center border-4 border-yellow-400 pointer-events-auto animate-bounce transform -translate-y-12">
                     <div className="flex items-center justify-center gap-2 mb-2 text-yellow-600 font-black uppercase tracking-wide text-sm"><Lightbulb size={20} /> Tutorial Step {step}/9</div>
                     <div className="text-slate-900 font-bold text-lg leading-tight">{children}</div>
                 </div>
             </div>
        );

        const UserGuide = () => (
            <div className="space-y-6">
                <section>
                    <h4 className="font-bold text-blue-800 text-base mb-2 border-b pb-1">1. Core Gameplay Loop</h4>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-xs">
                        <div className="bg-slate-50 p-3 rounded border"><strong className="block mb-1">Turn-Based Action</strong>Each staff member has Action Points (AP). Drag (or tap) patients to move them (1 AP) or click actions in the HUD (1 AP). AP resets every turn.</div>
                        <div className="bg-slate-50 p-3 rounded border"><strong className="block mb-1">Winning & Losing</strong><span className="text-emerald-700 font-bold">WIN:</span> Discharge stable patients home.<br/><span className="text-red-600 font-bold">LOSE:</span> P1 patients die if left untreated for >1 turn. Ambulance bay overflow ends the game.</div>
                    </div>
                </section>
                <section>
                    <h4 className="font-bold text-blue-800 text-base mb-2 border-b pb-1">2. Mobile Controls</h4>
                    <p className="text-xs mb-2">If you are on a phone or tablet, you can <strong>Tap a Patient</strong> to select them, then <strong>Tap a Zone</strong> to move them there. Drag and drop also works on desktop.</p>
                </section>
                <section>
                    <h4 className="font-bold text-blue-800 text-base mb-2 border-b pb-1">3. Patient Care Pathway</h4>
                    <ol className="list-decimal pl-5 space-y-2 text-xs">
                        <li><strong>Triage:</strong> Use a Nurse or Commander to reveal patient category (P1/P2/P3).</li>
                        <li><strong>Diagnostics (Purple):</strong> Head/Abdo injuries often need a CT Scan. Move to CT Zone -> Use Radiologist to Scan. Treatment is blocked until scanned!</li>
                        <li><strong>Treatment (Green/Blue):</strong> Move to Resus/Majors. Use Doctor/Nurse to treat. P1s consume Blood.</li>
                        <li><strong>Disposition:</strong> Move stable patients to Wards/ICU/Home.</li>
                    </ol>
                </section>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [gameState, setGameState] = useState('start');
            const [playerCount, setPlayerCount] = useState(1);
            const [staffCounts, setStaffCounts] = useState({ senior: 1, resident: 2, nurse: 3 });
            const [isPrefilled, setIsPrefilled] = useState(false);
            const [isActiveTriageMode, setIsActiveTriageMode] = useState(false); // New Active Triage state
            const [triageTarget, setTriageTarget] = useState(null); // Patient pending active triage
            const [turn, setTurn] = useState(1);
            const [score, setScore] = useState(100);
            const [deaths, setDeaths] = useState(0);
            const [discharged, setDischarged] = useState(0);
            const [roleStates, setRoleStates] = useState([]);
            const [currentRoleId, setCurrentRoleId] = useState(null);
            const [patients, setPatients] = useState([]);
            const [resources, setResources] = useState({ blood: 20, vents: 8 });
            const [simTime, setSimTime] = useState(12 * 60);
            const [selectedPatientId, setSelectedPatientId] = useState(null);
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [modalContent, setModalContent] = useState(null);
            const [activeEvent, setActiveEvent] = useState(null);
            const [historyStack, setHistoryStack] = useState([]);
            const [selectedScenario, setSelectedScenario] = useState('standard');
            const [isMuted, setIsMuted] = useState(false);
            const [tutorialStep, setTutorialStep] = useState(0); // 0 = inactive

            // Audio wrapper using state
            const playAudio = (type) => { if (!isMuted) playSound(type); };
            const formatTime = (mins) => { const h = Math.floor(mins/60); const m = mins%60; return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; };
            const currentRole = roleStates.find(r => r.id === currentRoleId);
            const selectedPatient = patients.find(p => p.uniqueId === selectedPatientId);

            // Load Save
            useEffect(() => {
                const saved = localStorage.getItem('wmebem_save');
                if (saved) { try { JSON.parse(saved); } catch(e) { console.error("Save load error", e); } }
            }, []);

            const saveGame = () => {
                const data = { gameState, playerCount, staffCounts, turn, score, deaths, discharged, roleStates, currentRoleId, patients, resources, simTime, selectedScenario, isMuted };
                localStorage.setItem('wmebem_save', JSON.stringify(data));
            };

            const loadGame = () => {
                const saved = localStorage.getItem('wmebem_save');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        setGameState(data.gameState); setPlayerCount(data.playerCount); setStaffCounts(data.staffCounts); setTurn(data.turn);
                        setScore(data.score); setDeaths(data.deaths); setDischarged(data.discharged); setRoleStates(data.roleStates);
                        setCurrentRoleId(data.currentRoleId); setPatients(data.patients); setResources(data.resources); setSimTime(data.simTime);
                        if(data.selectedScenario) setSelectedScenario(data.selectedScenario);
                        if(data.isMuted !== undefined) setIsMuted(data.isMuted);
                    } catch(e) { console.error("Load error", e); }
                }
            };

            useEffect(() => { if (gameState === 'playing') saveGame(); }, [turn, patients, roleStates, score]);

            // Tutorial Logic Hook
            useEffect(() => {
                if (tutorialStep === 0) return;
                
                // Step 1: Select Nurse IC (handled in render)
                if (tutorialStep === 1 && currentRole?.id === 'nurse_ic') setTutorialStep(2);
                // Step 2: Select Patient (handled in render)
                if (tutorialStep === 2 && selectedPatientId) setTutorialStep(3);
                // Step 3: Move to Triage (handled in handleDrop)
                // Step 4: Action Triage (handled in handleAction)
                // Step 5: Move to Minors (handled in handleDrop)
                // Step 6: Select Nurse (handled in render)
                if (tutorialStep === 6 && currentRole?.id?.startsWith('nurse_staff')) setTutorialStep(7);
                // Step 7: Action Treat (handled in handleAction)
                // Step 8: Move Home (handled in handleDrop)
                if (tutorialStep === 9) {
                    setTimeout(() => {
                        alert("Tutorial Complete! You are ready to command.");
                        setTutorialStep(0);
                    }, 1000);
                }
            }, [currentRole, selectedPatientId, patients, tutorialStep]);


            const pushHistory = () => {
                const snapshot = JSON.stringify({ roleStates, patients, resources, score, deaths, discharged, simTime, turn, activeEvent });
                setHistoryStack(prev => [...prev.slice(-9), snapshot]);
            };

            const handleUndo = () => {
                if (historyStack.length === 0) return;
                try {
                    const prev = JSON.parse(historyStack[historyStack.length - 1]);
                    setRoleStates(prev.roleStates); setPatients(prev.patients); setResources(prev.resources);
                    setScore(prev.score); setDeaths(prev.deaths); setDischarged(prev.discharged);
                    setSimTime(prev.simTime); setTurn(prev.turn); setActiveEvent(prev.activeEvent);
                    setHistoryStack(prev => prev.slice(0, -1));
                    setSelectedPatientId(null);
                } catch(e) { console.error("Undo error", e); }
            };

            // Triage Handlers
            const performTriage = (patient, isCorrect, isManual) => {
                const triageCost = activeEvent?.id === 'it_failure' ? 2 : 1;
                if (currentRole.currentAp < triageCost) return;
                
                let logMsg = `Triaged (${currentRole.name})`;
                if (isManual) {
                    if (isCorrect) {
                         setScore(s => s + 5); // Bonus
                         logMsg += " - Correctly Identified";
                    } else {
                         setScore(s => s - 5); // Penalty
                         logMsg += ` - Incorrect (True: ${patient.category})`;
                    }
                }

                setPatients(prev => prev.map(p => p.uniqueId === patient.uniqueId ? addHistory({ ...p, triaged: true }, logMsg) : p));
                setRoleStates(prev => prev.map(r => r.id === currentRoleId ? { ...r, currentAp: r.currentAp - triageCost } : r));
                
                if(tutorialStep === 4) setTutorialStep(5);
            };

            const handleTriageConfirm = (selectedCategory) => {
                if (!triageTarget) return;
                const isCorrect = selectedCategory === triageTarget.category;
                performTriage(triageTarget, isCorrect, true);
                setTriageTarget(null);
            };

            // --- GAME LOGIC --- (Standard spawns/action handlers from previous steps)

            const NAMES = ["Smith", "Jones", "Taylor", "Brown", "Williams", "Wilson", "Johnson", "Davies"];
            const MALE = ["James", "John", "Robert", "Michael"]; const FEMALE = ["Mary", "Patricia", "Jennifer", "Linda"];
            const PATIENT_TEMPLATES = {
                standard: [
                    { category: 'P1', injuryLoc: 'chest', text: 'GSW Chest. Needs Thoracotomy.', reqSkill: 'advanced_trauma', treatmentAction: 'Thoracotomy & Chest Drain', vitals: { hr: 140, sbp: 70, rr: 32, spo2: 88 } },
                    { category: 'P1', injuryLoc: 'abdo', text: 'Blast Abdomen. Rigid.', reqSkill: 'advanced_trauma', treatmentAction: 'TXA & Haemostatics', vitals: { hr: 130, sbp: 85, rr: 24, spo2: 94 } },
                    { category: 'P2', injuryLoc: 'head', text: 'TBI. Asymmetric pupils.', reqSkill: 'advanced_trauma', treatmentAction: 'RSI & Neuroprotection', vitals: { hr: 60, sbp: 160, rr: 12, spo2: 96 } },
                    { category: 'P2', injuryLoc: 'leg', text: 'Femur Fracture (Open).', reqSkill: 'advanced_trauma', treatmentAction: 'Splint, Dress & Antibiotics', vitals: { hr: 110, sbp: 110, rr: 20, spo2: 98 } },
                    { category: 'P3', injuryLoc: 'arm', text: 'Deep Laceration.', reqSkill: 'care', treatmentAction: 'Suture & Dress', vitals: { hr: 80, sbp: 120, rr: 14, spo2: 99 } },
                    { category: 'P3', injuryLoc: 'head', text: 'Mild Concussion.', reqSkill: 'care', treatmentAction: 'Neuro Obs & Analgesia', vitals: { hr: 76, sbp: 118, rr: 14, spo2: 100 } },
                ],
                chem: [
                    { category: 'P1', injuryLoc: 'head', text: 'Nerve Agent. Pinpoint pupils.', reqSkill: 'advanced_trauma', treatmentAction: 'Atropine & Oxime', vitals: { hr: 45, sbp: 90, rr: 30, spo2: 85 } },
                    { category: 'P1', injuryLoc: 'chest', text: 'Chlorine Gas Inhalation.', reqSkill: 'advanced_trauma', treatmentAction: 'Nebulisers & Oxygen', vitals: { hr: 120, sbp: 100, rr: 40, spo2: 82 } },
                ],
                crush: [
                    { category: 'P1', injuryLoc: 'leg', text: 'Crush Injury. Compartment Syndrome.', reqSkill: 'advanced_trauma', treatmentAction: 'Fluids & Bicarb', vitals: { hr: 110, sbp: 100, rr: 20, spo2: 96 } },
                    { category: 'P2', injuryLoc: 'chest', text: 'Dust Inhalation. Wheezy.', reqSkill: 'care', treatmentAction: 'Nebulisers & Steroids', vitals: { hr: 90, sbp: 120, rr: 24, spo2: 92 } },
                ],
                // Tutorial specific
                tutorial: [
                    { category: 'P3', injuryLoc: 'arm', text: 'Deep Laceration.', reqSkill: 'care', treatmentAction: 'Suture & Dress', vitals: { hr: 80, sbp: 120, rr: 14, spo2: 99 } }
                ]
            };

            const addHistory = (patient, msg) => ({ ...patient, history: [{ time: formatTime(simTime), msg }, ...(patient.history || [])] });

            // Helper to create a single patient
            const createPatient = (template, timeStr, overrideProps = {}) => {
                const isMale = Math.random() > 0.5;
                const gender = isMale ? 'M' : 'F';
                const name = `${(isMale ? MALE : FEMALE)[Math.floor(Math.random() * 4)]} ${NAMES[Math.floor(Math.random() * NAMES.length)]}`;
                return {
                    ...template,
                    name,
                    age: Math.floor(Math.random()*60)+18+'y',
                    gender,
                    uniqueId: overrideProps.id || Date.now() + Math.random(),
                    location: 'amb',
                    triaged: false,
                    treated: false,
                    scanned: false,
                    history: [{ time: timeStr, msg: 'Arrived via Ambulance' }],
                    ...overrideProps
                };
            };

            const spawnPatients = (count, currentSimTime) => {
                const scenarioConfig = SCENARIOS[selectedScenario];
                const newP = Array(count).fill(0).map(() => {
                    const r = Math.random();
                    let cat = 'P3';
                    if (r < scenarioConfig.p1) cat = 'P1';
                    else if (r < scenarioConfig.p1 + scenarioConfig.p2) cat = 'P2';

                    let pool = PATIENT_TEMPLATES.standard;
                    if (scenarioConfig.type === 'chem' && Math.random() > 0.3) pool = PATIENT_TEMPLATES.chem;
                    if (scenarioConfig.type === 'crush' && Math.random() > 0.3) pool = PATIENT_TEMPLATES.crush;
                    
                    let options = pool.filter(p => p.category === cat);
                    if (options.length === 0) options = pool; 
                    const base = options[Math.floor(Math.random() * options.length)];
                    
                    return createPatient(base, formatTime(currentSimTime), { category: cat });
                });
                setPatients(prev => [...prev, ...newP]);
                playAudio('ping');
            };

            const generatePrefillPatients = (timeStr) => {
                const prefill = [];
                // Helper to add patients
                const add = (zone, count, treated) => {
                    for(let i=0; i<count; i++) {
                         // mostly P2/P3 for prefill
                        const base = PATIENT_TEMPLATES.standard[Math.floor(Math.random() * PATIENT_TEMPLATES.standard.length)];
                        prefill.push(createPatient(base, timeStr, { 
                            location: zone, 
                            triaged: true, 
                            treated: treated,
                            history: [{ time: "08:00", msg: "Handover: Patient in department" }] 
                        }));
                    }
                };
                
                add('resus', 1, false);
                add('majors', 4, false);
                add('minors', 5, true); // Some ready to go
                add('ward', 15, true); // Full wards
                add('icu', 3, true);
                return prefill;
            };

            const startTutorial = () => {
                initAudio();
                const generatedRoles = generateRoster({ senior: 0, resident: 0, nurse: 1 }); // Minimal staff
                setRoleStates(generatedRoles.map(r => ({ ...r, currentAp: r.ap, disabled: false })));
                setCurrentRoleId('bronze_cmd'); // Force start off target
                
                // One specific patient for tutorial
                const tutPatient = createPatient(PATIENT_TEMPLATES.tutorial[0], "12:00", { id: 99999 });
                setPatients([tutPatient]);
                
                setGameState('playing');
                setTutorialStep(1);
                localStorage.removeItem('wmebem_save');
            };

            const startGame = () => {
                try {
                    initAudio(); // Resume context on user gesture
                    const generatedRoles = generateRoster(staffCounts);
                    setRoleStates(generatedRoles.map(r => ({ ...r, currentAp: r.ap, disabled: false })));
                    setCurrentRoleId(generatedRoles[0].id);
                    
                    // Initial Spawn
                    const initialTime = 12 * 60;
                    const incidentPatients = [];
                    
                    // Generate standard incident load
                    const scenarioConfig = SCENARIOS[selectedScenario];
                    for(let i=0; i<6; i++) {
                        // Same logic as spawnPatients but manual to combine arrays
                        const r = Math.random();
                        let cat = 'P3';
                        if (r < scenarioConfig.p1) cat = 'P1';
                        else if (r < scenarioConfig.p1 + scenarioConfig.p2) cat = 'P2';
                        
                        let pool = PATIENT_TEMPLATES.standard;
                         if (scenarioConfig.type === 'chem' && Math.random() > 0.3) pool = PATIENT_TEMPLATES.chem;
                        if (scenarioConfig.type === 'crush' && Math.random() > 0.3) pool = PATIENT_TEMPLATES.crush;
                         let options = pool.filter(p => p.category === cat);
                        if (options.length === 0) options = pool;
                        const base = options[Math.floor(Math.random() * options.length)];
                        incidentPatients.push(createPatient(base, formatTime(initialTime), { category: cat }));
                    }

                    if (isPrefilled) {
                        const prefilled = generatePrefillPatients(formatTime(initialTime));
                        setPatients([...prefilled, ...incidentPatients]);
                    } else {
                        setPatients(incidentPatients);
                    }

                    setGameState('playing');
                    localStorage.removeItem('wmebem_save');
                } catch(e) {
                    console.error("Start game error", e);
                }
            };

            const checkGameOver = (currentPatients, currentDeaths) => {
                if (currentDeaths > 0) return "A P1 patient has died due to delayed treatment.";
                if (currentPatients.filter(p => p.location === 'amb').length > 12) return "Ambulance Bay Overflow. The department has collapsed.";
                return null;
            };

            const triggerEvent = () => {
                if (Math.random() > 0.7) {
                    const event = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];
                    setActiveEvent(event);
                    playAudio('alert');
                    if (event.id === 'needlestick') {
                        setRoleStates(prev => {
                            const nurses = prev.filter(r => r.id.startsWith('nurse_staff'));
                            if (nurses.length > 0) {
                                const target = nurses[Math.floor(Math.random() * nurses.length)];
                                return prev.map(r => r.id === target.id ? { ...r, disabled: true, currentAp: 0 } : r);
                            }
                            return prev;
                        });
                    } else if (event.id === 'med_student') {
                        setRoleStates(prev => prev.map(r => r.id.startsWith('senior_doc') ? { ...r, currentAp: r.currentAp + 2 } : r));
                    } else if (event.id === 'rapid_offload') {
                        spawnPatients(3, simTime);
                    }
                } else {
                    setActiveEvent(null);
                }
            };

            const nextTurn = () => {
                pushHistory();
                const failure = checkGameOver(patients, deaths);
                if (failure) { setGameState('gameover'); setModalContent(failure); return; }
                setTurn(t => t + 1);
                const newTime = simTime + 15; setSimTime(newTime);
                setRoleStates(prev => prev.map(r => ({ ...r, currentAp: r.ap, disabled: false })));
                triggerEvent();
                spawnPatients(Math.floor(Math.random() * 3) + 1, newTime);
                setPatients(prev => {
                    let p1Dead = false;
                    const nextP = prev.map(p => {
                        if(p.category === 'P1' && !p.treated && !['morgue','discharged'].includes(p.location)) {
                            const turnsWaiting = (p.turnsWaiting || 0) + 1;
                            if(turnsWaiting > 1) { p1Dead = true; return addHistory({ ...p, location: 'morgue' }, "DIED: Treatment delay"); }
                            return { ...p, turnsWaiting };
                        }
                        return p;
                    });
                    if (p1Dead) { playAudio('flatline'); setDeaths(d => d + 1); setGameState('gameover'); setModalContent("A P1 patient has died due to delayed treatment."); }
                    return nextP;
                });
            };

            const deductAp = (cost) => { setRoleStates(prev => prev.map(r => r.id === currentRoleId ? { ...r, currentAp: r.currentAp - cost } : r)); };

            const handleAction = () => {
                if(!selectedPatient || !currentRole || currentRole.disabled) return;
                pushHistory();
                const triageCost = activeEvent?.id === 'it_failure' ? 2 : 1;
                if(getPatientNeeds(selectedPatient).some(n=>n.id==='triage') && currentRole.canTriage) {
                    if (currentRole.currentAp < triageCost) return;
                    
                    // Active Triage Check
                    if (isActiveTriageMode && !selectedPatient.triaged) {
                        setTriageTarget(selectedPatient);
                        return; // Stop here, show modal
                    }
                    
                    // Standard Auto-Triage (for tutorial or disabled active mode)
                    performTriage(selectedPatient, true, false);
                } else if (getPatientNeeds(selectedPatient).some(n=>n.id==='scan') && currentRole.canScan) {
                    if (activeEvent?.id === 'ct_overheat') { alert("Scanner is broken!"); return; }
                    if (selectedPatient.location !== 'ct') { alert("Move to CT first"); return; }
                    setPatients(prev => prev.map(p => p.uniqueId === selectedPatientId ? addHistory({ ...p, scanned: true }, "CT Scan Completed") : p));
                    deductAp(1);
                } else if (getPatientNeeds(selectedPatient).some(n=>n.id==='treat') && currentRole.canTreat) {
                    if (selectedPatient.reqSkill === 'advanced_trauma' && !currentRole.skills.includes('advanced_trauma')) { alert("Need Senior Doc!"); return; }
                    if ((selectedPatient.injuryLoc==='head'||selectedPatient.injuryLoc==='abdo') && !selectedPatient.scanned) { alert("Needs Scan!"); return; }
                    if (selectedPatient.category === 'P1') {
                        if (resources.blood < 1) { alert("No Blood!"); return; }
                        setResources(p => ({...p, blood: p.blood - 1}));
                    }
                    setPatients(prev => prev.map(p => p.uniqueId === selectedPatientId ? addHistory({ ...p, treated: true }, selectedPatient.treatmentAction || "Treatment Administered") : p));
                    playAudio('treat');
                    deductAp(1); setScore(s => s + 10);
                    if(tutorialStep === 7) setTutorialStep(8); // Tutorial progress
                }
            };

            const handleAbility = () => {
                if(!currentRole || currentRole.currentAp < currentRole.abilityCost || currentRole.disabled) return;
                pushHistory();
                deductAp(currentRole.abilityCost);
                if(currentRole.id === 'bronze_cmd') { setResources(prev => ({ ...prev, blood: prev.blood + 2, vents: prev.vents + 1 })); setEventLog(prev => ["Emergency Supply: +2 Blood, +1 Vent", ...prev]); } 
                else if(currentRole.id.startsWith('senior_doc')) { setPatients(prev => prev.map(p => p.location === 'amb' ? addHistory({...p, triaged: true}, `Rapid Triage by Senior Doc`) : p)); }
                else if(currentRole.id === 'nurse_ic') { setPatients(prev => prev.map(p => p.location === 'triage' ? addHistory({...p, triaged: true}, `Team Huddle Triage`) : p)); }
                else if(currentRole.id.startsWith('nurse_staff')) {
                    const p3 = patients.find(p => p.category === 'P3' && p.location === 'amb');
                    if(p3) { setPatients(prev => prev.map(p => p.uniqueId === p3.uniqueId ? addHistory({ ...p, location: 'minors', triaged: true }, "Streamed to Minors") : p)); }
                }
                else if(currentRole.id.startsWith('resident')) {
                    const p3 = patients.find(p => p.category === 'P3' && !p.treated && p.location === 'minors');
                    if(p3) { setPatients(prev => prev.map(p => p.uniqueId === p3.uniqueId ? addHistory({ ...p, treated: true }, "Fast Track Treatment") : p)); playAudio('treat'); }
                }
                else if(currentRole.id === 'radiology') {
                    const target = patients.find(p => (p.location === 'resus' || p.location === 'majors') && !p.treated && !p.scanned);
                    if(target) { setPatients(prev => prev.map(p => p.uniqueId === target.uniqueId ? addHistory({ ...p, location: 'ct' }, "Rapid Scan Transfer") : p)); }
                }
                else if(currentRole.id === 'bed_manager') {
                    const target = patients.find(p => p.location === 'ward');
                    if(target) { 
                        setPatients(prev => prev.map(p => p.uniqueId === target.uniqueId ? addHistory({ ...p, location: 'discharged' }, "Forced Discharge") : p)); 
                        setDischarged(d => d + 1); 
                        if(target.treated) setScore(s => s + 20); else { setScore(s => s - 20); }
                    }
                }
            };

            const handleDrop = (e, zoneId) => {
                e.preventDefault();
                const pid = Number(e.dataTransfer.getData("patientId"));
                const p = patients.find(pt => pt.uniqueId === pid);
                if (activeEvent?.id === 'ct_overheat' && zoneId === 'ct') return;
                if(p && currentRole.currentAp > 0 && !currentRole.disabled && p.location !== zoneId) {
                    pushHistory();
                    const zoneName = ZONES.find(z => z.id === zoneId)?.name || zoneId;
                    setPatients(prev => prev.map(pt => pt.uniqueId === pid ? addHistory({ ...pt, location: zoneId }, `Moved to ${zoneName}`) : pt));
                    deductAp(1); setSelectedPatientId(pid); playAudio('move');
                    // Tutorial Progress
                    if(tutorialStep === 3 && zoneId === 'triage') setTutorialStep(4);
                    if(tutorialStep === 5 && zoneId === 'minors') setTutorialStep(6);
                    if(tutorialStep === 8 && zoneId === 'discharged') setTutorialStep(9);
                }
            };
            const handleZoneClick = (zoneId) => { if (selectedPatientId) handleDrop({preventDefault:()=>{}, dataTransfer:{getData:()=>selectedPatientId}}, zoneId); };

            if (gameState === 'start') {
                const hasSave = localStorage.getItem('wmebem_save');
                const getRoleSuggestion = (count) => {
                    if(count === 1) return "Solo Mode: You control all Command, Nursing, Medical, and Support roles.";
                    if(count === 2) return "P1: Command + Medical | P2: Nursing + Support";
                    if(count === 3) return "P1: Command | P2: Nursing | P3: Medical + Support";
                    if(count >= 4) return "Assign Command, Nursing, Medical, and Support roles to different players.";
                    return "";
                };
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border-t-8 border-blue-800">
                            <img src={LOGO_URL} className="h-24 mx-auto mb-6 object-contain" />
                            <h1 className="text-3xl font-black text-slate-900 mb-2 tracking-tight">INCIDENT<span className="text-blue-600">COMMAND</span></h1>
                            <p className="text-slate-500 mb-6 font-medium">WMEBEM Digital Simulation</p>
                            <div className="mb-6 space-y-4 text-left">
                                {hasSave && <button type="button" onClick={loadGame} className="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold mb-4 cursor-pointer">Resume Simulation</button>}
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide text-center">Scenario Selection</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {Object.entries(SCENARIOS).map(([key, val]) => (
                                            <button type="button" key={key} onClick={() => setSelectedScenario(key)} className={`p-2 rounded border text-xs font-bold cursor-pointer ${selectedScenario === key ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>{val.name}</button>
                                        ))}
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1 text-center italic">{SCENARIOS[selectedScenario].desc}</p>
                                </div>
                                <div className="border-t pt-4">
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-sm font-bold text-gray-700 uppercase tracking-wide">Pre-fill Dept</label>
                                        <button type="button" onClick={()=>setIsPrefilled(!isPrefilled)} className={`w-12 h-6 rounded-full p-1 transition-colors cursor-pointer ${isPrefilled ? 'bg-blue-600' : 'bg-gray-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${isPrefilled ? 'translate-x-6' : ''}`}></div></button>
                                    </div>
                                    
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-sm font-bold text-gray-700 uppercase tracking-wide">Active Triage</label>
                                        <button type="button" onClick={()=>setIsActiveTriageMode(!isActiveTriageMode)} className={`w-12 h-6 rounded-full p-1 transition-colors cursor-pointer ${isActiveTriageMode ? 'bg-blue-600' : 'bg-gray-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${isActiveTriageMode ? 'translate-x-6' : ''}`}></div></button>
                                    </div>

                                    <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide text-center mt-4">Staff & Players</label>
                                    <div className="flex flex-wrap justify-center gap-2 mb-2">{[1, 2, 3, 4, 5, 6, 7, 8].map(num => ( <button type="button" key={num} onClick={() => setPlayerCount(num)} className={`w-8 h-8 rounded font-bold text-sm transition-all cursor-pointer ${playerCount === num ? 'bg-blue-600 text-white scale-110 shadow' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{num}</button> ))}</div>
                                    <div className="space-y-2">
                                        <Counter label="Senior Docs" value={staffCounts.senior} onChange={(v)=>setStaffCounts({...staffCounts, senior: v})} min={1} max={3} />
                                        <Counter label="Residents" value={staffCounts.resident} onChange={(v)=>setStaffCounts({...staffCounts, resident: v})} min={1} max={6} />
                                        <Counter label="Nurses" value={staffCounts.nurse} onChange={(v)=>setStaffCounts({...staffCounts, nurse: v})} min={1} max={8} />
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-col gap-3">
                                <button type="button" onClick={startGame} className="w-full py-4 bg-blue-700 hover:bg-blue-800 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all transform active:scale-95 cursor-pointer">Initialise New Incident</button>
                                <button type="button" onClick={startTutorial} className="w-full py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl font-bold text-md shadow transition-all cursor-pointer">Play Tutorial</button>
                            </div>
                            <div className="mt-4 text-xs text-slate-400">Version 6.8  WMEBEM</div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'gameover') return <GameOver reason={modalContent} stats={{score, discharged, deaths}} onRestart={() => setGameState('start')} />;

            return (
                <div className="h-screen flex flex-col bg-slate-100 text-slate-800 font-sans overflow-hidden">
                    {/* TUTORIAL OVERLAY */}
                    {tutorialStep > 0 && (
                        <TutorialOverlay step={tutorialStep}>
                            {tutorialStep === 1 && "Select the **Nurse In Charge** from the staff list on the left."}
                            {tutorialStep === 2 && "Great! Now tap the **Patient** in the Ambulance Bay to select them."}
                            {tutorialStep === 3 && "We don't know how sick they are. Move them to the **Triage** zone."}
                            {tutorialStep === 4 && "Now they are in Triage. Tap the **Triage Action** button below to assess them."}
                            {tutorialStep === 5 && "They are P3 (Green). They need minor treatment. Move them to **Minors**."}
                            {tutorialStep === 6 && "They need care, not a doctor. Select an **ED Nurse** from the staff list."}
                            {tutorialStep === 7 && "Now tap the **Treat** button to suture their wound."}
                            {tutorialStep === 8 && "They are stable! Move them to **Home** to discharge them."}
                            {tutorialStep === 9 && "Tutorial Complete! You scored points and saved a patient."}
                        </TutorialOverlay>
                    )}

                    <div className="h-14 bg-white border-b px-4 flex items-center justify-between shrink-0 z-20 relative shadow-sm">
                        <div className="flex items-center gap-3"><img src={LOGO_URL} className="logo-h" /><span className="font-bold text-sm hidden sm:inline">Turn {turn} ({formatTime(simTime)})</span></div>
                        <div className="flex items-center gap-4 font-bold text-sm">
                             <div className="flex gap-2 items-center">
                                 <button type="button" onClick={() => setIsMuted(!isMuted)} className="text-slate-500 hover:text-slate-800 p-1 cursor-pointer">{isMuted ? <VolumeX size={18} /> : <Volume2 size={18} />}</button>
                                 <button type="button" onClick={() => setSidebarOpen(!isSidebarOpen)} className="lg:hidden text-xs font-bold text-slate-600 hover:text-slate-800 flex items-center gap-1 px-2 py-1 rounded bg-slate-100 cursor-pointer"><Menu size={16} /> Menu</button>
                                 <button type="button" onClick={() => setModalContent('guide')} className="hidden lg:flex text-xs font-bold text-blue-600 hover:text-blue-800 items-center gap-1 px-3 py-1 rounded hover:bg-blue-50 transition-colors cursor-pointer"><BookOpen size={16} /> Guide</button>
                                 <button type="button" onClick={() => setModalContent('roles')} className="hidden lg:flex text-xs font-bold text-purple-600 hover:text-purple-800 items-center gap-1 px-3 py-1 rounded hover:bg-purple-50 transition-colors cursor-pointer"><BadgeInfo size={16} /> Roles</button>
                             </div>
                            <div className="h-6 w-px bg-gray-200 hidden sm:block"></div>
                            <button type="button" onClick={handleUndo} disabled={historyStack.length===0} className="flex items-center gap-1 px-3 py-1 rounded bg-slate-100 hover:bg-slate-200 disabled:opacity-50 text-xs font-bold cursor-pointer"><RotateCcw size={14}/> <span className="hidden sm:inline">Undo</span></button>
                            <div className="flex flex-col items-center leading-none mx-2"><span className="text-[10px] text-slate-400 uppercase">Score</span><span className="font-bold">{score}</span></div>
                            <button type="button" onClick={nextTurn} disabled={tutorialStep > 0} className="bg-slate-800 text-white px-4 py-1.5 rounded text-xs hover:bg-slate-700 font-bold cursor-pointer disabled:opacity-50">Next</button>
                        </div>
                    </div>

                    <div className="flex flex-1 overflow-hidden relative">
                        <div className={`absolute inset-y-0 left-0 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:relative lg:translate-x-0 transition duration-200 ease-in-out w-64 bg-white border-r flex flex-col shrink-0 z-30 shadow-2xl lg:shadow-none`}>
                            <div className="p-4 border-b bg-slate-50 flex justify-between items-center"><span className="font-black text-[10px] uppercase tracking-widest text-slate-400">Resources</span><button type="button" onClick={()=>setSidebarOpen(false)} className="lg:hidden text-slate-400 cursor-pointer"><X size={16}/></button></div>
                            <div className="p-4 border-b bg-slate-50 grid grid-cols-2 gap-2 text-center text-xs font-bold">
                                <div className="bg-white border rounded p-1 shadow-sm"><Droplet size={14} className="mx-auto text-red-500 mb-1"/>{resources.blood}</div>
                                <div className="bg-white border rounded p-1 shadow-sm"><Wind size={14} className="mx-auto text-emerald-500 mb-1"/>{resources.vents}</div>
                            </div>
                            <div className="p-3 border-b font-bold text-xs text-slate-400 uppercase tracking-widest flex justify-between items-center">
                                <span>Staff Rostering</span>
                                <div className="lg:hidden flex gap-2"><button type="button" onClick={() => setModalContent('guide')} className="text-blue-600 cursor-pointer"><BookOpen size={14}/></button><button type="button" onClick={() => setModalContent('roles')} className="text-purple-600 cursor-pointer"><BadgeInfo size={14}/></button></div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                {roleStates.map(r => { const RoleIcon = r.icon; 
                                    // Tutorial Highlight for Nurse IC (Step 1) or Staff Nurse (Step 6)
                                    const isHighlight = (tutorialStep === 1 && r.id === 'nurse_ic') || (tutorialStep === 6 && r.id.startsWith('nurse_staff'));
                                    return ( <button type="button" key={r.id} onClick={() => { setCurrentRoleId(r.id); if(window.innerWidth < 1024) setSidebarOpen(false); }} disabled={r.disabled} className={`w-full text-left px-3 py-2 rounded border-l-4 transition-all mb-1 group cursor-pointer ${currentRoleId === r.id ? getActiveStyle(r.theme) + ' shadow-md' : getColorStyle(r.theme) + ' bg-white border-transparent'} ${r.disabled ? 'opacity-50 bg-slate-100' : ''} ${isHighlight ? 'tutorial-highlight' : ''}`}><div className="flex justify-between items-center"><div className="flex items-center gap-2"><div className={`p-1 rounded ${currentRoleId === r.id ? 'bg-white/20' : 'bg-gray-100 group-hover:bg-white'}`}><RoleIcon size={16} strokeWidth={2.5} /></div><div><span className="font-bold text-xs block">{r.name}</span><span className="text-[10px] opacity-75">{r.disabled ? 'UNAVAILABLE' : r.actionText}</span></div></div><span className={`text-[10px] font-black px-1.5 py-0.5 rounded ${r.currentAp === 0 ? 'bg-red-500 text-white' : 'bg-white/30'}`}>{r.currentAp}</span></div></button> )})}
                            </div>
                        </div>

                        <div className="flex-1 bg-slate-200 p-3 overflow-y-auto relative flex flex-col" onClick={() => setSelectedPatientId(null)}>
                            <button type="button" onClick={()=>setSidebarOpen(true)} className="lg:hidden absolute top-3 left-3 z-20 bg-white p-2 rounded shadow cursor-pointer"><Menu size={20}/></button>
                            {activeEvent && <div className="mb-3 bg-amber-50 border border-amber-200 p-3 rounded flex items-center gap-3 shadow-sm animate-bounce"><AlertTriangle className="text-amber-600"/><div className="text-xs"><span className="font-bold block text-amber-800">{activeEvent.title}</span>{activeEvent.desc} <span className="font-bold">({activeEvent.effect})</span></div></div>}

                            <div className={`grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 flex-1 transition-all duration-300 ${selectedPatientId ? 'scale-[0.99]' : ''}`}>
                                <div className="col-span-1 bg-red-50/50 rounded-xl border border-red-100/50 p-2 flex flex-col gap-2"><div className="text-[10px] font-black text-red-300 uppercase tracking-widest text-center">Intake</div><div className="flex-1 grid grid-rows-3 gap-2"><div className="row-span-2 min-h-[150px]"><ZoneDisplay zone={ZONES[0]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} isTutorialTarget={tutorialStep === 2 && selectedPatientId === null} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[1]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} isTutorialTarget={tutorialStep === 3} /></div></div></div>
                                <div className="col-span-1 bg-blue-50/50 rounded-xl border border-blue-100/50 p-2 flex flex-col gap-2"><div className="text-[10px] font-black text-blue-300 uppercase tracking-widest text-center">Acute</div><div className="flex-1 grid grid-rows-3 gap-2"><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[2]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[3]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[5]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} isTutorialTarget={tutorialStep === 5} /></div></div></div>
                                <div className="col-span-1 bg-purple-50/50 rounded-xl border border-purple-100/50 p-2 flex flex-col gap-2"><div className="text-[10px] font-black text-purple-300 uppercase tracking-widest text-center">Imaging</div><div className="flex-1 grid grid-rows-3 gap-2"><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[4]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-2"></div></div></div>
                                <div className="col-span-1 bg-emerald-50/50 rounded-xl border border-emerald-100/50 p-2 flex flex-col gap-2"><div className="text-[10px] font-black text-emerald-300 uppercase tracking-widest text-center">Wards</div><div className="flex-1 grid grid-rows-3 gap-2"><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[6]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[7]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-1"></div></div></div>
                                <div className="col-span-1 bg-gray-100/50 rounded-xl border border-gray-200/50 p-2 flex flex-col gap-2"><div className="text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">Ops</div><div className="flex-1 grid grid-rows-3 gap-2"><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[8]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[9]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} isTutorialTarget={tutorialStep === 8} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[10]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div></div></div>
                            </div>
                            
                            {/* Footer */}
                            <div className="mt-4 border-t border-gray-300 pt-2 pb-24 lg:pb-2 text-[10px] text-gray-500 flex flex-wrap justify-between items-center gap-2">
                                <div className="flex gap-4"><span> 2025 WMEBEM. Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">CC BY-NC-SA 4.0</a>.</span></div>
                                <div className="flex gap-4">
                                    <a href="https://www.england.nhs.uk/ourwork/eprr/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-bold">NHS England EPRR</a>
                                    <span></span>
                                    <a href="https://www.england.nhs.uk/publication/clinical-guidelines-for-major-incidents-and-mass-casualty-events/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-bold">Clinical Guidelines</a>
                                    <span></span>
                                    <a href="https://tstmitt.netlify.app" target="_blank" rel="noopener noreferrer" className="text-purple-600 hover:underline font-bold">TST / MITT Training</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    {selectedPatient && currentRole && <ActionHUD patient={selectedPatient} role={currentRole} onClose={() => setSelectedPatientId(null)} onAction={handleAction} onAbility={handleAbility} resources={resources} time={formatTime(simTime)} activeEvent={activeEvent} tutorialStep={tutorialStep} isActiveTriage={isActiveTriageMode} />}
                    {activeEvent && !activeEvent.acknowledged && <EventModal event={activeEvent} onClose={() => { const e = {...activeEvent, acknowledged: true}; setActiveEvent(e); }} />}
                    {modalContent === 'guide' && <Modal title="WMEBEM Simulation Guide" onClose={() => setModalContent(null)}><UserGuide /></Modal>}
                    {modalContent === 'roles' && <Modal title="Role Capabilities Key" onClose={() => setModalContent(null)}><RoleKey /></Modal>}
                    {triageTarget && <TriageModal patient={triageTarget} onClose={() => setTriageTarget(null)} onConfirm={handleTriageConfirm} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
