<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMEBEM Incident Command</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; user-select: none; overflow: hidden; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        /* Zone Styling */
        .zone-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .zone-card.dimmed { opacity: 0.4; filter: grayscale(0.8); }
        .zone-card:active { transform: scale(0.98); background-color: #f8fafc; }
        .zone-card.drag-over { background-color: #f0f9ff; border-color: #0284c7; box-shadow: 0 0 0 4px #0284c7 inset; }
        
        /* Patient Colours */
        .p1-bg { background-color: #fee2e2; border-left: 5px solid #dc2626; } 
        .p2-bg { background-color: #fef3c7; border-left: 5px solid #d97706; } 
        .p3-bg { background-color: #d1fae5; border-left: 5px solid #059669; } 
        .dead-bg { background-color: #e2e8f0; border-left: 5px solid #1e293b; }
        .neutral-bg { background-color: #f1f5f9; border-left: 5px solid #94a3b8; } 
        
        /* Tutorial Highlight */
        .tutorial-highlight { 
            box-shadow: 0 0 0 4px #facc15, 0 0 20px #facc15; 
            z-index: 50; 
            position: relative;
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0px rgba(250, 204, 21, 0.7); }
            100% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); }
        }

        /* Animations */
        .hud-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .toast-enter { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .vital-red { color: #dc2626; font-weight: 900; animation: pulse 2s infinite; }
        .vital-amber { color: #d97706; font-weight: bold; }
        .vital-normal { color: #059669; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Mobile Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        
        .logo-h { height: 2rem; width: auto; }

        /* Capacity Bar Striping */
        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: progress-bar-stripes 1s linear infinite;
        }
        @keyframes progress-bar-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }
        
        .prealert-flash {
            animation: prealert-pulse 1s infinite;
        }
        @keyframes prealert-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- AUDIO MANAGER ---
        let audioCtx = null;
        const getAudioCtx = () => {
            if (!audioCtx && (window.AudioContext || window.webkitAudioContext)) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioCtx;
        };
        const initAudio = () => {
             const ctx = getAudioCtx();
             if (ctx && ctx.state === 'suspended') { ctx.resume(); }
        };
        const playSound = (type) => {
            try {
                const ctx = getAudioCtx();
                if (!ctx) return;
                if (ctx.state === 'suspended') ctx.resume().catch(() => {});
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;
                if (type === 'ping') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.5);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'treat') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(880, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1);
                    const osc2 = ctx.createOscillator(); const gain2 = ctx.createGain(); osc2.connect(gain2); gain2.connect(ctx.destination);
                    osc2.type = 'triangle'; osc2.frequency.setValueAtTime(880, now + 0.15); gain2.gain.setValueAtTime(0.1, now + 0.15); gain2.gain.linearRampToValueAtTime(0, now + 0.25); osc2.start(now + 0.15); osc2.stop(now + 0.25);
                } else if (type === 'flatline') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); gain.gain.setValueAtTime(0.15, now); gain.gain.linearRampToValueAtTime(0, now + 2.5); osc.start(now); osc.stop(now + 2.5);
                } else if (type === 'move') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(300, now); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.05); osc.start(now); osc.stop(now + 0.05);
                } else if (type === 'alert') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.linearRampToValueAtTime(880, now + 0.3); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3); osc.start(now); osc.stop(now + 0.3);
                } else if (type === 'error') {
                     osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3); osc.start(now); osc.stop(now + 0.3);
                }
            } catch (e) { }
        };

        // --- ICONS ---
        const IconWrapper = ({ children, size = 20, strokeWidth = 2, className = "", ...props }) => ( <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg> );
        const ClipboardCheck = (p) => <IconWrapper {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></IconWrapper>;
        const Scan = (p) => <IconWrapper {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></IconWrapper>;
        const Stethoscope = (p) => <IconWrapper {...p}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v6"/><path d="M16 15v6a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-6"/><circle cx="12" cy="20" r="2"/></IconWrapper>;
        const DoorOpen = (p) => <IconWrapper {...p}><path d="M13 4h3a2 2 0 0 1 2 2v14"/><path d="M2 20h3"/><path d="M13 20h9"/><path d="M10 12v.01"/><path d="M13 4.562v16.157a1 1 0 0 1-1.242.97L5 20V5.562a2 2 0 0 1 1.515-1.94l4-1A2 2 0 0 1 13 4.561Z"/></IconWrapper>;
        const Check = (p) => <IconWrapper {...p}><path d="M20 6 9 17l-5-5"/></IconWrapper>;
        const CheckCircle = (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></IconWrapper>;
        const ShieldAlert = (p) => <IconWrapper {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></IconWrapper>;
        const X = (p) => <IconWrapper {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const Users = (p) => <IconWrapper {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>;
        const Droplet = (p) => <IconWrapper {...p}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></IconWrapper>;
        const Wind = (p) => <IconWrapper {...p}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></IconWrapper>;
        const Syringe = (p) => <IconWrapper {...p}><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/><path d="m9 11 4 4"/><path d="m5 19-3 3"/></IconWrapper>;
        const Activity = (p) => <IconWrapper {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
        const Bed = (p) => <IconWrapper {...p}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></IconWrapper>;
        const BookOpen = (p) => <IconWrapper {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>;
        const BadgeInfo = (p) => <IconWrapper {...p}><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.78 4.78 4 4 0 0 1-6.74 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z"/><line x1="12" x2="12" y1="8" y2="8"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>;
        const FileText = (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconWrapper>;
        const Menu = (p) => <IconWrapper {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconWrapper>;
        const Minus = (p) => <IconWrapper {...p}><path d="M5 12h14"/></IconWrapper>;
        const Plus = (p) => <IconWrapper {...p}><path d="M12 5v14"/><path d="M5 12h14"/></IconWrapper>;
        const RotateCcw = (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>;
        const AlertTriangle = (p) => <IconWrapper {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>;
        const Volume2 = (p) => <IconWrapper {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></IconWrapper>;
        const VolumeX = (p) => <IconWrapper {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></IconWrapper>;
        const Lightbulb = (p) => <IconWrapper {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconWrapper>;
        const Ambulance = (p) => <IconWrapper {...p}><path d="M10 10h4"/><path d="M12 8v4"/><path d="M19 17h1a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3"/><path d="M4 17h1"/><path d="M4 9h2a1 1 0 0 1 1 1v7"/><path d="M1 9h3"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></IconWrapper>;
        const PersonStanding = (p) => <IconWrapper {...p}><circle cx="12" cy="5" r="1"/><path d="m9 20 3-6 3 6"/><path d="m6 8 6 2 6-2"/><path d="M12 10v4"/></IconWrapper>;
        const Stretcher = (p) => <IconWrapper {...p}><rect width="20" height="8" x="2" y="10" rx="2"/><circle cx="6" cy="20" r="2"/><circle cx="18" cy="20" r="2"/><path d="M6 10V6h12v4"/></IconWrapper>;
        const Award = (p) => <IconWrapper {...p}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></IconWrapper>;
        const LogOut = (p) => <IconWrapper {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconWrapper>;
        const BarChart2 = (p) => <IconWrapper {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconWrapper>;
        const TrendingUp = (p) => <IconWrapper {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>;

        // --- CONSTANTS ---
        const LOGO_URL = "https://iili.io/KGQOvkl.md.png";
        const WIN_GOAL = 10; // 10 Discharges needed for certificate
        
        const RANDOM_EVENTS = [
            { id: 'needlestick', title: 'Needlestick Injury', desc: 'A Nurse has sustained a needlestick injury and must report to Occ Health.', effect: 'One Nurse removed for 1 turn.' },
            { id: 'ct_overheat', title: 'Scanner Overheat', desc: 'The CT Scanner cooling system has failed.', effect: 'CT Scanner disabled for this turn.' },
            { id: 'norovirus', title: 'Norovirus Outbreak', desc: 'Ward 4 closed due to D&V.', effect: 'Ward Capacity reduced by 5.' },
            { id: 'med_student', title: 'Keen Med Student', desc: 'A final year student offers to help with bloods.', effect: 'Senior Doctor gains +2 AP.' },
            { id: 'rapid_offload', title: 'Rapid Offload', desc: 'Multiple ambulances arrive at once.', effect: '3 Extra Patients added to Ambulance Bay.' },
            { id: 'it_failure', title: 'IT Systems Failure', desc: 'EPR is down. We are on paper.', effect: 'Triage costs 2 AP this turn.' }
        ];
        const SCENARIOS = {
            standard: { name: "Standard Incident", desc: "A major incident has been declared. Balanced mix of trauma and medical casualties.", p1: 0.2, p2: 0.3, p3: 0.5 },
            chemical: { name: "Chemical Attack", desc: "CBRN incident. High number of airway risks (P1) requiring advanced skills.", p1: 0.5, p2: 0.3, p3: 0.2, type: 'chem' },
            bus_crash: { name: "Bus Crash", desc: "Multi-vehicle collision. High volume of blunt trauma (Head/Chest/Abdo).", p1: 0.3, p2: 0.4, p3: 0.3, type: 'trauma' },
            collapse: { name: "Structural Collapse", desc: "Building collapse. Crush injuries and dust inhalation.", p1: 0.25, p2: 0.4, p3: 0.35, type: 'crush' }
        };
        const ROLE_TEMPLATES = {
            bronze_cmd: { type: 'command', theme: 'slate', icon: Activity, name: 'Bronze Commander', ap: 4, desc: 'Operational Lead', ability: 'Rapid Offload', abilityCost: 'ALL', abilityEffect: 'Move Amb -> Triage', actionText: 'Review', canTriage: true, skills: ['triage', 'care'] },
            senior_doc: { type: 'command', theme: 'slate', icon: ClipboardCheck, name: 'Senior Doctor', ap: 5, desc: 'Clinical Lead', ability: 'Rapid Triage', abilityCost: 2, abilityEffect: 'Reveal All Intake', actionText: 'Review', canTriage: true, canTreat: true, skills: ['advanced_trauma', 'care', 'triage'] },
            nurse_ic: { type: 'nursing', theme: 'blue', icon: Users, name: 'Nurse in Charge', ap: 4, desc: 'Coordination', ability: 'Rapid Offload', abilityCost: 'ALL', abilityEffect: 'Move Amb -> Triage', actionText: 'Coordinate', canTriage: true, skills: ['triage', 'care'] },
            nurse_staff: { type: 'nursing', theme: 'blue', icon: Syringe, name: 'ED Nurse', ap: 4, desc: 'Care & Triage', ability: 'Stream to Minors', abilityCost: 1, abilityEffect: 'Move P3 Free', actionText: 'Care / Triage', canTriage: true, canTreat: true, skills: ['care', 'triage'] },
            resident: { type: 'medical', theme: 'emerald', icon: Stethoscope, name: 'ED Resident', ap: 4, desc: 'Treatment', ability: 'Fast Track', abilityCost: 2, abilityEffect: 'Instant Treat P3', actionText: 'Procedure', canTreat: true, skills: ['advanced_trauma', 'care', 'triage'] },
            radiology: { type: 'support', theme: 'purple', icon: Scan, name: 'Radiology Lead', ap: 3, desc: 'Diagnostics', ability: 'Rapid Scan', abilityCost: 1, abilityEffect: 'Move to CT Free', actionText: 'Scan', canScan: true, skills: [] },
            bed_manager: { type: 'logistics', theme: 'amber', icon: Bed, name: 'Bed Manager', ap: 3, desc: 'Flow', ability: 'Force Discharge', abilityCost: 1, abilityEffect: 'Clear Ward Bed', actionText: 'Breach', skills: [] }
        };
        const generateRoster = (counts) => {
            const roles = [];
            roles.push({ id: 'bronze_cmd', ...ROLE_TEMPLATES.bronze_cmd });
            roles.push({ id: 'nurse_ic', ...ROLE_TEMPLATES.nurse_ic });
            roles.push({ id: 'radiology', ...ROLE_TEMPLATES.radiology });
            roles.push({ id: 'bed_manager', ...ROLE_TEMPLATES.bed_manager });
            for (let i = 0; i < counts.senior; i++) roles.push({ id: `senior_doc_${i}`, ...ROLE_TEMPLATES.senior_doc, name: counts.senior > 1 ? `Senior Doctor ${i+1}` : 'Senior Doctor' });
            for (let i = 0; i < counts.resident; i++) roles.push({ id: `resident_${i}`, ...ROLE_TEMPLATES.resident, name: counts.resident > 1 ? `ED Resident ${i+1}` : 'ED Resident' });
            for (let i = 0; i < counts.nurse; i++) roles.push({ id: `nurse_staff_${i}`, ...ROLE_TEMPLATES.nurse_staff, name: counts.nurse > 1 ? `ED Nurse ${i+1}` : 'ED Nurse' });
            return roles;
        };
        const ZONES = [
            { id: 'amb', name: 'Ambulance Bay', capacity: 12, type: 'intake' },
            { id: 'triage', name: 'Triage', capacity: 6, type: 'process' },
            { id: 'resus', name: 'Resus (P1)', capacity: 4, type: 'clinical' },
            { id: 'majors', name: 'Majors (P2)', capacity: 10, type: 'clinical' },
            { id: 'ct', name: 'CT Scan', capacity: 1, type: 'diagnostic' },
            { id: 'minors', name: 'Minors (P3)', capacity: 15, type: 'clinical' },
            { id: 'icu', name: 'ICU/HDU', capacity: 6, type: 'ward' },
            { id: 'ward', name: 'Wards', capacity: 30, type: 'ward' },
            { id: 'theatre', name: 'Theatres', capacity: 2, type: 'treatment' },
            { id: 'discharged', name: 'Home', capacity: 999, type: 'exit' },
            { id: 'morgue', name: 'Mortuary', capacity: 999, type: 'exit' }
        ];

        const getPatientNeeds = (p) => {
            const needs = [];
            if (!p.triaged) needs.push({ id: 'triage', label: 'Triage', icon: ClipboardCheck, color: 'text-slate-600', bg: 'bg-slate-100', borderColor: 'border-slate-300' });
            if (p.triaged && !p.treated) {
                const needsScan = (p.injuryLoc === 'head' || p.injuryLoc === 'abdo') && !p.scanned;
                if (needsScan) needs.push({ id: 'scan', label: 'CT Scan', icon: Scan, color: 'text-purple-600', bg: 'bg-purple-100', borderColor: 'border-purple-300' });
                if (!needsScan) {
                    const label = p.reqSkill === 'advanced_trauma' ? 'Needs Doctor' : 'Treatment';
                    needs.push({ id: 'treat', label: label, icon: Stethoscope, color: 'text-emerald-600', bg: 'bg-emerald-100', borderColor: 'border-emerald-300', reqSkill: p.reqSkill });
                }
            }
            if (p.treated && !['discharged','ward','icu','morgue'].includes(p.location)) {
                needs.push({ id: 'move', label: 'Admit/Discharge', icon: DoorOpen, color: 'text-amber-600', bg: 'bg-amber-100', borderColor: 'border-amber-300' });
            }
            return needs;
        };
        
        const getCarePathway = (p) => {
            const steps = [];
            const isDone = (condition) => condition ? 'done' : 'pending';
            steps.push({ id: 'triage', label: 'Triage & Obs', status: p.triaged ? 'done' : 'current', icon: ClipboardCheck });
            const needsScan = (p.injuryLoc === 'head' || p.injuryLoc === 'abdo');
            if (needsScan) { steps.push({ id: 'scan', label: 'CT Scan', status: p.scanned ? 'done' : (p.triaged ? 'current' : 'pending'), icon: Scan }); }
            const readyToTreat = p.triaged && (!needsScan || p.scanned);
            steps.push({ id: 'treat', label: p.reqSkill === 'advanced_trauma' ? 'Resus/Surgical' : 'Medical Care', status: p.treated ? 'done' : (readyToTreat ? 'current' : 'pending'), icon: Stethoscope });
            const isDischarged = ['discharged','ward','icu','morgue'].includes(p.location);
            steps.push({ id: 'move', label: 'Disposition', status: isDischarged ? 'done' : (p.treated ? 'current' : 'pending'), icon: DoorOpen });
            return steps;
        };

        const getColorStyle = (theme) => ({
            slate: 'border-slate-500 hover:bg-slate-50 text-slate-800',
            blue: 'border-blue-500 hover:bg-blue-50 text-blue-800',
            emerald: 'border-emerald-500 hover:bg-emerald-50 text-emerald-800',
            purple: 'border-purple-500 hover:bg-purple-50 text-purple-800',
            amber: 'border-amber-500 hover:bg-amber-50 text-amber-800'
        }[theme] || 'border-gray-500');
        const getActiveStyle = (theme) => ({
            slate: 'bg-slate-800 text-white border-slate-800',
            blue: 'bg-blue-700 text-white border-blue-700',
            emerald: 'bg-emerald-700 text-white border-emerald-700',
            purple: 'bg-purple-700 text-white border-purple-700',
            amber: 'bg-amber-700 text-white border-amber-700'
        }[theme] || 'bg-gray-800');

        // --- CERTIFICATE GENERATOR ---
        const generateCertificate = (playerNames, score, stats) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            
            doc.setLineWidth(3);
            doc.setDrawColor(30, 58, 138);
            doc.rect(10, 10, 277, 190);
            doc.setLineWidth(1);
            doc.setDrawColor(200, 200, 200);
            doc.rect(15, 15, 267, 180);

            doc.setFont("helvetica", "bold");
            doc.setFontSize(32);
            doc.setTextColor(30, 58, 138);
            doc.text("CERTIFICATE OF COMPETENCE", 148.5, 40, null, null, "center");
            
            doc.setFontSize(16);
            doc.setTextColor(100, 100, 100);
            doc.text("This is to certify that", 148.5, 60, null, null, "center");

            doc.setFont("helvetica", "bolditalic");
            doc.setFontSize(24);
            doc.setTextColor(0, 0, 0);
            doc.text(playerNames || "Participant", 148.5, 75, null, null, "center");
            doc.setLineWidth(0.5);
            doc.line(80, 77, 217, 77); 

            doc.setFont("helvetica", "normal");
            doc.setFontSize(14);
            doc.setTextColor(60, 60, 60);
            doc.text("Has successfully completed the WMEBEM Incident Command Simulation.", 148.5, 95, null, null, "center");
            
            doc.setFillColor(245, 247, 250);
            doc.roundedRect(70, 105, 157, 25, 3, 3, 'F');
            doc.setFontSize(12);
            doc.text(`Score: ${score}   |   Patients Discharged: ${stats.discharged}   |   Deaths: ${stats.deaths}`, 148.5, 122, null, null, "center");

            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.setTextColor(30, 58, 138);
            doc.text("Evidence of Progression towards RCEM 2021 Curriculum:", 148.5, 145, null, null, "center");
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const sloX = 60;
            const sloY = 155;
            const lineHeight = 7;
            
            doc.text("• SLO 6: Lead and manage the Emergency Department", sloX, sloY);
            doc.setFont("helvetica", "italic");
            doc.text("   - Key Capability: Demonstrate the principles of Major Incident Management", sloX, sloY + lineHeight);
            
            doc.setFont("helvetica", "normal");
            doc.text("• SLO 1: Care for physiologically stable and unstable patients of all ages", sloX, sloY + (lineHeight * 2));
            doc.setFont("helvetica", "italic");
            doc.text("   - Key Capability: Delivery of complex care in high-pressure environments", sloX, sloY + (lineHeight * 3));

            const date = new Date().toLocaleDateString();
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text(`Date Issued: ${date}`, 20, 185);
            doc.text("Verified by WMEBEM Digital Simulation Tool", 277, 185, null, null, "right");

            doc.save("Incident_Command_Certificate.pdf");
        };

        // --- COMPONENTS ---

        const Toast = ({ msg, type, onClose }) => {
            const styles = { error: "bg-red-600 text-white", info: "bg-blue-600 text-white", success: "bg-emerald-600 text-white", warning: "bg-amber-500 text-white" };
            useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            return ( <div className={`pointer-events-auto px-4 py-3 rounded shadow-lg mb-2 flex items-center gap-3 toast-enter ${styles[type] || styles.info} max-w-sm`}> {type === 'error' && <AlertTriangle size={18} />}{type === 'success' && <CheckCircle size={18} />}{type === 'warning' && <ShieldAlert size={18} />}{type === 'info' && <BadgeInfo size={18} />} <span className="text-sm font-bold shadow-black drop-shadow-sm">{msg}</span> <button onClick={onClose} className="ml-auto opacity-70 hover:opacity-100"><X size={16}/></button> </div> );
        };
        const ToastContainer = ({ toasts, removeToast }) => ( <div className="fixed top-16 right-4 z-[9999] pointer-events-none flex flex-col items-end"> {toasts.map(t => <Toast key={t.id} msg={t.msg} type={t.type} onClose={() => removeToast(t.id)} />)} </div> );

        const StickFigure = ({ injuryLoc, className }) => ( <svg viewBox="0 0 100 100" className={`overflow-visible ${className}`}><circle cx="50" cy="15" r="12" fill="none" stroke="currentColor" strokeWidth="6" /><line x1="50" y1="27" x2="50" y2="60" stroke="currentColor" strokeWidth="6" /><line x1="50" y1="35" x2="20" y2="50" stroke="currentColor" strokeWidth="6" /><line x1="50" y1="35" x2="80" y2="50" stroke="currentColor" strokeWidth="6" /><line x1="50" y1="60" x2="30" y2="95" stroke="currentColor" strokeWidth="6" /><line x1="50" y1="60" x2="70" y2="95" stroke="currentColor" strokeWidth="6" />{injuryLoc === 'head' && <circle cx="50" cy="15" r="15" stroke="#ef4444" strokeWidth="4" fill="none" className="animate-pulse" />}{injuryLoc === 'chest' && <circle cx="50" cy="40" r="12" stroke="#ef4444" strokeWidth="4" fill="none" className="animate-pulse" />}{injuryLoc === 'abdo' && <circle cx="50" cy="55" r="10" stroke="#ef4444" strokeWidth="4" fill="none" className="animate-pulse" />}{injuryLoc === 'arm' && <circle cx="20" cy="50" r="8" stroke="#ef4444" strokeWidth="4" fill="none" className="animate-pulse" />}{injuryLoc === 'leg' && <circle cx="30" cy="90" r="8" stroke="#ef4444" strokeWidth="4" fill="none" className="animate-pulse" />}</svg>);
        
        const VitalsDisplay = ({ vitals, isTriaged }) => {
            if (!isTriaged) return <div className="text-slate-400 text-[10px] italic text-center py-2 bg-slate-800/20 rounded">Vitals obscured pending triage</div>;
            const getVitalClass = (val, type) => {
                if (type === 'hr') return (val > 120 || val < 50) ? 'vital-red' : (val > 100 ? 'vital-amber' : 'vital-normal');
                if (type === 'sbp') return (val < 90) ? 'vital-red' : (val < 100 ? 'vital-amber' : 'vital-normal');
                if (type === 'rr') return (val > 30 || val < 10) ? 'vital-red' : (val > 22 ? 'vital-amber' : 'vital-normal');
                return 'text-slate-400';
            };
            return ( <div className="grid grid-cols-4 gap-2 text-[12px] font-mono bg-slate-900/50 p-2 rounded border border-slate-700/50"><div className="text-center"><span className="text-slate-500 block text-[9px] uppercase">HR</span><span className={`text-base font-bold ${getVitalClass(vitals.hr, 'hr')}`}>{vitals.hr}</span></div><div className="text-center"><span className="text-slate-500 block text-[9px] uppercase">BP</span><span className={`text-base font-bold ${getVitalClass(vitals.sbp, 'sbp')}`}>{vitals.sbp}</span></div><div className="text-center"><span className="text-slate-500 block text-[9px] uppercase">RR</span><span className={`text-base font-bold ${getVitalClass(vitals.rr, 'rr')}`}>{vitals.rr}</span></div><div className="text-center"><span className="text-slate-500 block text-[9px] uppercase">SpO2</span><span className={`text-base font-bold ${getVitalClass(vitals.spo2, 'spo2')}`}>{vitals.spo2}%</span></div></div> );
        };

        const PatientCard = ({ patient, onSelect, isSelected, onDragStart, isTutorialTarget }) => {
            const needs = getPatientNeeds(patient);
            const getColorClass = (cat) => {
                if (!patient.triaged) return "neutral-bg";
                if(cat === 'P1') return "p1-bg"; if(cat === 'P2') return "p2-bg"; if(cat === 'P3') return "p3-bg"; return "dead-bg";
            };
            const isRevealed = patient.location !== 'amb' || patient.triaged;
            const isPreAlert = patient.location === 'amb' && patient.category === 'P1';
            const isDeteriorating = patient.deteriorating;

            return (
                <div draggable onDragStart={(e) => onDragStart(e, patient.uniqueId)} onClick={(e) => { e.stopPropagation(); onSelect(patient.uniqueId); }} className={`p-2 rounded-md shadow-sm border cursor-pointer mb-2 transition-all relative group ${getColorClass(patient.category)} ${isSelected ? 'ring-4 ring-blue-500 ring-offset-1 scale-105 z-10' : 'hover:scale-[1.02] border-black/10'} ${isTutorialTarget ? 'tutorial-highlight' : ''}`}>
                    <div className="flex justify-between items-start mb-1"><span className="font-black text-slate-900 text-xs truncate w-24">{patient.name}</span>{isRevealed ? ( <span className="px-1.5 bg-white/90 rounded text-[10px] font-black border border-black/10 shadow-sm">{patient.category}</span> ) : ( <span className="px-1.5 bg-gray-200 rounded text-[10px] font-bold text-gray-500">?</span> )}</div>
                    {isRevealed ? ( <div className="text-[9px] leading-tight text-slate-700 h-8 line-clamp-2 mb-1 font-medium">{patient.text}</div> ) : ( <div className="text-[9px] text-slate-500 italic h-8 flex items-center justify-center bg-black/5 rounded mb-1">Awaiting Triage...</div> )}
                    {isPreAlert && !patient.triaged && <div className="absolute top-8 right-2 bg-red-600 text-white text-[9px] font-black px-1.5 py-0.5 rounded shadow-sm prealert-flash z-20 border border-white">PRE-ALERT</div>}
                    {isDeteriorating && <div className="absolute top-10 right-2 text-red-600 animate-bounce"><TrendingUp size={12} /></div>}
                    <div className="flex gap-1 mt-1 border-t border-black/5 pt-1 min-h-[16px]">{needs.map((n, i) => { const Icon = n.icon; return ( <div key={i} className={`rounded-full p-0.5 border ${n.bg} ${n.color} ${n.borderColor}`} title={n.label}><Icon size={10} strokeWidth={2.5} /></div> ); })}{patient.treated && <div className="bg-emerald-100 text-emerald-700 rounded-full p-0.5"><Check size={10} strokeWidth={3} /></div>}</div>
                </div>
            );
        };

        const ZoneDisplay = ({ zone, patients, onSelect, selectedPatientId, onDrop, onZoneClick, activeEvent, isTutorialTarget }) => {
            const zPatients = patients.filter(p => p.location === zone.id);
            const isBlocked = activeEvent?.id === 'ct_overheat' && zone.id === 'ct';
            let cap = zone.capacity;
            if (activeEvent?.id === 'norovirus' && zone.id === 'ward') cap -= 5;
            const percent = Math.min(100, (zPatients.length / cap) * 100);
            let barColor = 'bg-emerald-500';
            if (percent > 50) barColor = 'bg-amber-500';
            if (percent > 80) barColor = 'bg-red-500';
            if (isBlocked) barColor = 'bg-slate-400';

            const handleClick = () => { if (!isBlocked && selectedPatientId && onZoneClick) onZoneClick(zone.id); };
            const isDropTarget = selectedPatientId && !isBlocked;

            return (
                <div onDragOver={e => !isBlocked && e.preventDefault()} onDrop={e => !isBlocked && onDrop(e, zone.id)} onClick={handleClick}
                    className={`bg-white border rounded-lg flex flex-col shadow-sm overflow-hidden zone-card ${isDropTarget ? 'ring-2 ring-emerald-400 ring-opacity-50 animate-pulse' : ''} ${selectedPatientId ? 'dimmed cursor-pointer' : ''} ${isBlocked ? 'opacity-50 pointer-events-none bg-slate-100' : ''} ${isTutorialTarget ? 'tutorial-highlight' : ''} h-full relative`}>
                    {isBlocked && <div className="absolute inset-0 flex items-center justify-center bg-slate-200/80 z-10 font-bold text-slate-500 text-xs uppercase tracking-widest">Out of Order</div>}
                    <div className="px-3 py-1.5 border-b flex justify-between items-center bg-white/50">
                        <span className="font-bold text-[10px] uppercase text-slate-500">{zone.name}</span>
                        <span className={`text-[10px] font-bold px-1.5 rounded ${zPatients.length > cap ? 'bg-red-100 text-red-600' : 'bg-slate-100'}`}>{zPatients.length}/{cap}</span>
                    </div>
                    <div className="h-1.5 w-full bg-slate-100 relative overflow-hidden"><div className={`h-full transition-all duration-500 ${barColor} progress-bar-striped`} style={{ width: `${percent}%` }}></div></div>
                    <div className="p-2 flex-1 overflow-y-auto min-h-[80px]">
                        {zPatients.map(p => ( <PatientCard key={p.uniqueId} patient={p} isSelected={selectedPatientId === p.uniqueId} onSelect={onSelect} onDragStart={(e, id) => e.dataTransfer.setData("patientId", id)} isTutorialTarget={isTutorialTarget && p.uniqueId === 99999} /> ))}
                    </div>
                </div>
            );
        };

        const ActionHUD = ({ patient, role, onAction, onAbility, onClose, resources, time, activeEvent, tutorialStep, isActiveTriage }) => {
            if (!patient) return null;
            const pathway = getCarePathway(patient);
            const needs = getPatientNeeds(patient);
            const triageCost = activeEvent?.id === 'it_failure' ? 2 : 1;
            const canTriage = needs.some(n => n.id === 'triage') && role.canTriage;
            const canScan = needs.some(n => n.id === 'scan') && role.canScan && activeEvent?.id !== 'ct_overheat';
            const canTreat = needs.some(n => n.id === 'treat') && role.canTreat && (!patient.reqSkill || role.skills.includes(patient.reqSkill));
            let mainActionText = "No Action"; let isMainActionEnabled = false; let mainActionColor = "bg-slate-600";
            let highlightAction = false;

            if (canTriage) { 
                mainActionText = `Triage (${triageCost} AP)`; isMainActionEnabled = true; mainActionColor = "bg-blue-600 hover:bg-blue-500"; 
                if(tutorialStep === 4) highlightAction = true;
                if(isActiveTriage) mainActionText = `Assess & Triage (${triageCost} AP)`;
            }
            else if (canScan) { mainActionText = "Perform CT Scan"; isMainActionEnabled = true; mainActionColor = "bg-purple-600 hover:bg-purple-500"; }
            else if (canTreat) { 
                mainActionText = patient.treatmentAction || `Treat (${role.actionText})`; 
                isMainActionEnabled = true; 
                mainActionColor = "bg-emerald-600 hover:bg-emerald-500"; 
                if(tutorialStep === 7) highlightAction = true;
            }
            else if (needs.some(n => n.id === 'scan')) { mainActionText = activeEvent?.id === 'ct_overheat' ? "Scanner Broken" : "Needs CT Scan First"; mainActionColor = "bg-slate-700 text-slate-400"; }
            else if (needs.some(n => n.id === 'treat')) { mainActionText = patient.reqSkill === 'advanced_trauma' ? "Requires Doctor (Trauma)" : "Requires Clinical Role"; mainActionColor = "bg-slate-700 text-slate-400"; }
            else if (patient.treated) { mainActionText = "Patient Stable"; mainActionColor = "bg-emerald-800 text-emerald-200"; }

            return (
                <div className="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-md text-white border-t border-slate-700 shadow-2xl z-50 hud-enter flex flex-col lg:flex-row h-auto lg:h-[280px] max-h-[60vh]">
                    <div className="p-4 flex items-center gap-4 border-b lg:border-b-0 lg:border-r border-slate-700 w-full lg:w-1/3 bg-slate-800/50 shrink-0">
                        <StickFigure injuryLoc={patient.injuryLoc} className="h-16 w-16 lg:h-20 lg:w-20 text-slate-300" />
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1"><span className={`text-xs font-black px-2 py-0.5 rounded text-slate-900 ${patient.triaged ? (patient.category === 'P1' ? 'bg-red-300' : patient.category === 'P2' ? 'bg-amber-300' : 'bg-green-300') : 'bg-gray-200'}`}>{patient.triaged ? patient.category : 'Unknown'}</span><h2 className="text-lg lg:text-xl font-bold truncate">{patient.name}</h2></div>
                            <p className="text-slate-400 text-xs mb-2">{patient.age} {patient.gender} • {patient.triaged ? patient.text : 'Awaiting Triage...'}</p>
                            <VitalsDisplay vitals={patient.vitals} isTriaged={patient.triaged || isActiveTriage} />
                        </div>
                        <button onClick={onClose} className="lg:hidden p-2 text-slate-500 hover:text-white"><X size={20}/></button>
                    </div>
                    <div className="p-4 flex-1 border-b lg:border-b-0 lg:border-r border-slate-700 bg-slate-900/50 overflow-y-auto min-h-[100px] flex flex-col">
                        <div className="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-3">Clinical Pathway</div>
                        <div className="flex flex-col gap-3">
                            {pathway.map((step, idx) => {
                                const isNext = idx < pathway.length - 1;
                                const isActive = step.status === 'current';
                                const isDone = step.status === 'done';
                                const StepIcon = step.icon;
                                return (
                                    <div key={step.id} className={`flex items-center gap-3 ${isActive ? 'opacity-100' : 'opacity-50'}`}>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center border-2 shrink-0 ${isDone ? 'bg-emerald-500 border-emerald-500 text-white' : (isActive ? 'bg-blue-600 border-blue-400 text-white animate-pulse' : 'bg-slate-800 border-slate-600 text-slate-500')}`}>
                                            {isDone ? <Check size={16} strokeWidth={4} /> : <StepIcon size={16} />}
                                        </div>
                                        <div className="flex-1">
                                            <div className={`text-xs font-bold ${isActive ? 'text-white' : 'text-slate-400'}`}>{step.label}</div>
                                            {isActive && <div className="text-[9px] text-blue-300 font-bold uppercase tracking-wider">Required Now</div>}
                                        </div>
                                        {isNext && <div className="h-8 w-0.5 bg-slate-700 absolute left-[2.4rem] mt-8 -z-10"></div>}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    <div className="p-4 w-full lg:w-1/3 flex flex-col gap-2 bg-slate-800/30 shrink-0 justify-center">
                        <div className="flex justify-between items-center text-[10px] text-slate-400 uppercase font-bold mb-1"><span>Role: {role.name}</span><span>AP: {role.currentAp}/{role.ap}</span></div>
                        <button onClick={onAction} disabled={!isMainActionEnabled || role.currentAp < (activeEvent?.id === 'it_failure' && canTriage ? 2 : 1)} className={`flex-1 py-4 rounded-xl font-bold text-sm shadow-lg transition-all flex items-center justify-center gap-2 ${mainActionColor} disabled:opacity-50 disabled:cursor-not-allowed ${highlightAction ? 'tutorial-highlight' : ''}`}>{canTriage && <ClipboardCheck size={18} />}{canScan && <Scan size={18} />}{canTreat && <Stethoscope size={18} />}{mainActionText}{isMainActionEnabled && <span className="bg-black/20 px-1.5 rounded text-[10px]">{activeEvent?.id === 'it_failure' && canTriage ? '2' : '1'} AP</span>}</button>
                        <button onClick={onAbility} disabled={role.abilityCost === 'ALL' ? role.currentAp < 1 : role.currentAp < role.abilityCost} className="py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-xl font-bold text-xs transition-colors flex items-center justify-center gap-2 disabled:opacity-50 border border-slate-600"><ShieldAlert size={16} />{role.ability}: {role.abilityEffect}<span className="bg-black/20 px-1.5 rounded text-[10px]">{role.abilityCost} AP</span></button>
                    </div>
                    <button onClick={onClose} className="absolute top-0 right-0 p-2 text-slate-500 hover:text-white hidden lg:block"><X size={16}/></button>
                </div>
            );
        };

        const EventModal = ({ event, onClose }) => (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden border-l-8 border-amber-500">
                    <div className="p-6">
                        <div className="flex items-center gap-3 mb-4 text-amber-600"><AlertTriangle size={32} /><h2 className="text-2xl font-black uppercase tracking-tight">Incident Update</h2></div>
                        <h3 className="text-xl font-bold text-slate-900 mb-2">{event.title}</h3>
                        <p className="text-slate-600 mb-4">{event.desc}</p>
                        <div className="bg-amber-50 border border-amber-200 p-3 rounded text-sm font-bold text-amber-800">Effect: {event.effect}</div>
                    </div>
                    <button onClick={onClose} className="w-full bg-slate-900 hover:bg-slate-800 text-white py-4 font-bold text-lg transition-colors">ACKNOWLEDGE</button>
                </div>
            </div>
        );

        // --- TRIAGE MITT COMPONENT ---
        const TriageModal = ({ patient, onClose, onConfirm }) => {
            const [step, setStep] = useState(0); // 0: Mobility, 1: Breathing check (implicit), 2: RR, 3: HR
            if (!patient) return null;

            const renderStep = () => {
                // Step 0: Mobility
                if (step === 0) {
                    return (
                        <div className="animate-fadeIn flex flex-col h-full">
                            <div className="flex-1 flex flex-col items-center justify-center">
                                <div className="flex gap-6 mb-6">
                                    <div className={`flex flex-col items-center p-4 rounded-xl border-2 cursor-default ${patient.mobility === 'walking' ? 'bg-green-50 border-green-500' : 'bg-gray-50 border-gray-200 opacity-50'}`}>
                                        <PersonStanding size={64} className={patient.mobility === 'walking' ? 'text-green-600' : 'text-gray-400'} />
                                        <span className="font-bold text-sm mt-2 text-gray-600">Walking</span>
                                    </div>
                                    <div className={`flex flex-col items-center p-4 rounded-xl border-2 cursor-default ${patient.mobility !== 'walking' ? 'bg-red-50 border-red-500' : 'bg-gray-50 border-gray-200 opacity-50'}`}>
                                        <Stretcher size={64} className={patient.mobility !== 'walking' ? 'text-red-600' : 'text-gray-400'} />
                                        <span className="font-bold text-sm mt-2 text-gray-600">Stretcher</span>
                                    </div>
                                </div>
                                <h3 className="text-xl font-black text-slate-900 mb-2 text-center">Mobility Assessment</h3>
                                <p className="text-slate-500 text-center mb-8">Is the patient walking?</p>
                            </div>
                            <div className="grid grid-cols-2 gap-4 shrink-0">
                                <button onClick={() => onConfirm('P3')} className="py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold text-lg shadow-lg flex flex-col items-center justify-center"><span>YES</span><span className="text-xs opacity-80 font-normal">Priority 3</span></button>
                                <button onClick={() => setStep(1)} className="py-4 bg-slate-700 hover:bg-slate-800 text-white rounded-xl font-bold text-lg shadow-lg">NO / UNABLE</button>
                            </div>
                        </div>
                    );
                }
                // Step 1: Respiratory Rate
                if (step === 1) {
                    const rr = patient.vitals.rr;
                    const isP1 = rr < 10 || rr > 29;
                    return (
                        <div className="animate-fadeIn flex flex-col h-full">
                            <div className="flex-1 flex flex-col items-center justify-center">
                                <div className="w-32 h-32 rounded-full bg-white border-4 border-slate-100 shadow-inner flex flex-col items-center justify-center mb-4 relative overflow-hidden">
                                    <div className={`absolute inset-0 opacity-10 ${isP1 ? 'bg-red-500 animate-pulse' : 'bg-blue-500'}`}></div>
                                    <span className="text-4xl font-black text-slate-800">{rr}</span>
                                    <span className="text-[10px] uppercase font-bold text-slate-400">Breaths/min</span>
                                </div>
                                <h3 className="text-xl font-black text-slate-900 mb-2 text-center">Respiratory Assessment</h3>
                                <p className="text-slate-500 text-center max-w-[200px]">Is Respiratory Rate 10-29?</p>
                            </div>
                            <div className="grid grid-cols-2 gap-4 shrink-0">
                                <button onClick={() => setStep(2)} className="py-4 bg-slate-700 hover:bg-slate-800 text-white rounded-xl font-bold text-lg shadow-lg">YES</button>
                                <button onClick={() => onConfirm('P1')} className="py-4 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-lg shadow-lg flex flex-col items-center justify-center"><span>NO</span><span className="text-xs opacity-80 font-normal">Priority 1</span></button>
                            </div>
                        </div>
                    );
                }
                // Step 2: Circulation (HR)
                if (step === 2) {
                    const hr = patient.vitals.hr;
                    const isP1 = hr >= 120;
                    return (
                        <div className="animate-fadeIn flex flex-col h-full">
                            <div className="flex-1 flex flex-col items-center justify-center">
                                <div className="w-32 h-32 rounded-full bg-white border-4 border-slate-100 shadow-inner flex flex-col items-center justify-center mb-4 relative overflow-hidden">
                                    <div className={`absolute inset-0 opacity-10 ${isP1 ? 'bg-red-500 animate-pulse' : 'bg-amber-500'}`}></div>
                                    <span className="text-4xl font-black text-slate-800">{hr}</span>
                                    <span className="text-[10px] uppercase font-bold text-slate-400">Beats/min</span>
                                </div>
                                <h3 className="text-xl font-black text-slate-900 mb-2 text-center">Circulation Assessment</h3>
                                <p className="text-slate-500 text-center max-w-[200px]">Is Heart Rate &lt; 120?</p>
                            </div>
                            <div className="grid grid-cols-2 gap-4 shrink-0">
                                <button onClick={() => onConfirm('P2')} className="py-4 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-lg shadow-lg flex flex-col items-center justify-center"><span>YES</span><span className="text-xs opacity-80 font-normal">Priority 2</span></button>
                                <button onClick={() => onConfirm('P1')} className="py-4 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-lg shadow-lg flex flex-col items-center justify-center"><span>NO</span><span className="text-xs opacity-80 font-normal">Priority 1</span></button>
                            </div>
                        </div>
                    );
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900/90 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm h-[500px] overflow-hidden border border-slate-200 flex flex-col relative">
                        <div className="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                            <div className="flex items-center gap-2">
                                <div className="bg-slate-200 p-1.5 rounded text-slate-600"><ClipboardCheck size={18} /></div>
                                <div>
                                    <h2 className="text-sm font-black text-slate-800 uppercase tracking-wide leading-none">MITT Triage</h2>
                                    <p className="text-[10px] text-slate-500 font-bold">NHS England Protocol</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><X size={20} className="text-slate-400 hover:text-slate-700" /></button>
                        </div>
                        
                        <div className="flex-1 p-6 bg-slate-50/50">
                            {renderStep()}
                        </div>

                        {/* Progress Indicators */}
                        <div className="px-8 py-6 bg-white border-t flex justify-center gap-3">
                            {[0, 1, 2].map(i => (
                                <div key={i} className={`h-1.5 rounded-full transition-all duration-300 ${i === step ? 'w-8 bg-blue-600' : (i < step ? 'w-2 bg-green-500' : 'w-2 bg-slate-200')}`}></div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const SitrepModal = ({ zones, patients, onClose }) => (
            <div className="fixed inset-0 bg-slate-900/90 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full overflow-hidden border border-slate-200 flex flex-col max-h-[90vh]">
                    <div className="bg-slate-800 px-6 py-4 flex justify-between items-center border-b border-slate-700">
                        <div className="flex items-center gap-3">
                            <BarChart2 className="text-blue-400" />
                            <h2 className="text-xl font-bold text-white tracking-wide">Hospital SitRep</h2>
                        </div>
                        <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                    </div>
                    <div className="p-6 overflow-y-auto bg-slate-50 flex-1">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {zones.filter(z => z.type !== 'exit').map(zone => {
                                const count = patients.filter(p => p.location === zone.id).length;
                                const percent = Math.min(100, (count / zone.capacity) * 100);
                                let color = 'bg-emerald-500';
                                if (percent > 50) color = 'bg-amber-500';
                                if (percent > 85) color = 'bg-red-600';
                                
                                return (
                                    <div key={zone.id} className="bg-white p-4 rounded border shadow-sm">
                                        <div className="flex justify-between mb-2">
                                            <span className="font-bold text-slate-700">{zone.name}</span>
                                            <span className={`font-mono font-bold ${percent > 85 ? 'text-red-600' : 'text-slate-500'}`}>{count} / {zone.capacity}</span>
                                        </div>
                                        <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                                            <div className={`h-full ${color}`} style={{width: `${percent}%`}}></div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            </div>
        );

        const GameOver = ({ reason, stats, onRestart, gameOverType }) => {
            const [name, setName] = useState('');
            const isWin = gameOverType === 'win';
            const isAbandoned = gameOverType === 'abandoned';
            
            return (
                <div className="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100] p-4 animate-fade-in text-white">
                    <div className="max-w-lg w-full text-center">
                        <div className={`mb-6 inline-block p-4 rounded-full ${isWin ? 'bg-emerald-600/20 text-emerald-500' : 'bg-red-600/20 text-red-500'}`}>
                            {isWin ? <Award size={64} /> : <ShieldAlert size={64} />}
                        </div>
                        <h1 className={`text-4xl font-black mb-2 tracking-tight ${isWin ? 'text-emerald-500' : 'text-red-500'}`}>
                            {isWin ? 'SHIFT COMPLETE' : (isAbandoned ? 'SHIFT ABANDONED' : 'CRITICAL FAILURE')}
                        </h1>
                        <p className="text-xl text-slate-400 mb-8">{reason}</p>
                        <div className="grid grid-cols-3 gap-4 mb-8">
                            <div className="bg-slate-800 p-4 rounded-xl"><div className="text-sm text-slate-500 uppercase font-bold">Score</div><div className="text-3xl font-black text-blue-400">{stats.score}</div></div>
                            <div className="bg-slate-800 p-4 rounded-xl"><div className="text-sm text-slate-500 uppercase font-bold">Saved</div><div className={`text-3xl font-black ${stats.discharged >= WIN_GOAL ? 'text-emerald-400' : 'text-slate-400'}`}>{stats.discharged}</div></div>
                            <div className="bg-slate-800 p-4 rounded-xl"><div className="text-sm text-slate-500 uppercase font-bold">Deaths</div><div className="text-3xl font-black text-red-400">{stats.deaths}</div></div>
                        </div>
                        
                        {isWin ? (
                            <div className="bg-slate-800 p-6 rounded-xl mb-6 text-left border border-slate-700">
                                <label className="block text-xs font-bold uppercase text-slate-500 mb-2">Enter Name(s) for Certificate</label>
                                <div className="flex gap-2">
                                    <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="e.g., Dr. Smith & Nurse Jones" className="flex-1 bg-slate-900 border border-slate-600 rounded p-3 text-white placeholder-slate-600 focus:outline-none focus:border-blue-500" />
                                    <button onClick={() => generateCertificate(name, stats.score, stats)} disabled={!name} className="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded font-bold transition-colors">Download PDF</button>
                                </div>
                                <p className="text-[10px] text-slate-500 mt-2 italic">Generates certificate mapping to RCEM SLO 6 & SLO 1.</p>
                            </div>
                        ) : (
                            <div className="bg-red-900/20 p-4 rounded-xl mb-6 border border-red-900/50">
                                <p className="text-sm text-red-400 font-bold">Certificate Unavailable</p>
                                <p className="text-xs text-red-300 mt-1 opacity-80">You must discharge at least {WIN_GOAL} patients without critical failures to earn a certificate.</p>
                            </div>
                        )}

                        <button onClick={onRestart} className="bg-white text-slate-900 px-8 py-4 rounded-xl font-bold text-xl hover:scale-105 transition-transform shadow-xl w-full">Initialise New Simulation</button>
                    </div>
                </div>
            );
        };

        const UserGuide = () => (
            <div className="space-y-6">
                <section>
                    <h4 className="font-bold text-blue-800 text-base mb-2 border-b pb-1">1. Core Gameplay Loop</h4>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-xs">
                        <div className="bg-slate-50 p-3 rounded border"><strong className="block mb-1">Turn-Based Action</strong>Each staff member has Action Points (AP). Drag (or tap) patients to move them (1 AP) or click actions in the HUD (1 AP). AP resets every turn.</div>
                        <div className="bg-slate-50 p-3 rounded border"><strong className="block mb-1">Winning & Losing</strong><span className="text-emerald-700 font-bold">WIN:</span> Discharge 10 patients home.<br/><span className="text-red-600 font-bold">LOSE:</span> P1 patients die if left untreated for >1 turn. Ambulance bay overflow ends the game.</div>
                    </div>
                </section>
                <section>
                    <h4 className="font-bold text-blue-800 text-base mb-2 border-b pb-1">2. Mobile Controls</h4>
                    <p className="text-xs mb-2">If you are on a phone or tablet, you can <strong>Tap a Patient</strong> to select them, then <strong>Tap a Zone</strong> to move them there. Drag and drop also works on desktop.</p>
                </section>
                <section>
                    <h4 className="font-bold text-blue-800 text-base mb-2 border-b pb-1">3. Patient Care Pathway</h4>
                    <ol className="list-decimal pl-5 space-y-2 text-xs">
                        <li><strong>Triage:</strong> Use a Nurse or Commander to reveal patient category (P1/P2/P3).</li>
                        <li><strong>Diagnostics (Purple):</strong> Head/Abdo injuries often need a CT Scan. Move to CT Zone -> Use Radiologist to Scan. Treatment is blocked until scanned!</li>
                        <li><strong>Treatment (Green/Blue):</strong> Move to Resus/Majors. Use Doctor/Nurse to treat. P1s consume Blood.</li>
                        <li><strong>Disposition:</strong> Move stable patients to Wards/ICU/Home.</li>
                    </ol>
                </section>
            </div>
        );

        const RoleKey = () => {
            const uniqueRoles = Object.values(ROLE_TEMPLATES);
            return (
                <div className="space-y-2">
                    {uniqueRoles.map(role => {
                        const RoleIcon = role.icon;
                        return (
                            <div key={role.name} className={`flex items-start gap-3 p-3 rounded border ${getColorStyle(role.theme)} bg-white`}>
                                <div className={`p-2 rounded bg-${role.theme}-100 text-${role.theme}-700 shrink-0`}><RoleIcon size={20} /></div>
                                <div className="flex-1">
                                    <div className="flex justify-between items-center mb-1"><h4 className="font-bold text-sm">{role.name}</h4><span className="text-[10px] font-bold uppercase tracking-wider bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">{role.type}</span></div>
                                    <p className="text-xs text-gray-600 mb-2">{role.desc}</p>
                                    <div className="grid grid-cols-2 gap-2 text-[10px]"><div className="bg-gray-50 p-1.5 rounded border"><span className="font-bold block text-gray-500">Primary Action</span>{role.actionText}</div><div className="bg-gray-50 p-1.5 rounded border"><span className="font-bold block text-gray-500">Special Ability ({role.abilityCost} AP)</span>{role.ability}: {role.abilityEffect}</div></div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };
        
        const Modal = ({ title, children, onClose }) => (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden modal-enter border border-gray-200 flex flex-col max-h-[90vh]">
                    <div className="bg-slate-50 px-6 py-4 flex justify-between items-center border-b shrink-0"><h2 className="text-lg font-bold text-slate-800 tracking-wide">{title}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><X size={20} /></button></div>
                    <div className="p-6 overflow-y-auto text-slate-700 text-sm flex-1">{children}</div>
                    <div className="bg-gray-50 px-6 py-4 border-t flex justify-end gap-3 shrink-0"><button onClick={onClose} className="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded font-bold shadow transition-all">Close</button></div>
                </div>
            </div>
        );

        const Counter = ({ label, value, onChange, min, max }) => (
            <div className="flex justify-between items-center bg-slate-50 p-3 rounded border border-slate-200"><span className="text-sm font-bold text-slate-700">{label}</span><div className="flex items-center gap-3"><button type="button" onClick={() => onChange(Math.max(min, value - 1))} disabled={value <= min} className="w-8 h-8 rounded bg-white border flex items-center justify-center hover:bg-slate-100 disabled:opacity-50 text-slate-600 cursor-pointer"><Minus size={16}/></button><span className="w-6 text-center font-bold">{value}</span><button type="button" onClick={() => onChange(Math.min(max, value + 1))} disabled={value >= max} className="w-8 h-8 rounded bg-white border flex items-center justify-center hover:bg-slate-100 disabled:opacity-50 text-slate-600 cursor-pointer"><Plus size={16}/></button></div></div>
        );
        
        const TutorialOverlay = ({ step, children }) => (
             <div className="fixed inset-0 pointer-events-none z-[60] flex items-center justify-center bg-black/20">
                 <div className="bg-white p-6 rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.5)] max-w-md text-center border-4 border-yellow-400 pointer-events-auto animate-bounce transform -translate-y-12">
                     <div className="flex items-center justify-center gap-2 mb-2 text-yellow-600 font-black uppercase tracking-wide text-sm"><Lightbulb size={20} /> Tutorial Step {step}/9</div>
                     <div className="text-slate-900 font-bold text-lg leading-tight">{children}</div>
                 </div>
             </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [gameState, setGameState] = useState('start');
            const [playerCount, setPlayerCount] = useState(1);
            const [staffCounts, setStaffCounts] = useState({ senior: 1, resident: 2, nurse: 3 });
            const [isPrefilled, setIsPrefilled] = useState(false);
            const [isActiveTriageMode, setIsActiveTriageMode] = useState(false); 
            const [triageTarget, setTriageTarget] = useState(null); 
            const [turn, setTurn] = useState(1);
            const [score, setScore] = useState(100);
            const [deaths, setDeaths] = useState(0);
            const [discharged, setDischarged] = useState(0);
            const [roleStates, setRoleStates] = useState([]);
            const [currentRoleId, setCurrentRoleId] = useState(null);
            const [patients, setPatients] = useState([]);
            const [resources, setResources] = useState({ blood: 20, vents: 8 });
            const [simTime, setSimTime] = useState(12 * 60);
            const [selectedPatientId, setSelectedPatientId] = useState(null);
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [modalContent, setModalContent] = useState(null);
            const [activeEvent, setActiveEvent] = useState(null);
            const [historyStack, setHistoryStack] = useState([]);
            const [selectedScenario, setSelectedScenario] = useState('standard');
            const [isMuted, setIsMuted] = useState(false);
            const [tutorialStep, setTutorialStep] = useState(0); 
            const [toasts, setToasts] = useState([]);
            const [gameOverType, setGameOverType] = useState(null); // 'win', 'lose', 'abandoned'

            // Audio wrapper using state
            const playAudio = (type) => { if (!isMuted) playSound(type); };
            const formatTime = (mins) => { const h = Math.floor(mins/60); const m = mins%60; return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; };
            const currentRole = roleStates.find(r => r.id === currentRoleId);
            const selectedPatient = patients.find(p => p.uniqueId === selectedPatientId);

            // Toast System
            const addToast = (msg, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                if(type === 'error') playAudio('error');
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

            // Load Save
            useEffect(() => {
                const saved = localStorage.getItem('wmebem_save');
                if (saved) { try { JSON.parse(saved); } catch(e) { console.error("Save load error", e); } }
            }, []);

            const saveGame = () => {
                const data = { gameState, playerCount, staffCounts, turn, score, deaths, discharged, roleStates, currentRoleId, patients, resources, simTime, selectedScenario, isMuted };
                localStorage.setItem('wmebem_save', JSON.stringify(data));
            };

            const loadGame = () => {
                const saved = localStorage.getItem('wmebem_save');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        setGameState(data.gameState); setPlayerCount(data.playerCount); setStaffCounts(data.staffCounts); setTurn(data.turn);
                        setScore(data.score); setDeaths(data.deaths); setDischarged(data.discharged); setRoleStates(data.roleStates);
                        setCurrentRoleId(data.currentRoleId); setPatients(data.patients); setResources(data.resources); setSimTime(data.simTime);
                        if(data.selectedScenario) setSelectedScenario(data.selectedScenario);
                        if(data.isMuted !== undefined) setIsMuted(data.isMuted);
                    } catch(e) { console.error("Load error", e); }
                }
            };

            useEffect(() => { if (gameState === 'playing') saveGame(); }, [turn, patients, roleStates, score]);

            // Tutorial Logic Hook
            useEffect(() => {
                if (tutorialStep === 0) return;
                if (tutorialStep === 1 && currentRole?.id === 'nurse_ic') setTutorialStep(2);
                if (tutorialStep === 2 && selectedPatientId) setTutorialStep(3);
                if (tutorialStep === 6 && currentRole?.id?.startsWith('nurse_staff')) setTutorialStep(7);
                if (tutorialStep === 9) {
                    setTimeout(() => {
                        addToast("Tutorial Complete! You are ready to command.", 'success');
                        setTutorialStep(0);
                    }, 1000);
                }
            }, [currentRole, selectedPatientId, patients, tutorialStep]);


            const pushHistory = () => {
                const snapshot = JSON.stringify({ roleStates, patients, resources, score, deaths, discharged, simTime, turn, activeEvent });
                setHistoryStack(prev => [...prev.slice(-9), snapshot]);
            };

            const handleUndo = () => {
                if (historyStack.length === 0) return;
                try {
                    const prev = JSON.parse(historyStack[historyStack.length - 1]);
                    setRoleStates(prev.roleStates); setPatients(prev.patients); setResources(prev.resources);
                    setScore(prev.score); setDeaths(prev.deaths); setDischarged(prev.discharged);
                    setSimTime(prev.simTime); setTurn(prev.turn); setActiveEvent(prev.activeEvent);
                    setHistoryStack(prev => prev.slice(0, -1));
                    setSelectedPatientId(null);
                    addToast("Action Undone", "info");
                } catch(e) { console.error("Undo error", e); }
            };

            // Triage Handlers
            const performTriage = (patient, isCorrect, isManual) => {
                const triageCost = activeEvent?.id === 'it_failure' ? 2 : 1;
                if (currentRole.currentAp < triageCost) return;
                
                let logMsg = `Triaged (${currentRole.name})`;
                if (isManual) {
                    if (isCorrect) {
                         setScore(s => s + 5); // Bonus
                         logMsg += " - Correctly Identified";
                         addToast("Correct Triage! (+5 Score)", 'success');
                    } else {
                         setScore(s => s - 5); // Penalty
                         logMsg += ` - Incorrect (True: ${patient.category})`;
                         addToast(`Incorrect! Patient is ${patient.category} (-5 Score)`, 'error');
                    }
                }

                setPatients(prev => prev.map(p => p.uniqueId === patient.uniqueId ? addHistory({ ...p, triaged: true }, logMsg) : p));
                setRoleStates(prev => prev.map(r => r.id === currentRoleId ? { ...r, currentAp: r.currentAp - triageCost } : r));
                
                if(tutorialStep === 4) setTutorialStep(5);
            };

            const handleTriageConfirm = (selectedCategory) => {
                if (!triageTarget) return;
                const isCorrect = selectedCategory === triageTarget.category;
                performTriage(triageTarget, isCorrect, true);
                setTriageTarget(null);
            };

            // --- GAME LOGIC ---
            const NAMES = ["Smith", "Jones", "Taylor", "Brown", "Williams", "Wilson", "Johnson", "Davies"];
            const MALE = ["James", "John", "Robert", "Michael"]; const FEMALE = ["Mary", "Patricia", "Jennifer", "Linda"];
            const PATIENT_TEMPLATES = {
                standard: [
                    { category: 'P1', injuryLoc: 'chest', text: 'GSW Chest. Needs Thoracotomy.', reqSkill: 'advanced_trauma', treatmentAction: 'Thoracotomy & Chest Drain', vitals: { hr: 140, sbp: 70, rr: 32, spo2: 88 } },
                    { category: 'P1', injuryLoc: 'abdo', text: 'Blast Abdomen. Rigid.', reqSkill: 'advanced_trauma', treatmentAction: 'TXA & Haemostatics', vitals: { hr: 130, sbp: 85, rr: 24, spo2: 94 } },
                    { category: 'P2', injuryLoc: 'head', text: 'TBI. Asymmetric pupils.', reqSkill: 'advanced_trauma', treatmentAction: 'RSI & Neuroprotection', vitals: { hr: 60, sbp: 160, rr: 12, spo2: 96 } },
                    { category: 'P2', injuryLoc: 'leg', text: 'Femur Fracture (Open).', reqSkill: 'advanced_trauma', treatmentAction: 'Splint, Dress & Antibiotics', vitals: { hr: 110, sbp: 110, rr: 20, spo2: 98 } },
                    { category: 'P3', injuryLoc: 'arm', text: 'Deep Laceration.', reqSkill: 'care', treatmentAction: 'Suture & Dress', vitals: { hr: 80, sbp: 120, rr: 14, spo2: 99 } },
                    { category: 'P3', injuryLoc: 'head', text: 'Mild Concussion.', reqSkill: 'care', treatmentAction: 'Neuro Obs & Analgesia', vitals: { hr: 76, sbp: 118, rr: 14, spo2: 100 } },
                ],
                chem: [
                    { category: 'P1', injuryLoc: 'head', text: 'Nerve Agent. Pinpoint pupils.', reqSkill: 'advanced_trauma', treatmentAction: 'Atropine & Oxime', vitals: { hr: 45, sbp: 90, rr: 30, spo2: 85 } },
                    { category: 'P1', injuryLoc: 'chest', text: 'Chlorine Gas Inhalation.', reqSkill: 'advanced_trauma', treatmentAction: 'Nebulisers & Oxygen', vitals: { hr: 120, sbp: 100, rr: 40, spo2: 82 } },
                ],
                crush: [
                    { category: 'P1', injuryLoc: 'leg', text: 'Crush Injury. Compartment Syndrome.', reqSkill: 'advanced_trauma', treatmentAction: 'Fluids & Bicarb', vitals: { hr: 110, sbp: 100, rr: 20, spo2: 96 } },
                    { category: 'P2', injuryLoc: 'chest', text: 'Dust Inhalation. Wheezy.', reqSkill: 'care', treatmentAction: 'Nebulisers & Steroids', vitals: { hr: 90, sbp: 120, rr: 24, spo2: 92 } },
                ],
                // Tutorial specific
                tutorial: [
                    { category: 'P3', injuryLoc: 'arm', text: 'Deep Laceration.', reqSkill: 'care', treatmentAction: 'Suture & Dress', vitals: { hr: 80, sbp: 120, rr: 14, spo2: 99 } }
                ]
            };
            const addHistory = (patient, msg) => ({ ...patient, history: [{ time: formatTime(simTime), msg }, ...(patient.history || [])] });
            
            const createPatient = (template, timeStr, overrideProps = {}) => {
                const isMale = Math.random() > 0.5;
                const gender = isMale ? 'M' : 'F';
                const name = `${(isMale ? MALE : FEMALE)[Math.floor(Math.random() * 4)]} ${NAMES[Math.floor(Math.random() * NAMES.length)]}`;
                
                // Enforce MITT Logic: P3 = Walking, P1/P2 = Stretcher
                let mobility = 'stretcher';
                if (template.category === 'P3') mobility = 'walking';
                if (overrideProps.category === 'P3') mobility = 'walking';
                
                return { 
                    ...template, 
                    name, 
                    age: Math.floor(Math.random()*60)+18+'y', 
                    gender, 
                    uniqueId: overrideProps.id || Date.now() + Math.random(), 
                    location: 'amb', 
                    triaged: false, 
                    treated: false, 
                    scanned: false, 
                    deteriorating: false,
                    mobility, 
                    history: [{ time: timeStr, msg: 'Arrived via Ambulance' }], 
                    ...overrideProps 
                };
            };

            const spawnPatients = (count, currentSimTime) => {
                const scenarioConfig = SCENARIOS[selectedScenario];
                const newP = Array(count).fill(0).map(() => {
                    const r = Math.random();
                    let cat = 'P3';
                    if (r < scenarioConfig.p1) cat = 'P1';
                    else if (r < scenarioConfig.p1 + scenarioConfig.p2) cat = 'P2';

                    let pool = PATIENT_TEMPLATES.standard;
                    if (scenarioConfig.type === 'chem' && Math.random() > 0.3) pool = PATIENT_TEMPLATES.chem;
                    if (scenarioConfig.type === 'crush' && Math.random() > 0.3) pool = PATIENT_TEMPLATES.crush;
                    
                    let options = pool.filter(p => p.category === cat);
                    if (options.length === 0) options = pool; 
                    const base = options[Math.floor(Math.random() * options.length)];
                    return createPatient(base, formatTime(currentSimTime), { category: cat });
                });
                setPatients(prev => [...prev, ...newP]);
                playAudio('ping');
            };

            const generatePrefillPatients = (timeStr) => {
                const prefill = [];
                const add = (zone, count, treated) => {
                    for(let i=0; i<count; i++) {
                        const base = PATIENT_TEMPLATES.standard[Math.floor(Math.random() * PATIENT_TEMPLATES.standard.length)];
                        prefill.push(createPatient(base, timeStr, { location: zone, triaged: true, treated: treated, history: [{ time: "08:00", msg: "Handover: Patient in department" }] }));
                    }
                };
                add('resus', 1, false); add('majors', 4, false); add('minors', 5, true); add('ward', 15, true); add('icu', 3, true);
                return prefill;
            };

            const deterioratePatients = (patientList) => {
                return patientList.map(p => {
                    // Only deteriorate untreated P1/P2 patients
                    if (p.treated || p.category === 'P3' || ['discharged','morgue'].includes(p.location)) return p;
                    
                    // 30% chance to deteriorate each turn
                    if (Math.random() > 0.7) {
                        const newVitals = { ...p.vitals };
                        // Deterioration logic: HR goes up, BP goes down
                        newVitals.hr += Math.floor(Math.random() * 15) + 5;
                        newVitals.sbp -= Math.floor(Math.random() * 10) + 5;
                        return { 
                            ...p, 
                            vitals: newVitals, 
                            deteriorating: true,
                            // Check if they die from vitals (HR > 180 or SBP < 50)
                            location: (newVitals.hr > 180 || newVitals.sbp < 50) ? 'morgue' : p.location
                        };
                    }
                    return p;
                });
            };

            const startTutorial = () => {
                initAudio();
                setActiveEvent(null); setIsActiveTriageMode(false); setTurn(1); setScore(100); setDeaths(0); setDischarged(0);
                const generatedRoles = generateRoster({ senior: 0, resident: 0, nurse: 1 });
                setRoleStates(generatedRoles.map(r => ({ ...r, currentAp: 20, ap: 20, disabled: false })));
                setCurrentRoleId('bronze_cmd');
                const tutPatient = createPatient(PATIENT_TEMPLATES.tutorial[0], "12:00", { id: 99999 });
                setPatients([tutPatient]);
                setGameState('playing');
                setTutorialStep(1);
                localStorage.removeItem('wmebem_save');
                addToast("Tutorial Started", "info");
            };

            const startGame = () => {
                try {
                    initAudio();
                    const generatedRoles = generateRoster(staffCounts);
                    setRoleStates(generatedRoles.map(r => ({ ...r, currentAp: r.ap, disabled: false })));
                    setCurrentRoleId(generatedRoles[0].id);
                    const initialTime = 12 * 60;
                    const incidentPatients = [];
                    const scenarioConfig = SCENARIOS[selectedScenario];
                    for(let i=0; i<6; i++) {
                        const r = Math.random();
                        let cat = 'P3';
                        if (r < scenarioConfig.p1) cat = 'P1';
                        else if (r < scenarioConfig.p1 + scenarioConfig.p2) cat = 'P2';
                        let pool = PATIENT_TEMPLATES.standard;
                        if (scenarioConfig.type === 'chem' && Math.random() > 0.3) pool = PATIENT_TEMPLATES.chem;
                        if (scenarioConfig.type === 'crush' && Math.random() > 0.3) pool = PATIENT_TEMPLATES.crush;
                        let options = pool.filter(p => p.category === cat);
                        if (options.length === 0) options = pool;
                        const base = options[Math.floor(Math.random() * options.length)];
                        incidentPatients.push(createPatient(base, formatTime(initialTime), { category: cat }));
                    }
                    if (isPrefilled) { const prefilled = generatePrefillPatients(formatTime(initialTime)); setPatients([...prefilled, ...incidentPatients]); } 
                    else { setPatients(incidentPatients); }
                    setGameState('playing');
                    localStorage.removeItem('wmebem_save');
                } catch(e) { console.error("Start game error", e); }
            };

            const checkGameOver = (currentPatients, currentDeaths) => {
                if (currentDeaths > 0) { setGameOverType('lose'); return "A P1 patient has died due to delayed treatment."; }
                if (currentPatients.filter(p => p.location === 'amb').length > 12) { setGameOverType('lose'); return "Ambulance Bay Overflow. The department has collapsed."; }
                // Check vital-based deaths
                if (currentPatients.some(p => p.location === 'morgue' && !p.history.some(h => h.msg.includes("DIED")))) {
                     setGameOverType('lose'); return "Patient died from physiological deterioration.";
                }
                return null;
            };

            const triggerEvent = () => {
                if (Math.random() > 0.7) {
                    const event = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];
                    setActiveEvent(event);
                    playAudio('alert');
                    if (event.id === 'needlestick') { setRoleStates(prev => { const nurses = prev.filter(r => r.id.startsWith('nurse_staff')); if (nurses.length > 0) { const target = nurses[Math.floor(Math.random() * nurses.length)]; return prev.map(r => r.id === target.id ? { ...r, disabled: true, currentAp: 0 } : r); } return prev; }); } 
                    else if (event.id === 'med_student') { setRoleStates(prev => prev.map(r => r.id.startsWith('senior_doc') ? { ...r, currentAp: r.currentAp + 2 } : r)); } 
                    else if (event.id === 'rapid_offload') { spawnPatients(3, simTime); }
                } else { setActiveEvent(null); }
            };

            const nextTurn = () => {
                pushHistory();
                // Deteriorate first
                let nextPatients = deterioratePatients(patients);
                
                const failure = checkGameOver(nextPatients, deaths);
                if (failure) { setPatients(nextPatients); setGameState('gameover'); setModalContent(failure); return; }
                
                setTurn(t => t + 1);
                const newTime = simTime + 15; setSimTime(newTime);
                setRoleStates(prev => prev.map(r => ({ ...r, currentAp: r.ap, disabled: false })));
                triggerEvent();
                
                // Spawn Logic
                const scenarioConfig = SCENARIOS[selectedScenario];
                const newP = Array(Math.floor(Math.random() * 3) + 1).fill(0).map(() => {
                    const r = Math.random();
                    let cat = 'P3';
                    if (r < scenarioConfig.p1) cat = 'P1';
                    else if (r < scenarioConfig.p1 + scenarioConfig.p2) cat = 'P2';
                    let pool = PATIENT_TEMPLATES.standard;
                    if (scenarioConfig.type === 'chem' && Math.random() > 0.3) pool = PATIENT_TEMPLATES.chem;
                    if (scenarioConfig.type === 'crush' && Math.random() > 0.3) pool = PATIENT_TEMPLATES.crush;
                    let options = pool.filter(p => p.category === cat);
                    if (options.length === 0) options = pool; 
                    const base = options[Math.floor(Math.random() * options.length)];
                    return createPatient(base, formatTime(newTime), { category: cat });
                });
                nextPatients = [...nextPatients, ...newP];
                playAudio('ping');

                setPatients(nextPatients.map(p => {
                    if(p.category === 'P1' && !p.treated && !['morgue','discharged'].includes(p.location)) {
                        const turnsWaiting = (p.turnsWaiting || 0) + 1;
                        if(turnsWaiting > 1) { 
                            playAudio('flatline'); setDeaths(d => d + 1); setGameState('gameover'); setModalContent("A P1 patient has died due to delayed treatment."); setGameOverType('lose');
                            return addHistory({ ...p, location: 'morgue' }, "DIED: Treatment delay"); 
                        }
                        return { ...p, turnsWaiting };
                    }
                    return p;
                }));
            };

            const deductAp = (cost) => { setRoleStates(prev => prev.map(r => r.id === currentRoleId ? { ...r, currentAp: r.currentAp - cost } : r)); };

            const handleAction = () => {
                if(!selectedPatient || !currentRole || currentRole.disabled) return;
                pushHistory();
                const triageCost = activeEvent?.id === 'it_failure' ? 2 : 1;
                if(getPatientNeeds(selectedPatient).some(n=>n.id==='triage') && currentRole.canTriage) {
                    if (selectedPatient.location === 'amb') { addToast("Move to Triage Bay to assess", "warning"); return; }
                    if (currentRole.currentAp < triageCost) { addToast("Not enough AP!", "error"); return; }
                    if (isActiveTriageMode && !selectedPatient.triaged) { setTriageTarget(selectedPatient); return; }
                    performTriage(selectedPatient, true, false);
                } else if (getPatientNeeds(selectedPatient).some(n=>n.id==='scan') && currentRole.canScan) {
                    if (activeEvent?.id === 'ct_overheat') { addToast("Scanner is broken!", "error"); return; }
                    if (selectedPatient.location !== 'ct') { addToast("Patient must be in CT Zone", "warning"); return; }
                    setPatients(prev => prev.map(p => p.uniqueId === selectedPatientId ? addHistory({ ...p, scanned: true }, "CT Scan Completed") : p));
                    deductAp(1);
                    addToast("Scan Completed", "success");
                } else if (getPatientNeeds(selectedPatient).some(n=>n.id==='treat') && currentRole.canTreat) {
                    if (selectedPatient.reqSkill === 'advanced_trauma' && !currentRole.skills.includes('advanced_trauma')) { addToast("Requires Senior Doctor skill", "error"); return; }
                    if ((selectedPatient.injuryLoc==='head'||selectedPatient.injuryLoc==='abdo') && !selectedPatient.scanned) { addToast("Patient requires CT Scan first", "warning"); return; }
                    if (selectedPatient.category === 'P1') {
                        if (resources.blood < 1) { addToast("Insufficient Blood Supply", "error"); return; }
                        setResources(p => ({...p, blood: p.blood - 1}));
                    }
                    setPatients(prev => prev.map(p => p.uniqueId === selectedPatientId ? addHistory({ ...p, treated: true, deteriorating: false }, selectedPatient.treatmentAction || "Treatment Administered") : p));
                    playAudio('treat');
                    addToast("Treatment Administered", "success");
                    deductAp(1); setScore(s => s + 10);
                    if(tutorialStep === 7) setTutorialStep(8);
                }
            };

            const handleAbility = () => {
                if(!currentRole || currentRole.disabled) return;
                
                if (roleStates.find(r => r.id === currentRoleId).ability === 'Rapid Offload') {
                    if (currentRole.currentAp < 1) { addToast("Requires at least 1 AP", "error"); return; }
                    const ambPatients = patients.filter(p => p.location === 'amb');
                    if (ambPatients.length === 0) { addToast("Ambulance Bay Empty", "info"); return; }
                    const triageZone = ZONES.find(z => z.id === 'triage');
                    const currentTriageCount = patients.filter(p => p.location === 'triage').length;
                    const spaces = triageZone.capacity - currentTriageCount;
                    if (spaces <= 0) { addToast("Triage Bay Full!", "error"); return; }
                    
                    const toMove = ambPatients.slice(0, spaces);
                    pushHistory();
                    setPatients(prev => prev.map(p => {
                        if (toMove.find(tm => tm.uniqueId === p.uniqueId)) {
                            return addHistory({ ...p, location: 'triage', triaged: true }, "Rapid MITT Assessment");
                        }
                        return p;
                    }));
                    deductAp(currentRole.currentAp);
                    playAudio('move');
                    addToast(`Rapidly Offloaded ${toMove.length} patients`, "success");
                    return;
                }

                if(currentRole.currentAp < currentRole.abilityCost) return;
                pushHistory();
                deductAp(currentRole.abilityCost);
                if(currentRole.id === 'bronze_cmd') { setResources(prev => ({ ...prev, blood: prev.blood + 2, vents: prev.vents + 1 })); addToast("Resources Replenished", "success"); } 
                else if(currentRole.id.startsWith('senior_doc')) { setPatients(prev => prev.map(p => p.location === 'amb' ? addHistory({...p, triaged: true}, `Rapid Triage by Senior Doc`) : p)); addToast("Rapid Triage Complete", "info"); }
                else if(currentRole.id === 'nurse_ic') { setPatients(prev => prev.map(p => p.location === 'triage' ? addHistory({...p, triaged: true}, `Team Huddle Triage`) : p)); addToast("Triage Huddle Complete", "info"); }
                else if(currentRole.id.startsWith('nurse_staff')) {
                    const p3 = patients.find(p => p.category === 'P3' && p.location === 'amb');
                    if(p3) { setPatients(prev => prev.map(p => p.uniqueId === p3.uniqueId ? addHistory({ ...p, location: 'minors', triaged: true }, "Streamed to Minors") : p)); addToast("Patient streamed to Minors", "success"); }
                    else { addToast("No P3 patients in Ambulance Bay", "warning"); }
                }
                else if(currentRole.id.startsWith('resident')) {
                    const p3 = patients.find(p => p.category === 'P3' && !p.treated && p.location === 'minors');
                    if(p3) { setPatients(prev => prev.map(p => p.uniqueId === p3.uniqueId ? addHistory({ ...p, treated: true }, "Fast Track Treatment") : p)); playAudio('treat'); addToast("Fast Track Treatment Complete", "success"); }
                }
                else if(currentRole.id === 'radiology') {
                    const target = patients.find(p => (p.location === 'resus' || p.location === 'majors') && !p.treated && !p.scanned);
                    if(target) { setPatients(prev => prev.map(p => p.uniqueId === target.uniqueId ? addHistory({ ...p, location: 'ct' }, "Rapid Scan Transfer") : p)); addToast("Patient moved to CT", "info"); }
                }
                else if(currentRole.id === 'bed_manager') {
                    const target = patients.find(p => p.location === 'ward');
                    if(target) { 
                        setPatients(prev => prev.map(p => p.uniqueId === target.uniqueId ? addHistory({ ...p, location: 'discharged' }, "Forced Discharge") : p)); 
                        setDischarged(d => d + 1); 
                        if(target.treated) { setScore(s => s + 20); addToast("Discharge Successful", "success"); } else { setScore(s => s - 20); addToast("Unsafe Discharge (-20)", "error"); }
                    }
                }
            };

            const handleDrop = (e, zoneId) => {
                e.preventDefault();
                const pid = Number(e.dataTransfer.getData("patientId"));
                const p = patients.find(pt => pt.uniqueId === pid);
                if (activeEvent?.id === 'ct_overheat' && zoneId === 'ct') { addToast("CT Scanner is broken!", "error"); return; }
                if(p && currentRole.currentAp > 0 && !currentRole.disabled && p.location !== zoneId) {
                    pushHistory();
                    const zoneName = ZONES.find(z => z.id === zoneId)?.name || zoneId;
                    setPatients(prev => prev.map(pt => pt.uniqueId === pid ? addHistory({ ...pt, location: zoneId }, `Moved to ${zoneName}`) : pt));
                    deductAp(1); setSelectedPatientId(pid); playAudio('move');
                    if(tutorialStep === 3 && zoneId === 'triage') setTutorialStep(4);
                    if(tutorialStep === 5 && zoneId === 'minors') setTutorialStep(6);
                    if(tutorialStep === 8 && zoneId === 'discharged') setTutorialStep(9);
                } else if (currentRole.currentAp <= 0) {
                     addToast("No Action Points remaining!", "error");
                }
            };
            const handleZoneClick = (zoneId) => { if (selectedPatientId) handleDrop({preventDefault:()=>{}, dataTransfer:{getData:()=>selectedPatientId}}, zoneId); };

            // End Shift / Success Logic
            const handleEndShift = () => {
                if (discharged >= WIN_GOAL) {
                    setModalContent("Shift Ended Successfully");
                    setGameOverType('win');
                } else {
                    setModalContent("Shift Ended Early - Goals Not Met");
                    setGameOverType('abandoned');
                }
                setGameState('gameover');
            };

            if (gameState === 'start') {
                const hasSave = localStorage.getItem('wmebem_save');
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border-t-8 border-blue-800">
                            <img src={LOGO_URL} className="h-24 mx-auto mb-6 object-contain" />
                            <h1 className="text-3xl font-black text-slate-900 mb-2 tracking-tight">INCIDENT<span className="text-blue-600">COMMAND</span></h1>
                            <p className="text-slate-500 mb-6 font-medium">WMEBEM Digital Simulation</p>
                            <div className="mb-6 space-y-4 text-left">
                                {hasSave && <button type="button" onClick={loadGame} className="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold mb-4 cursor-pointer">Resume Simulation</button>}
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide text-center">Scenario Selection</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {Object.entries(SCENARIOS).map(([key, val]) => (
                                            <button type="button" key={key} onClick={() => setSelectedScenario(key)} className={`p-2 rounded border text-xs font-bold cursor-pointer ${selectedScenario === key ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>{val.name}</button>
                                        ))}
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1 text-center italic">{SCENARIOS[selectedScenario].desc}</p>
                                </div>
                                <div className="border-t pt-4">
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-sm font-bold text-gray-700 uppercase tracking-wide">Pre-fill Dept</label>
                                        <button type="button" onClick={()=>setIsPrefilled(!isPrefilled)} className={`w-12 h-6 rounded-full p-1 transition-colors cursor-pointer ${isPrefilled ? 'bg-blue-600' : 'bg-gray-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${isPrefilled ? 'translate-x-6' : ''}`}></div></button>
                                    </div>
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-sm font-bold text-gray-700 uppercase tracking-wide">Active Triage</label>
                                        <button type="button" onClick={()=>setIsActiveTriageMode(!isActiveTriageMode)} className={`w-12 h-6 rounded-full p-1 transition-colors cursor-pointer ${isActiveTriageMode ? 'bg-blue-600' : 'bg-gray-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${isActiveTriageMode ? 'translate-x-6' : ''}`}></div></button>
                                    </div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide text-center mt-4">Staff & Players</label>
                                    <div className="flex flex-wrap justify-center gap-2 mb-2">{[1, 2, 3, 4, 5, 6, 7, 8].map(num => ( <button type="button" key={num} onClick={() => setPlayerCount(num)} className={`w-8 h-8 rounded font-bold text-sm transition-all cursor-pointer ${playerCount === num ? 'bg-blue-600 text-white scale-110 shadow' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{num}</button> ))}</div>
                                    <div className="space-y-2">
                                        <Counter label="Senior Docs" value={staffCounts.senior} onChange={(v)=>setStaffCounts({...staffCounts, senior: v})} min={1} max={3} />
                                        <Counter label="Residents" value={staffCounts.resident} onChange={(v)=>setStaffCounts({...staffCounts, resident: v})} min={1} max={6} />
                                        <Counter label="Nurses" value={staffCounts.nurse} onChange={(v)=>setStaffCounts({...staffCounts, nurse: v})} min={1} max={8} />
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-col gap-3">
                                <button type="button" onClick={startGame} className="w-full py-4 bg-blue-700 hover:bg-blue-800 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all transform active:scale-95 cursor-pointer">Initialise New Incident</button>
                                <button type="button" onClick={startTutorial} className="w-full py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl font-bold text-md shadow transition-all cursor-pointer">Play Tutorial</button>
                            </div>
                            <div className="mt-4 text-xs text-slate-400">Version 7.4 • WMEBEM</div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'gameover') return <GameOver reason={modalContent} stats={{score, discharged, deaths}} onRestart={() => setGameState('start')} gameOverType={gameOverType} />;

            return (
                <div className="h-screen flex flex-col bg-slate-100 text-slate-800 font-sans overflow-hidden">
                    <ToastContainer toasts={toasts} removeToast={removeToast} />
                    {tutorialStep > 0 && (
                        <TutorialOverlay step={tutorialStep}>
                            {tutorialStep === 1 && "Select the **Nurse In Charge** from the staff list on the left."}
                            {tutorialStep === 2 && "Great! Now tap the **Patient** in the Ambulance Bay to select them."}
                            {tutorialStep === 3 && "We don't know how sick they are. Move them to the **Triage** zone."}
                            {tutorialStep === 4 && "Now they are in Triage. Tap the **Triage Action** button below to assess them."}
                            {tutorialStep === 5 && "They are P3 (Green). They need minor treatment. Move them to **Minors**."}
                            {tutorialStep === 6 && "They need care, not a doctor. Select an **ED Nurse** from the staff list."}
                            {tutorialStep === 7 && "Now tap the **Treat** button to suture their wound."}
                            {tutorialStep === 8 && "They are stable! Move them to **Home** to discharge them."}
                            {tutorialStep === 9 && "Tutorial Complete! You scored points and saved a patient."}
                        </TutorialOverlay>
                    )}
                    <div className="h-14 bg-white border-b px-4 flex items-center justify-between shrink-0 z-20 relative shadow-sm">
                        <div className="flex items-center gap-3"><img src={LOGO_URL} className="logo-h" /><span className="font-bold text-sm hidden sm:inline">Turn {turn} ({formatTime(simTime)})</span></div>
                        <div className="flex items-center gap-4 font-bold text-sm">
                             <div className="flex gap-2 items-center">
                                 <div className="bg-slate-100 px-2 py-1 rounded text-xs border border-slate-200 text-slate-600 hidden lg:block">Goal: <span className={discharged >= WIN_GOAL ? 'text-emerald-600 font-black' : 'text-slate-900'}>{discharged} / {WIN_GOAL}</span></div>
                                 <button type="button" onClick={() => setModalContent('sitrep')} className="hidden lg:flex text-xs font-bold text-blue-600 hover:text-blue-800 items-center gap-1 px-3 py-1 rounded hover:bg-blue-50 transition-colors cursor-pointer"><BarChart2 size={16} /> SitRep</button>
                                 <button type="button" onClick={() => setIsMuted(!isMuted)} className="text-slate-500 hover:text-slate-800 p-1 cursor-pointer">{isMuted ? <VolumeX size={18} /> : <Volume2 size={18} />}</button>
                                 <button type="button" onClick={() => setSidebarOpen(!isSidebarOpen)} className="lg:hidden text-xs font-bold text-slate-600 hover:text-slate-800 flex items-center gap-1 px-2 py-1 rounded bg-slate-100 cursor-pointer"><Menu size={16} /> Menu</button>
                                 <button type="button" onClick={() => setModalContent('guide')} className="hidden lg:flex text-xs font-bold text-blue-600 hover:text-blue-800 items-center gap-1 px-3 py-1 rounded hover:bg-blue-50 transition-colors cursor-pointer"><BookOpen size={16} /> Guide</button>
                                 <button type="button" onClick={() => setModalContent('roles')} className="hidden lg:flex text-xs font-bold text-purple-600 hover:text-purple-800 items-center gap-1 px-3 py-1 rounded hover:bg-purple-50 transition-colors cursor-pointer"><BadgeInfo size={16} /> Roles</button>
                             </div>
                            <div className="h-6 w-px bg-gray-200 hidden sm:block"></div>
                            <button type="button" onClick={handleEndShift} className={`flex items-center gap-1 px-3 py-1 rounded text-xs font-bold cursor-pointer transition-colors ${discharged >= WIN_GOAL ? 'bg-emerald-100 hover:bg-emerald-200 text-emerald-800 border border-emerald-200' : 'bg-slate-100 hover:bg-slate-200 text-slate-600'}`}><LogOut size={14} /> <span className="hidden sm:inline">End Shift</span></button>
                            <div className="flex flex-col items-center leading-none mx-2"><span className="text-[10px] text-slate-400 uppercase">Score</span><span className="font-bold">{score}</span></div>
                            <button type="button" onClick={nextTurn} disabled={tutorialStep > 0} className="bg-slate-800 text-white px-4 py-1.5 rounded text-xs hover:bg-slate-700 font-bold cursor-pointer disabled:opacity-50">Next</button>
                        </div>
                    </div>
                    <div className="flex flex-1 overflow-hidden relative">
                        <div className={`absolute inset-y-0 left-0 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:relative lg:translate-x-0 transition duration-200 ease-in-out w-64 bg-white border-r flex flex-col shrink-0 z-30 shadow-2xl lg:shadow-none`}>
                            <div className="p-4 border-b bg-slate-50 flex justify-between items-center"><span className="font-black text-[10px] uppercase tracking-widest text-slate-400">Resources</span><button type="button" onClick={()=>setSidebarOpen(false)} className="lg:hidden text-slate-400 cursor-pointer"><X size={16}/></button></div>
                            <div className="p-4 border-b bg-slate-50 grid grid-cols-2 gap-2 text-center text-xs font-bold">
                                <div className="bg-white border rounded p-1 shadow-sm"><Droplet size={14} className="mx-auto text-red-500 mb-1"/>{resources.blood}</div>
                                <div className="bg-white border rounded p-1 shadow-sm"><Wind size={14} className="mx-auto text-emerald-500 mb-1"/>{resources.vents}</div>
                            </div>
                            <div className="p-3 border-b font-bold text-xs text-slate-400 uppercase tracking-widest flex justify-between items-center">
                                <span>Staff Rostering</span>
                                <div className="lg:hidden flex gap-2"><button type="button" onClick={() => setModalContent('guide')} className="text-blue-600 cursor-pointer"><BookOpen size={14}/></button><button type="button" onClick={() => setModalContent('roles')} className="text-purple-600 cursor-pointer"><BadgeInfo size={14}/></button></div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                {roleStates.map(r => { const RoleIcon = r.icon; 
                                    const isHighlight = (tutorialStep === 1 && r.id === 'nurse_ic') || (tutorialStep === 6 && r.id.startsWith('nurse_staff'));
                                    return ( <button type="button" key={r.id} onClick={() => { setCurrentRoleId(r.id); if(window.innerWidth < 1024) setSidebarOpen(false); }} disabled={r.disabled} className={`w-full text-left px-3 py-2 rounded border-l-4 transition-all mb-1 group cursor-pointer ${currentRoleId === r.id ? getActiveStyle(r.theme) + ' shadow-md' : getColorStyle(r.theme) + ' bg-white border-transparent'} ${r.disabled ? 'opacity-50 bg-slate-100' : ''} ${isHighlight ? 'tutorial-highlight' : ''}`}><div className="flex justify-between items-center"><div className="flex items-center gap-2"><div className={`p-1 rounded ${currentRoleId === r.id ? 'bg-white/20' : 'bg-gray-100 group-hover:bg-white'}`}><RoleIcon size={16} strokeWidth={2.5} /></div><div><span className="font-bold text-xs block">{r.name}</span><span className="text-[10px] opacity-75">{r.disabled ? 'UNAVAILABLE' : r.actionText}</span></div></div><span className={`text-[10px] font-black px-1.5 py-0.5 rounded ${r.currentAp === 0 ? 'bg-red-500 text-white' : 'bg-white/30'}`}>{r.currentAp}</span></div></button> )})}
                            </div>
                        </div>
                        <div className="flex-1 bg-slate-200 p-3 overflow-y-auto relative flex flex-col" onClick={() => setSelectedPatientId(null)}>
                            <button type="button" onClick={()=>setSidebarOpen(true)} className="lg:hidden absolute top-3 left-3 z-20 bg-white p-2 rounded shadow cursor-pointer"><Menu size={20}/></button>
                            {activeEvent && <div className="mb-3 bg-amber-50 border border-amber-200 p-3 rounded flex items-center gap-3 shadow-sm animate-bounce"><AlertTriangle className="text-amber-600"/><div className="text-xs"><span className="font-bold block text-amber-800">{activeEvent.title}</span>{activeEvent.desc} <span className="font-bold">({activeEvent.effect})</span></div></div>}
                            <div className={`grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 flex-1 transition-all duration-300 ${selectedPatientId ? 'scale-[0.99]' : ''}`}>
                                <div className="col-span-1 bg-red-50/50 rounded-xl border border-red-100/50 p-2 flex flex-col gap-2"><div className="text-[10px] font-black text-red-300 uppercase tracking-widest text-center">Intake</div><div className="flex-1 grid grid-rows-3 gap-2"><div className="row-span-2 min-h-[150px]"><ZoneDisplay zone={ZONES[0]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} isTutorialTarget={tutorialStep === 2 && selectedPatientId === null} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[1]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} isTutorialTarget={tutorialStep === 3} /></div></div></div>
                                <div className="col-span-1 bg-blue-50/50 rounded-xl border border-blue-100/50 p-2 flex flex-col gap-2"><div className="text-[10px] font-black text-blue-300 uppercase tracking-widest text-center">Acute</div><div className="flex-1 grid grid-rows-3 gap-2"><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[2]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[3]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[5]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} isTutorialTarget={tutorialStep === 5} /></div></div></div>
                                <div className="col-span-1 bg-purple-50/50 rounded-xl border border-purple-100/50 p-2 flex flex-col gap-2"><div className="text-[10px] font-black text-purple-300 uppercase tracking-widest text-center">Imaging</div><div className="flex-1 grid grid-rows-3 gap-2"><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[4]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-2"></div></div></div>
                                <div className="col-span-1 bg-emerald-50/50 rounded-xl border border-emerald-100/50 p-2 flex flex-col gap-2"><div className="text-[10px] font-black text-emerald-300 uppercase tracking-widest text-center">Wards</div><div className="flex-1 grid grid-rows-3 gap-2"><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[6]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[7]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-1"></div></div></div>
                                <div className="col-span-1 bg-gray-100/50 rounded-xl border border-gray-200/50 p-2 flex flex-col gap-2"><div className="text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">Ops</div><div className="flex-1 grid grid-rows-3 gap-2"><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[8]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[9]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} isTutorialTarget={tutorialStep === 8} /></div><div className="row-span-1 min-h-[80px]"><ZoneDisplay zone={ZONES[10]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} onZoneClick={handleZoneClick} activeEvent={activeEvent} /></div></div></div>
                            </div>
                            <div className="mt-4 border-t border-gray-300 pt-2 pb-24 lg:pb-2 text-[10px] text-gray-500 flex flex-wrap justify-between items-center gap-2">
                                <div className="flex gap-4"><span>© 2025 WMEBEM. Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">CC BY-NC-SA 4.0</a>.</span></div>
                                <div className="flex gap-4">
                                    <a href="https://www.england.nhs.uk/ourwork/eprr/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-bold">NHS England EPRR</a>
                                    <span>•</span>
                                    <a href="https://www.england.nhs.uk/publication/clinical-guidelines-for-major-incidents-and-mass-casualty-events/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-bold">Clinical Guidelines</a>
                                    <span>•</span>
                                    <a href="https://tstmitt.netlify.app" target="_blank" rel="noopener noreferrer" className="text-purple-600 hover:underline font-bold">TST / MITT Training</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {selectedPatient && currentRole && <ActionHUD patient={selectedPatient} role={currentRole} onClose={() => setSelectedPatientId(null)} onAction={handleAction} onAbility={handleAbility} resources={resources} time={formatTime(simTime)} activeEvent={activeEvent} tutorialStep={tutorialStep} isActiveTriage={isActiveTriageMode} />}
                    {activeEvent && !activeEvent.acknowledged && <EventModal event={activeEvent} onClose={() => { const e = {...activeEvent, acknowledged: true}; setActiveEvent(e); }} />}
                    {modalContent === 'guide' && <Modal title="WMEBEM Simulation Guide" onClose={() => setModalContent(null)}><UserGuide /></Modal>}
                    {modalContent === 'roles' && <Modal title="Role Capabilities Key" onClose={() => setModalContent(null)}><RoleKey /></Modal>}
                    {modalContent === 'sitrep' && <SitrepModal zones={ZONES} patients={patients} onClose={() => setModalContent(null)} />}
                    {triageTarget && <TriageModal patient={triageTarget} onClose={() => setTriageTarget(null)} onConfirm={handleTriageConfirm} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
