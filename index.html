<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMEBEM Incident Command</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; user-select: none; overflow: hidden; }
        
        /* Zone Styling */
        .zone-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .zone-card.dimmed { opacity: 0.3; filter: grayscale(0.8); pointer-events: none; }
        .zone-card.drag-over { background-color: #f0f9ff; border-color: #0284c7; box-shadow: 0 0 0 4px #0284c7 inset; transform: scale(1.02); }
        
        /* Patient Colors */
        .p1-bg { background-color: #fee2e2; border-left: 5px solid #dc2626; } 
        .p2-bg { background-color: #fef3c7; border-left: 5px solid #d97706; } 
        .p3-bg { background-color: #d1fae5; border-left: 5px solid #059669; } 
        .dead-bg { background-color: #e2e8f0; border-left: 5px solid #1e293b; }
        
        /* Animations */
        .hud-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .vital-red { color: #dc2626; font-weight: 900; animation: pulse 2s infinite; }
        .vital-amber { color: #d97706; font-weight: bold; }
        .vital-normal { color: #059669; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        .logo-h { height: 2.5rem; width: auto; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- AUDIO MANAGER ---
        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);

            const now = ctx.currentTime;
            
            if (type === 'ping') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.5);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'treat') {
                // ECG Beep style
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(880, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
                
                // Second beep
                const osc2 = ctx.createOscillator();
                const gain2 = ctx.createGain();
                osc2.connect(gain2);
                gain2.connect(ctx.destination);
                osc2.type = 'triangle';
                osc2.frequency.setValueAtTime(880, now + 0.15);
                gain2.gain.setValueAtTime(0.1, now + 0.15);
                gain2.gain.linearRampToValueAtTime(0, now + 0.25);
                osc2.start(now + 0.15);
                osc2.stop(now + 0.25);
            } else if (type === 'flatline') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                gain.gain.setValueAtTime(0.15, now);
                gain.gain.linearRampToValueAtTime(0, now + 2.5);
                osc.start(now);
                osc.stop(now + 2.5);
            } else if (type === 'move') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            }
        };

        // --- ICONS ---
        const IconWrapper = ({ children, size = 24, strokeWidth = 2, className = "", ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const ClipboardCheck = (p) => <IconWrapper {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></IconWrapper>;
        const Scan = (p) => <IconWrapper {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></IconWrapper>;
        const Stethoscope = (p) => <IconWrapper {...p}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v6"/><path d="M16 15v6a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-6"/><circle cx="12" cy="20" r="2"/></IconWrapper>;
        const DoorOpen = (p) => <IconWrapper {...p}><path d="M13 4h3a2 2 0 0 1 2 2v14"/><path d="M2 20h3"/><path d="M13 20h9"/><path d="M10 12v.01"/><path d="M13 4.562v16.157a1 1 0 0 1-1.242.97L5 20V5.562a2 2 0 0 1 1.515-1.94l4-1A2 2 0 0 1 13 4.561Z"/></IconWrapper>;
        const Check = (p) => <IconWrapper {...p}><path d="M20 6 9 17l-5-5"/></IconWrapper>;
        const CheckCircle = (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></IconWrapper>;
        const ShieldAlert = (p) => <IconWrapper {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></IconWrapper>;
        const X = (p) => <IconWrapper {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const Users = (p) => <IconWrapper {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>;
        const Droplet = (p) => <IconWrapper {...p}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></IconWrapper>;
        const Wind = (p) => <IconWrapper {...p}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></IconWrapper>;
        const Syringe = (p) => <IconWrapper {...p}><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/><path d="m9 11 4 4"/><path d="m5 19-3 3"/></IconWrapper>;
        const Activity = (p) => <IconWrapper {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
        const Bed = (p) => <IconWrapper {...p}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></IconWrapper>;
        const BookOpen = (p) => <IconWrapper {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>;
        const BadgeInfo = (p) => <IconWrapper {...p}><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.78 4.78 4 4 0 0 1-6.74 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z"/><line x1="12" x2="12" y1="8" y2="8"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>;
        const FileText = (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconWrapper>;

        // --- CONSTANTS ---
        const LOGO_URL = "https://iili.io/KGQOvkl.md.png";
        
        const ALL_ROLES = [
            { id: 'bronze_cmd', type: 'command', theme: 'slate', icon: Activity, name: 'Bronze Commander', ap: 4, desc: 'Operational Lead', ability: 'Request Mutual Aid', abilityCost: 2, abilityEffect: '+3 Staff', actionText: 'Review', canTriage: true },
            { id: 'senior_doc', type: 'command', theme: 'slate', icon: ClipboardCheck, name: 'Senior Doctor', ap: 5, desc: 'Clinical Lead', ability: 'Rapid Triage', abilityCost: 2, abilityEffect: 'Reveal All Intake', actionText: 'Review', canTriage: true, canTreat: true, treatLevel: ['P1', 'P2', 'P3'] },
            { id: 'nurse_ic', type: 'nursing', theme: 'blue', icon: Users, name: 'Nurse in Charge', ap: 4, desc: 'Coordination', ability: 'Team Huddle', abilityCost: 1, abilityEffect: 'Reveal Triage', actionText: 'Coordinate' },
            { id: 'nurse_staff', type: 'nursing', theme: 'blue', icon: Syringe, name: 'ED Nurse', ap: 4, desc: 'Care & Triage', ability: 'Stream to Minors', abilityCost: 1, abilityEffect: 'Move P3 Free', actionText: 'Care / Triage', canTriage: true, canTreat: true, treatLevel: ['P1', 'P2', 'P3'] },
            { id: 'resident', type: 'medical', theme: 'emerald', icon: Stethoscope, name: 'ED Resident', ap: 4, desc: 'Treatment', ability: 'Fast Track', abilityCost: 2, abilityEffect: 'Instant Treat P3', actionText: 'Procedure', canTreat: true, treatLevel: ['P1', 'P2', 'P3'] },
            { id: 'radiology', type: 'support', theme: 'purple', icon: Scan, name: 'Radiology Lead', ap: 3, desc: 'Diagnostics', ability: 'Rapid Scan', abilityCost: 1, abilityEffect: 'Move to CT Free', actionText: 'Scan', canScan: true },
            { id: 'bed_manager', type: 'logistics', theme: 'amber', icon: Bed, name: 'Bed Manager', ap: 3, desc: 'Flow', ability: 'Force Discharge', abilityCost: 1, abilityEffect: 'Clear Ward Bed', actionText: 'Breach' }
        ];

        const ZONES = [
            { id: 'amb', name: 'Ambulance Bay', capacity: 12, type: 'intake' },
            { id: 'triage', name: 'Triage', capacity: 10, type: 'process' },
            { id: 'resus', name: 'Resus (P1)', capacity: 4, type: 'clinical' },
            { id: 'majors', name: 'Majors (P2)', capacity: 10, type: 'clinical' },
            { id: 'ct', name: 'CT Scan', capacity: 1, type: 'diagnostic' },
            { id: 'minors', name: 'Minors (P3)', capacity: 15, type: 'clinical' },
            { id: 'icu', name: 'ICU/HDU', capacity: 6, type: 'ward' },
            { id: 'ward', name: 'Wards', capacity: 30, type: 'ward' },
            { id: 'theatre', name: 'Theatres', capacity: 2, type: 'treatment' },
            { id: 'discharged', name: 'Home', capacity: 999, type: 'exit' },
            { id: 'morgue', name: 'Mortuary', capacity: 999, type: 'exit' }
        ];

        const getPatientNeeds = (p) => {
            const needs = [];
            if (!p.triaged) needs.push({ id: 'triage', label: 'Triage', icon: ClipboardCheck, color: 'text-slate-600', bg: 'bg-slate-100', borderColor: 'border-slate-300' });
            if (p.triaged && !p.treated) {
                const needsScan = (p.injuryLoc === 'head' || p.injuryLoc === 'abdo') && !p.scanned;
                if (needsScan) needs.push({ id: 'scan', label: 'CT Scan', icon: Scan, color: 'text-purple-600', bg: 'bg-purple-100', borderColor: 'border-purple-300' });
                if (!needsScan) needs.push({ id: 'treat', label: 'Treatment', icon: Stethoscope, color: 'text-emerald-600', bg: 'bg-emerald-100', borderColor: 'border-emerald-300' });
            }
            if (p.treated && !['discharged','ward','icu','morgue'].includes(p.location)) {
                needs.push({ id: 'move', label: 'Admit/Discharge', icon: DoorOpen, color: 'text-amber-600', bg: 'bg-amber-100', borderColor: 'border-amber-300' });
            }
            return needs;
        };

        const getColorStyle = (theme) => ({
            slate: 'border-slate-500 hover:bg-slate-50 text-slate-800',
            blue: 'border-blue-500 hover:bg-blue-50 text-blue-800',
            emerald: 'border-emerald-500 hover:bg-emerald-50 text-emerald-800',
            purple: 'border-purple-500 hover:bg-purple-50 text-purple-800',
            amber: 'border-amber-500 hover:bg-amber-50 text-amber-800'
        }[theme] || 'border-gray-500');

        const getActiveStyle = (theme) => ({
            slate: 'bg-slate-800 text-white border-slate-800',
            blue: 'bg-blue-700 text-white border-blue-700',
            emerald: 'bg-emerald-700 text-white border-emerald-700',
            purple: 'bg-purple-700 text-white border-purple-700',
            amber: 'bg-amber-700 text-white border-amber-700'
        }[theme] || 'bg-gray-800');

        // --- COMPONENTS ---
        const StickFigure = ({ injuryLoc, className }) => (
            <svg viewBox="0 0 100 100" className={`overflow-visible ${className}`}>
                <circle cx="50" cy="15" r="12" fill="none" stroke="currentColor" strokeWidth="6" />
                <line x1="50" y1="27" x2="50" y2="60" stroke="currentColor" strokeWidth="6" />
                <line x1="50" y1="35" x2="20" y2="50" stroke="currentColor" strokeWidth="6" />
                <line x1="50" y1="35" x2="80" y2="50" stroke="currentColor" strokeWidth="6" />
                <line x1="50" y1="60" x2="30" y2="95" stroke="currentColor" strokeWidth="6" />
                <line x1="50" y1="60" x2="70" y2="95" stroke="currentColor" strokeWidth="6" />
                {injuryLoc === 'head' && <circle cx="50" cy="15" r="15" stroke="#ef4444" strokeWidth="4" fill="none" className="animate-pulse" />}
                {injuryLoc === 'chest' && <circle cx="50" cy="40" r="12" stroke="#ef4444" strokeWidth="4" fill="none" className="animate-pulse" />}
                {injuryLoc === 'abdo' && <circle cx="50" cy="55" r="10" stroke="#ef4444" strokeWidth="4" fill="none" className="animate-pulse" />}
                {injuryLoc === 'arm' && <circle cx="20" cy="50" r="8" stroke="#ef4444" strokeWidth="4" fill="none" className="animate-pulse" />}
                {injuryLoc === 'leg' && <circle cx="30" cy="90" r="8" stroke="#ef4444" strokeWidth="4" fill="none" className="animate-pulse" />}
            </svg>
        );

        const VitalsDisplay = ({ vitals }) => {
            const getVitalClass = (val, type) => {
                if (type === 'hr') return (val > 120 || val < 50) ? 'vital-red' : (val > 100 ? 'vital-amber' : 'vital-normal');
                if (type === 'sbp') return (val < 90) ? 'vital-red' : (val < 100 ? 'vital-amber' : 'vital-normal');
                if (type === 'rr') return (val > 30 || val < 10) ? 'vital-red' : (val > 22 ? 'vital-amber' : 'vital-normal');
                return 'text-slate-400';
            };
            return (
                <div className="grid grid-cols-4 gap-2 text-[10px] font-mono bg-slate-900/50 p-1 rounded border border-slate-700/50">
                    <div className="text-center"><span className="text-slate-500 block text-[8px]">HR</span><span className={getVitalClass(vitals.hr, 'hr')}>{vitals.hr}</span></div>
                    <div className="text-center"><span className="text-slate-500 block text-[8px]">BP</span><span className={getVitalClass(vitals.sbp, 'sbp')}>{vitals.sbp}</span></div>
                    <div className="text-center"><span className="text-slate-500 block text-[8px]">RR</span><span className={getVitalClass(vitals.rr, 'rr')}>{vitals.rr}</span></div>
                    <div className="text-center"><span className="text-slate-500 block text-[8px]">SpO2</span><span className={getVitalClass(vitals.spo2, 'spo2')}>{vitals.spo2}%</span></div>
                </div>
            );
        };

        const PatientCard = ({ patient, onSelect, isSelected, onDragStart }) => {
            const needs = getPatientNeeds(patient);
            const getColorClass = (cat) => {
                if(cat === 'P1') return "p1-bg";
                if(cat === 'P2') return "p2-bg";
                if(cat === 'P3') return "p3-bg";
                return "dead-bg";
            };
            const isRevealed = patient.location !== 'amb' || patient.triaged;

            return (
                <div draggable onDragStart={(e) => onDragStart(e, patient.uniqueId)} onClick={(e) => { e.stopPropagation(); onSelect(patient.uniqueId); }}
                    className={`p-2 rounded-md shadow-sm border cursor-pointer mb-2 transition-all relative group ${getColorClass(patient.category)} ${isSelected ? 'ring-4 ring-blue-500 ring-offset-1 scale-105 z-10' : 'hover:scale-[1.02] border-black/10'}`}>
                    <div className="flex justify-between items-start mb-1">
                        <span className="font-black text-slate-900 text-xs truncate w-24">{patient.name}</span>
                        {isRevealed ? ( <span className="px-1.5 bg-white/90 rounded text-[10px] font-black border border-black/10 shadow-sm">{patient.category}</span> ) : ( <span className="px-1.5 bg-gray-200 rounded text-[10px] font-bold text-gray-500">?</span> )}
                    </div>
                    {isRevealed ? ( <div className="text-[9px] leading-tight text-slate-700 h-8 line-clamp-2 mb-1 font-medium">{patient.text}</div> ) : ( <div className="text-[9px] text-slate-500 italic h-8 flex items-center justify-center bg-black/5 rounded mb-1">Awaiting Triage...</div> )}
                    <div className="flex gap-1 mt-1 border-t border-black/5 pt-1 min-h-[16px]">
                        {needs.map((n, i) => { const Icon = n.icon; return ( <div key={i} className={`rounded-full p-0.5 border ${n.bg} ${n.color} ${n.borderColor}`} title={n.label}><Icon size={10} strokeWidth={2.5} /></div> ); })}
                        {patient.treated && <div className="bg-emerald-100 text-emerald-700 rounded-full p-0.5"><Check size={10} strokeWidth={3} /></div>}
                    </div>
                </div>
            );
        };

        const ZoneDisplay = ({ zone, patients, onSelect, selectedPatientId, onDrop }) => {
            const zPatients = patients.filter(p => p.location === zone.id);
            return (
                <div onDragOver={e => e.preventDefault()} onDrop={e => onDrop(e, zone.id)} className={`bg-white border rounded-lg flex flex-col shadow-sm overflow-hidden zone-card ${selectedPatientId ? 'dimmed' : ''} h-full`}>
                    <div className="px-3 py-1.5 border-b flex justify-between items-center bg-white/50">
                        <span className="font-bold text-[10px] uppercase text-slate-500">{zone.name}</span>
                        <span className={`text-[10px] font-bold px-1.5 rounded ${zPatients.length > zone.capacity ? 'bg-red-100 text-red-600' : 'bg-slate-100'}`}>{zPatients.length}/{zone.capacity}</span>
                    </div>
                    <div className="p-2 flex-1 overflow-y-auto">
                        {zPatients.map(p => ( <PatientCard key={p.uniqueId} patient={p} isSelected={selectedPatientId === p.uniqueId} onSelect={onSelect} onDragStart={(e, id) => e.dataTransfer.setData("patientId", id)} /> ))}
                    </div>
                </div>
            );
        };

        const ActionHUD = ({ patient, role, onAction, onAbility, onClose, resources, time }) => {
            if (!patient) return null;
            const needs = getPatientNeeds(patient);
            const canTriage = needs.some(n => n.id === 'triage') && role.canTriage;
            const canScan = needs.some(n => n.id === 'scan') && role.canScan;
            const canTreat = needs.some(n => n.id === 'treat') && role.canTreat && (!role.treatLevel || role.treatLevel.includes(patient.category));
            
            let mainActionText = "No Action";
            let isMainActionEnabled = false;
            let mainActionColor = "bg-slate-600";
            
            if (canTriage) { mainActionText = "Triage Patient"; isMainActionEnabled = true; mainActionColor = "bg-blue-600 hover:bg-blue-500"; }
            else if (canScan) { mainActionText = "Perform CT Scan"; isMainActionEnabled = true; mainActionColor = "bg-purple-600 hover:bg-purple-500"; }
            else if (canTreat) { mainActionText = `Treat (${role.actionText})`; isMainActionEnabled = true; mainActionColor = "bg-emerald-600 hover:bg-emerald-500"; }
            else if (needs.some(n => n.id === 'scan')) { mainActionText = "Needs CT Scan First"; mainActionColor = "bg-slate-700 text-slate-400"; }
            else if (needs.some(n => n.id === 'treat')) { mainActionText = "Requires Medical Role"; mainActionColor = "bg-slate-700 text-slate-400"; }
            else if (patient.treated) { mainActionText = "Patient Stable"; mainActionColor = "bg-emerald-800 text-emerald-200"; }

            return (
                <div className="fixed bottom-0 left-0 right-0 bg-slate-900 text-white border-t border-slate-700 shadow-2xl z-50 hud-enter flex flex-col md:flex-row h-[240px]">
                    <div className="p-4 flex items-center gap-4 border-b md:border-b-0 md:border-r border-slate-700 w-full md:w-1/3 bg-slate-800/50">
                        <StickFigure injuryLoc={patient.injuryLoc} className="h-20 w-20 text-slate-300" />
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                                <span className={`text-xs font-black px-2 py-0.5 rounded text-slate-900 ${patient.category === 'P1' ? 'bg-red-300' : patient.category === 'P2' ? 'bg-amber-300' : 'bg-green-300'}`}>{patient.category}</span>
                                <h2 className="text-xl font-bold truncate">{patient.name}</h2>
                            </div>
                            <p className="text-slate-400 text-xs mb-2">{patient.age} {patient.gender} • {patient.text}</p>
                            <VitalsDisplay vitals={patient.vitals} />
                        </div>
                    </div>
                    <div className="p-4 flex-1 border-b md:border-b-0 md:border-r border-slate-700 bg-slate-900 overflow-y-auto">
                        <div className="flex justify-between items-center mb-2">
                            <div className="text-[10px] uppercase tracking-widest text-slate-500 font-bold">Clinical Notes</div>
                            <div className="flex gap-2">
                                {needs.length === 0 && <div className="text-emerald-400 text-[10px] font-bold flex items-center gap-1"><CheckCircle size={12}/> Ready</div>}
                                {needs.map((n, i) => { const Icon = n.icon; return ( <div key={i} className={`flex items-center gap-1 px-2 py-0.5 rounded border text-[10px] font-bold ${n.bg} ${n.color} ${n.borderColor}`}><Icon size={10} /><span>{n.label}</span></div> ); })}
                            </div>
                        </div>
                        <div className="space-y-1">
                            {patient.history && patient.history.length > 0 ? (
                                patient.history.map((entry, idx) => (
                                    <div key={idx} className="text-[10px] font-mono flex gap-2 text-slate-300 border-b border-slate-800 pb-1">
                                        <span className="text-slate-500">{entry.time}</span>
                                        <span>{entry.msg}</span>
                                    </div>
                                ))
                            ) : (
                                <div className="text-[10px] text-slate-600 italic">No clinical history recorded.</div>
                            )}
                        </div>
                    </div>
                    <div className="p-4 w-full md:w-1/3 flex flex-col gap-2 bg-slate-800/30">
                        <div className="flex justify-between items-center text-[10px] text-slate-400 uppercase font-bold mb-1"><span>Role: {role.name}</span><span>AP: {role.currentAp}/{role.ap}</span></div>
                        <button onClick={onAction} disabled={!isMainActionEnabled || role.currentAp < 1} className={`flex-1 py-3 rounded font-bold text-sm shadow-lg transition-all flex items-center justify-center gap-2 ${mainActionColor} disabled:opacity-50 disabled:cursor-not-allowed`}>
                            {canTriage && <ClipboardCheck size={16} />}{canScan && <Scan size={16} />}{canTreat && <Stethoscope size={16} />}{mainActionText}{isMainActionEnabled && <span className="bg-black/20 px-1.5 rounded text-[10px]">1 AP</span>}
                        </button>
                        <button onClick={onAbility} disabled={role.currentAp < role.abilityCost} className="py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded font-bold text-xs transition-colors flex items-center justify-center gap-2 disabled:opacity-50"><ShieldAlert size={14} />{role.ability}: {role.abilityEffect}<span className="bg-black/20 px-1.5 rounded text-[10px]">{role.abilityCost} AP</span></button>
                    </div>
                    <button onClick={onClose} className="absolute top-0 right-0 p-2 text-slate-500 hover:text-white"><X size={16}/></button>
                </div>
            );
        };

        const Modal = ({ title, children, onClose }) => (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden modal-enter border border-gray-200 flex flex-col max-h-[90vh]">
                    <div className="bg-slate-50 px-6 py-4 flex justify-between items-center border-b shrink-0"><h2 className="text-lg font-bold text-slate-800 tracking-wide">{title}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><X size={20} /></button></div>
                    <div className="p-6 overflow-y-auto text-slate-700 text-sm flex-1">{children}</div>
                    <div className="bg-gray-50 px-6 py-4 border-t flex justify-end gap-3 shrink-0"><button onClick={onClose} className="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded font-bold shadow transition-all">Close</button></div>
                </div>
            </div>
        );

        const UserGuide = () => (
            <div className="space-y-6">
                <section>
                    <h4 className="font-bold text-blue-800 text-base mb-2 border-b pb-1">1. Core Gameplay Loop</h4>
                    <div className="grid grid-cols-2 gap-4 text-xs">
                        <div className="bg-slate-50 p-3 rounded border"><strong className="block mb-1">Turn-Based Action</strong>Each staff member has Action Points (AP). Drag patients to move them (1 AP) or click actions in the HUD (1 AP). AP resets every turn.</div>
                        <div className="bg-slate-50 p-3 rounded border"><strong className="block mb-1">Winning & Losing</strong><span className="text-emerald-700 font-bold">WIN:</span> Discharge stable patients home.<br/><span className="text-red-600 font-bold">LOSE:</span> P1 patients die if left untreated for >1 turn. Ambulance bay overflow ends the game.</div>
                    </div>
                </section>
                <section>
                    <h4 className="font-bold text-blue-800 text-base mb-2 border-b pb-1">2. Patient Care Pathway</h4>
                    <ol className="list-decimal pl-5 space-y-2 text-xs">
                        <li><strong>Triage:</strong> Use a Nurse or Commander to reveal patient category (P1/P2/P3).</li>
                        <li><strong>Diagnostics (Purple):</strong> Head/Abdo injuries often need a CT Scan. Move to CT Zone -> Use Radiologist to Scan. Treatment is blocked until scanned!</li>
                        <li><strong>Treatment (Green/Blue):</strong> Move to Resus/Majors. Use Doctor/Nurse to treat. P1s consume Blood.</li>
                        <li><strong>Disposition:</strong> Move stable patients to Wards/ICU/Home.</li>
                    </ol>
                </section>
            </div>
        );

        const RoleKey = () => (
            <div className="space-y-2">
                {ALL_ROLES.map(role => {
                    const RoleIcon = role.icon;
                    return (
                        <div key={role.id} className={`flex items-start gap-3 p-3 rounded border ${getColorStyle(role.theme)} bg-white`}>
                            <div className={`p-2 rounded bg-${role.theme}-100 text-${role.theme}-700 shrink-0`}><RoleIcon size={20} /></div>
                            <div className="flex-1">
                                <div className="flex justify-between items-center mb-1"><h4 className="font-bold text-sm">{role.name}</h4><span className="text-[10px] font-bold uppercase tracking-wider bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">{role.type}</span></div>
                                <p className="text-xs text-gray-600 mb-2">{role.desc}</p>
                                <div className="grid grid-cols-2 gap-2 text-[10px]"><div className="bg-gray-50 p-1.5 rounded border"><span className="font-bold block text-gray-500">Primary Action</span>{role.actionText}</div><div className="bg-gray-50 p-1.5 rounded border"><span className="font-bold block text-gray-500">Special Ability ({role.abilityCost} AP)</span>{role.ability}: {role.abilityEffect}</div></div>
                            </div>
                        </div>
                    );
                })}
            </div>
        );

        const App = () => {
            const [gameState, setGameState] = useState('start');
            const [playerCount, setPlayerCount] = useState(1);
            const [turn, setTurn] = useState(1);
            const [score, setScore] = useState(100);
            const [deaths, setDeaths] = useState(0);
            const [discharged, setDischarged] = useState(0);
            const [roleStates, setRoleStates] = useState([]);
            const [currentRoleId, setCurrentRoleId] = useState(null);
            const [patients, setPatients] = useState([]);
            const [selectedPatientId, setSelectedPatientId] = useState(null);
            const [resources, setResources] = useState({ staff: 15, blood: 20, vents: 8 });
            const [eventLog, setEventLog] = useState([]);
            const [modalContent, setModalContent] = useState(null);
            const [simTime, setSimTime] = useState(12 * 60); // Start at 12:00 in minutes

            const formatTime = (mins) => {
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            };

            const currentRole = roleStates.find(r => r.id === currentRoleId);
            const selectedPatient = patients.find(p => p.uniqueId === selectedPatientId);

            const NAMES = ["Smith", "Jones", "Taylor", "Brown", "Williams", "Wilson", "Johnson", "Davies", "Evans", "Thomas", "Roberts"];
            const MALE_NAMES = ["James", "John", "Robert", "Michael", "William", "David", "Richard", "Joseph", "Thomas", "Charles"];
            const FEMALE_NAMES = ["Mary", "Patricia", "Jennifer", "Linda", "Elizabeth", "Barbara", "Susan", "Jessica", "Sarah", "Karen"];
            
            const PATIENT_DECK = [
                { category: 'P1', injuryLoc: 'chest', text: 'GSW Chest. Needs Thoracotomy.', vitals: { hr: 140, sbp: 70, rr: 32, spo2: 88 } },
                { category: 'P1', injuryLoc: 'abdo', text: 'Blast Abdomen. Rigid.', vitals: { hr: 130, sbp: 85, rr: 24, spo2: 94 } },
                { category: 'P2', injuryLoc: 'head', text: 'TBI. Asymmetric pupils.', vitals: { hr: 60, sbp: 160, rr: 12, spo2: 96 } },
                { category: 'P2', injuryLoc: 'leg', text: 'Femur Fracture. Open.', vitals: { hr: 110, sbp: 110, rr: 20, spo2: 98 } },
                { category: 'P3', injuryLoc: 'arm', text: 'Deep Laceration.', vitals: { hr: 80, sbp: 120, rr: 14, spo2: 99 } },
                { category: 'P3', injuryLoc: 'head', text: 'Mild Concussion.', vitals: { hr: 76, sbp: 118, rr: 14, spo2: 100 } },
            ];

            const getRoleSuggestion = (count) => {
                if(count === 1) return "Solo Mode: You control all Command, Nursing, Medical, and Support roles.";
                if(count === 2) return "P1: Command + Medical | P2: Nursing + Support";
                if(count === 3) return "P1: Command | P2: Nursing | P3: Medical + Support";
                if(count >= 4) return "Assign Command, Nursing, Medical, and Support roles to different players.";
                return "";
            };

            const addHistory = (patient, msg) => {
                const newEntry = { time: formatTime(simTime), msg };
                return { ...patient, history: [newEntry, ...(patient.history || [])] };
            };

            const spawnPatients = (count, currentSimTime) => {
                const newP = Array(count).fill(0).map((_, i) => {
                    const isMale = Math.random() > 0.5;
                    const gender = isMale ? 'M' : 'F';
                    const firstNameList = isMale ? MALE_NAMES : FEMALE_NAMES;
                    const name = `${firstNameList[Math.floor(Math.random() * firstNameList.length)]} ${NAMES[Math.floor(Math.random() * NAMES.length)]}`;
                    const base = PATIENT_DECK[Math.floor(Math.random() * PATIENT_DECK.length)];
                    return { 
                        ...base, 
                        name, 
                        age: Math.floor(Math.random() * 60) + 18 + 'y', 
                        gender, 
                        uniqueId: Date.now() + i + Math.random(), 
                        location: 'amb', 
                        triaged: false, 
                        treated: false, 
                        scanned: false,
                        history: [{ time: formatTime(currentSimTime), msg: `Arrived via Ambulance.` }]
                    };
                });
                setPatients(prev => [...prev, ...newP]);
                playSound('ping');
            };

            const startGame = () => {
                const initialRoles = ALL_ROLES.map(r => ({ ...r, currentAp: r.ap }));
                setRoleStates(initialRoles);
                setCurrentRoleId(initialRoles[0].id);
                spawnPatients(6, 12 * 60);
                setGameState('playing');
            };

            const deductAp = (cost) => { setRoleStates(prev => prev.map(r => r.id === currentRoleId ? { ...r, currentAp: r.currentAp - cost } : r)); };

            const handleAbility = () => {
                if(!currentRole || currentRole.currentAp < currentRole.abilityCost) return;
                deductAp(currentRole.abilityCost);
                
                if(currentRole.id === 'bronze_cmd') { setResources(prev => ({ ...prev, staff: prev.staff + 3 })); setEventLog(prev => ["Mutual Aid Requested: +3 Staff", ...prev]); } 
                else if(currentRole.id === 'senior_doc') { 
                    setPatients(prev => prev.map(p => p.location === 'amb' ? addHistory({...p, triaged: true}, `Rapid Triage by Senior Doc`) : p)); 
                    setEventLog(prev => ["Rapid Triage: All Intake Revealed", ...prev]); 
                }
                else if(currentRole.id === 'nurse_ic') { 
                    setPatients(prev => prev.map(p => p.location === 'triage' ? addHistory({...p, triaged: true}, `Team Huddle Triage`) : p)); 
                    setEventLog(prev => ["Team Huddle: Triage Lane Revealed", ...prev]); 
                }
                else if(currentRole.id === 'nurse_staff') {
                    const p3 = patients.find(p => p.category === 'P3' && p.location === 'amb');
                    if(p3) { setPatients(prev => prev.map(p => p.uniqueId === p3.uniqueId ? addHistory({ ...p, location: 'minors', triaged: true }, "Streamed to Minors") : p)); setEventLog(prev => [`Streamed ${p3.name} to Minors`, ...prev]); }
                }
                else if(currentRole.id === 'resident') {
                    const p3 = patients.find(p => p.category === 'P3' && !p.treated && p.location === 'minors');
                    if(p3) { 
                        setPatients(prev => prev.map(p => p.uniqueId === p3.uniqueId ? addHistory({ ...p, treated: true }, "Fast Track Treatment") : p)); 
                        playSound('treat');
                        setEventLog(prev => [`Fast Tracked ${p3.name}`, ...prev]); 
                    }
                }
                else if(currentRole.id === 'radiology') {
                    const target = patients.find(p => (p.location === 'resus' || p.location === 'majors') && !p.treated && !p.scanned);
                    if(target) { setPatients(prev => prev.map(p => p.uniqueId === target.uniqueId ? addHistory({ ...p, location: 'ct' }, "Rapid Scan Transfer") : p)); setEventLog(prev => [`Rapid Scan: Moved ${target.name} to CT`, ...prev]); }
                }
                else if(currentRole.id === 'bed_manager') {
                    const target = patients.find(p => p.location === 'ward');
                    if(target) { 
                        setPatients(prev => prev.map(p => p.uniqueId === target.uniqueId ? addHistory({ ...p, location: 'discharged' }, "Forced Discharge") : p)); 
                        setDischarged(d => d + 1); 
                        if(target.treated) setScore(s => s + 20); else { setScore(s => s - 20); setEventLog(prev => ["WARNING: Unsafe Discharge!", ...prev]); }
                        setEventLog(prev => [`Forced Discharge: ${target.name}`, ...prev]); 
                    }
                }
            };

            const handleAction = () => {
                if(!selectedPatient || !currentRole) return;
                const needs = getPatientNeeds(selectedPatient);
                
                if(needs.some(n => n.id === 'triage') && currentRole.canTriage) {
                    setPatients(prev => prev.map(p => p.uniqueId === selectedPatientId ? addHistory({ ...p, triaged: true }, `Triaged as ${p.category}`) : p));
                    deductAp(1);
                } else if (needs.some(n => n.id === 'scan') && currentRole.canScan) {
                    if(selectedPatient.location === 'ct') {
                         setPatients(prev => prev.map(p => p.uniqueId === selectedPatientId ? addHistory({ ...p, scanned: true }, "CT Scan Completed") : p));
                         setEventLog(prev => [`Scan complete on ${selectedPatient.name}`, ...prev]);
                         deductAp(1);
                    } else { alert("Move patient to CT first!"); }
                } else if (needs.some(n => n.id === 'treat') && currentRole.canTreat) {
                    const needsScan = (selectedPatient.injuryLoc === 'head' || selectedPatient.injuryLoc === 'abdo') && !selectedPatient.scanned;
                    if(needsScan) { alert("Patient requires CT Scan before treatment!"); return; }
                    
                    if(selectedPatient.category === 'P1') { if(resources.blood > 0) setResources(prev => ({...prev, blood: prev.blood -1})); else { alert("No Blood Available!"); return; } }
                    setPatients(prev => prev.map(p => p.uniqueId === selectedPatientId ? addHistory({ ...p, treated: true }, "Treatment Administered") : p));
                    playSound('treat');
                    deductAp(1); setScore(s => s + 10);
                }
            };

            const handleDrop = (e, zoneId) => {
                e.preventDefault();
                const pid = Number(e.dataTransfer.getData("patientId"));
                const p = patients.find(pt => pt.uniqueId === pid);
                if(p && currentRole.currentAp > 0 && p.location !== zoneId) {
                    const zoneName = ZONES.find(z => z.id === zoneId)?.name || zoneId;
                    setPatients(prev => prev.map(pt => pt.uniqueId === pid ? addHistory({ ...pt, location: zoneId }, `Moved to ${zoneName}`) : pt));
                    deductAp(1); setSelectedPatientId(pid);
                    playSound('move'); 
                }
            };

            const nextTurn = () => {
                setTurn(t => t + 1);
                const newTime = simTime + 15; // +15 mins
                setSimTime(newTime);
                setRoleStates(prev => prev.map(r => ({ ...r, currentAp: r.ap })));
                spawnPatients(Math.floor(Math.random() * 3) + 1, newTime);
                
                // Check P1 deaths
                setPatients(prev => prev.map(p => {
                    if(p.category === 'P1' && !p.treated && p.location !== 'morgue' && p.location !== 'discharged') {
                        const turnsWaiting = (p.turnsWaiting || 0) + 1;
                        if(turnsWaiting > 1) {
                            playSound('flatline');
                            setDeaths(d => d + 1);
                            setScore(s => s - 50);
                            return addHistory({ ...p, location: 'morgue', turnsWaiting }, "DIED: Treatment delay");
                        }
                        return { ...p, turnsWaiting };
                    }
                    return p;
                }));
            };

            if (gameState === 'start') {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border-t-8 border-blue-800">
                            <img src={LOGO_URL} alt="WMEBEM Logo" className="h-24 mx-auto mb-6 object-contain" />
                            <h1 className="text-3xl font-black text-slate-900 mb-2 tracking-tight">INCIDENT<span className="text-blue-600">COMMAND</span></h1>
                            <p className="text-slate-500 mb-6 font-medium">WMEBEM Digital Simulation</p>
                            <div className="mb-8">
                                <label className="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Select Team Size</label>
                                <div className="flex flex-wrap justify-center gap-2 mb-4">{[1, 2, 3, 4, 5, 6, 7, 8].map(num => ( <button key={num} onClick={() => setPlayerCount(num)} className={`w-10 h-10 rounded-xl font-bold text-lg transition-all ${playerCount === num ? 'bg-blue-600 text-white scale-110 shadow-lg' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{num}</button> ))}</div>
                                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 min-h-[60px] flex items-center justify-center"><p className="text-xs text-blue-800 font-medium leading-relaxed">{getRoleSuggestion(playerCount)}</p></div>
                            </div>
                            <button onClick={startGame} className="w-full py-4 bg-blue-700 hover:bg-blue-800 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all transform active:scale-95">Start Simulation</button>
                            <div className="mt-4 text-xs text-slate-400">Version 6.4 • WMEBEM</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen flex flex-col bg-slate-100 text-slate-800 font-sans">
                    <div className="h-14 bg-white border-b px-4 flex items-center justify-between shrink-0 z-20 relative shadow-sm">
                        <div className="flex items-center gap-3"><img src={LOGO_URL} className="logo-h" /><div><h1 className="text-lg font-black text-slate-800 leading-none">INCIDENT<span className="text-blue-600">COMMAND</span></h1><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Turn {turn} ({formatTime(simTime)}) • {playerCount} Players</span></div></div>
                        <div className="flex items-center gap-6 font-bold text-sm">
                             <div className="flex gap-2">
                                 <button onClick={() => setModalContent('guide')} className="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 px-3 py-1 rounded hover:bg-blue-50 transition-colors"><BookOpen size={16} />User Guide</button>
                                 <button onClick={() => setModalContent('roles')} className="text-xs font-bold text-purple-600 hover:text-purple-800 flex items-center gap-1 px-3 py-1 rounded hover:bg-purple-50 transition-colors"><BadgeInfo size={16} />Role Key</button>
                             </div>
                            <div className="h-6 w-px bg-gray-200"></div>
                            <div className="flex flex-col items-center leading-none"><span className="text-[10px] text-slate-400 uppercase">Score</span>{score}</div>
                            <div className="flex flex-col items-center leading-none text-red-600"><span className="text-[10px] text-slate-400 uppercase">Deaths</span>{deaths}</div>
                            <button onClick={nextTurn} className="bg-slate-800 text-white px-4 py-1.5 rounded text-xs hover:bg-slate-700">End Turn</button>
                        </div>
                    </div>

                    <div className="flex flex-1 overflow-hidden">
                        <div className="w-64 bg-white border-r flex flex-col shrink-0 z-10">
                            <div className="p-4 border-b bg-slate-50">
                                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Hospital Resources</div>
                                <div className="grid grid-cols-3 gap-2 text-center">
                                    <div className="bg-white border rounded p-1 shadow-sm"><Users size={14} className="mx-auto text-blue-500 mb-0.5"/><div className="font-bold text-sm">{resources.staff}</div></div>
                                    <div className="bg-white border rounded p-1 shadow-sm"><Droplet size={14} className="mx-auto text-red-500 mb-0.5"/><div className="font-bold text-sm">{resources.blood}</div></div>
                                    <div className="bg-white border rounded p-1 shadow-sm"><Wind size={14} className="mx-auto text-emerald-500 mb-0.5"/><div className="font-bold text-sm">{resources.vents}</div></div>
                                </div>
                            </div>
                            <div className="p-3 border-b font-bold text-xs text-slate-400 uppercase tracking-widest">Staff Rostering</div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                {roleStates.map(r => { const RoleIcon = r.icon; return ( <button key={r.id} onClick={() => { setCurrentRoleId(r.id); }} className={`w-full text-left px-3 py-2 rounded border-l-4 transition-all mb-1 group ${currentRoleId === r.id ? getActiveStyle(r.theme) + ' shadow-md' : getColorStyle(r.theme) + ' bg-white border-transparent'}`}><div className="flex justify-between items-start"><div className="flex items-center gap-2"><div className={`p-1 rounded ${currentRoleId === r.id ? 'bg-white/20' : 'bg-gray-100 group-hover:bg-white'}`}><RoleIcon size={16} strokeWidth={2.5} /></div><div><span className="font-bold text-xs block">{r.name}</span><span className="text-[10px] font-semibold opacity-80 uppercase tracking-wider">{r.actionText}</span></div></div><span className={`text-[10px] font-black px-1.5 py-0.5 rounded ${r.currentAp === 0 ? 'bg-red-500 text-white' : 'bg-white/30'}`}>{r.currentAp}</span></div></button> )})}
                            </div>
                        </div>

                        <div className="flex-1 bg-slate-200 p-3 overflow-y-auto relative" onClick={() => setSelectedPatientId(null)}>
                            <div className={`grid grid-cols-5 gap-3 h-full transition-all duration-300 ${selectedPatientId ? 'scale-[0.98]' : ''}`}>
                                <div className="col-span-1 bg-red-50/50 rounded-xl border border-red-100/50 p-2 flex flex-col gap-2">
                                    <div className="text-[10px] font-black text-red-300 uppercase tracking-widest text-center">Intake Area</div>
                                    <div className="flex-1 min-h-0 grid grid-rows-3 gap-2">
                                        <div className="row-span-2"><ZoneDisplay zone={ZONES[0]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                        <div className="row-span-1"><ZoneDisplay zone={ZONES[1]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                    </div>
                                </div>
                                <div className="col-span-1 bg-blue-50/50 rounded-xl border border-blue-100/50 p-2 flex flex-col gap-2">
                                    <div className="text-[10px] font-black text-blue-300 uppercase tracking-widest text-center">Acute Zone</div>
                                    <div className="flex-1 min-h-0 grid grid-rows-3 gap-2">
                                        <div className="row-span-1"><ZoneDisplay zone={ZONES[2]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                        <div className="row-span-1"><ZoneDisplay zone={ZONES[3]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                        <div className="row-span-1"><ZoneDisplay zone={ZONES[5]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                    </div>
                                </div>
                                <div className="col-span-1 bg-purple-50/50 rounded-xl border border-purple-100/50 p-2 flex flex-col gap-2">
                                    <div className="text-[10px] font-black text-purple-300 uppercase tracking-widest text-center">Imaging</div>
                                    <div className="flex-1 min-h-0 grid grid-rows-3 gap-2">
                                        <div className="row-span-1"><ZoneDisplay zone={ZONES[4]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                        <div className="row-span-2"></div> 
                                    </div>
                                </div>
                                <div className="col-span-1 bg-emerald-50/50 rounded-xl border border-emerald-100/50 p-2 flex flex-col gap-2">
                                    <div className="text-[10px] font-black text-emerald-300 uppercase tracking-widest text-center">Ward Block</div>
                                    <div className="flex-1 min-h-0 grid grid-rows-3 gap-2">
                                        <div className="row-span-1"><ZoneDisplay zone={ZONES[6]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                        <div className="row-span-1"><ZoneDisplay zone={ZONES[7]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                        <div className="row-span-1"></div>
                                    </div>
                                </div>
                                <div className="col-span-1 bg-gray-100/50 rounded-xl border border-gray-200/50 p-2 flex flex-col gap-2">
                                    <div className="text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">Operations & Exit</div>
                                    <div className="flex-1 min-h-0 grid grid-rows-3 gap-2">
                                        <div className="row-span-1"><ZoneDisplay zone={ZONES[8]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                        <div className="row-span-1"><ZoneDisplay zone={ZONES[9]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                        <div className="row-span-1"><ZoneDisplay zone={ZONES[10]} patients={patients} onSelect={setSelectedPatientId} selectedPatientId={selectedPatientId} onDrop={handleDrop} /></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <footer className="bg-white border-t border-gray-200 p-2 text-[10px] text-gray-500 flex justify-between items-center shrink-0">
                        <div className="flex gap-4"><span>© 2025 WMEBEM. Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">CC BY-NC-SA 4.0</a>.</span><span>Free to use and modify with attribution.</span></div>
                        <div className="flex gap-4"><a href="https://www.england.nhs.uk/ourwork/eprr/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-bold">NHS England EPRR</a><span>•</span><a href="https://www.england.nhs.uk/publication/clinical-guidelines-for-major-incidents-and-mass-casualty-events/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-bold">Clinical Guidelines</a><span>•</span><a href="https://www.england.nhs.uk/wp-content/uploads/2018/12/B0128-clinical-guidelines-for-use-in-a-major-incident-v2-2020.pdf" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-bold">Download PDF</a></div>
                    </footer>
                    {selectedPatient && currentRole && ( <ActionHUD patient={selectedPatient} role={currentRole} onClose={() => setSelectedPatientId(null)} onAction={handleAction} onAbility={handleAbility} resources={resources} time={formatTime(simTime)} /> )}
                    {modalContent === 'guide' && ( <Modal title="WMEBEM Simulation Guide" onClose={() => setModalContent(null)}><UserGuide /></Modal> )}
                    {modalContent === 'roles' && ( <Modal title="Role Capabilities Key" onClose={() => setModalContent(null)}><RoleKey /></Modal> )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
