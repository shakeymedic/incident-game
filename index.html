<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMEBEM Incident Command</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; user-select: none; }
        .zone-card { transition: all 0.2s; }
        .zone-card.drag-over { background-color: #f0f9ff; border-color: #0284c7; box-shadow: 0 0 0 2px #0284c7 inset; }
        
        /* NHS / WMEBEM Standard Colours */
        .p1-bg { background-color: #fecaca; border-left: 4px solid #dc2626; } /* Red - Immediate */
        .p2-bg { background-color: #fef3c7; border-left: 4px solid #d97706; } /* Yellow - Urgent */
        .p3-bg { background-color: #d1fae5; border-left: 4px solid #059669; } /* Green - Delayed */
        .dead-bg { background-color: #e2e8f0; border-left: 4px solid #1e293b; } /* Black/Grey - Expectant/Dead */
        
        .vital-red { color: #dc2626; font-weight: 900; animation: pulse 2s infinite; }
        .vital-amber { color: #d97706; font-weight: bold; }
        .vital-normal { color: #059669; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .logo-h { height: 3rem; width: auto; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- GAME CONSTANTS ---
        const LOGO_URL = "https://iili.io/KGQOvkl.md.png";
        
        const PHASES = ['Receipt (0-4h)', 'Definitive Care (4-12h)', 'Recovery (12-48h)'];
        
        // --- EXPANDED ROLES (10 ROLES) ---
        const ALL_ROLES = [
            // COMMAND (Silver/Grey)
            { id: 'silver', type: 'command', name: 'Silver Commander', ap: 4, desc: 'Strategy & Resource', ability: 'Request Mutual Aid (+3 Staff)', abilityCost: 2, actionText: 'Review / Command' },
            { id: 'bronze', type: 'command', name: 'ED Consultant', ap: 5, desc: 'Triage & Flow', ability: 'Rapid Triage (Reveal All Intake)', abilityCost: 2, actionText: 'Clinical Review' },
            
            // NURSING (Blue)
            { id: 'nurse_ic', type: 'nursing', name: 'Nurse in Charge', ap: 4, desc: 'Coordination', ability: 'Team Huddle (+1 AP to others)', abilityCost: 1, actionText: 'Coordinate Care' },
            { id: 'nurse_triage', type: 'nursing', name: 'Triage Nurse', ap: 4, desc: 'Assessment', ability: 'Stream to Minors (Move P3 Free)', abilityCost: 1, actionText: 'Assess / Vitals' },
            { id: 'nurse_resus', type: 'nursing', name: 'Resus Nurse', ap: 4, desc: 'Critical Care', ability: 'IV Access (Treat P1 +1 AP)', abilityCost: 0, actionText: 'Give Meds / Obs' },
            { id: 'nurse_majors', type: 'nursing', name: 'Majors Nurse', ap: 4, desc: 'Ward Care', ability: 'Analgesia (Treat P2 +1 AP)', abilityCost: 0, actionText: 'Give Meds / Obs' },
            
            // MEDICAL (Green)
            { id: 'resident', type: 'medical', name: 'ED Resident', ap: 4, desc: 'Treatment', ability: 'Fast Track (Instant Treat P3)', abilityCost: 2, actionText: 'Perform Procedure' },
            
            // SUPPORT (Purple)
            { id: 'radiology', type: 'support', name: 'Radiology Lead', ap: 3, desc: 'Diagnostics', ability: 'Rapid Scan (Move to CT Free)', abilityCost: 1, actionText: 'Perform Scan' },
            { id: 'theatre', type: 'support', name: 'Theatre Coord', ap: 3, desc: 'Surgical Flow', ability: 'Clear Theatre (Free ICU Move)', abilityCost: 1, actionText: 'Prep Theatre' },
            
            // LOGISTICS (Amber)
            { id: 'bed_manager', type: 'logistics', name: 'Bed Manager', ap: 3, desc: 'Flow', ability: 'Force Discharge (Clear Ward Bed)', abilityCost: 1, actionText: 'Breach Protocol' }
        ];

        const ZONES = [
            { id: 'amb', name: 'Ambulance Bay', capacity: 12, type: 'intake' },
            { id: 'triage', name: 'Triage Lane', capacity: 10, type: 'process' },
            { id: 'resus', name: 'Resus (P1)', capacity: 4, type: 'clinical' },
            { id: 'majors', name: 'Majors (P2)', capacity: 10, type: 'clinical' },
            { id: 'minors', name: 'Minors (P3)', capacity: 15, type: 'clinical' },
            { id: 'ct', name: 'CT Scanner', capacity: 1, type: 'diagnostic' },
            { id: 'theatre', name: 'Theatres', capacity: 2, type: 'treatment' },
            { id: 'icu', name: 'ICU/HDU', capacity: 6, type: 'ward' },
            { id: 'ward', name: 'Wards', capacity: 30, type: 'ward' },
            { id: 'morgue', name: 'Mortuary', capacity: 999, type: 'exit' },
            { id: 'discharged', name: 'Discharged', capacity: 999, type: 'exit' }
        ];

        // --- PATIENT DATA GENERATORS ---
        const NAMES = ["Smith", "Jones", "Taylor", "Brown", "Williams", "Wilson", "Johnson", "Davies", "Robinson", "Wright", "Thompson", "Evans", "Walker", "White", "Roberts", "Green", "Hall", "Wood", "Harris", "Martin"];
        const FIRST_NAMES = ["James", "John", "Robert", "Michael", "William", "David", "Richard", "Joseph", "Thomas", "Charles", "Mary", "Patricia", "Jennifer", "Linda", "Elizabeth", "Barbara", "Susan", "Jessica", "Sarah", "Karen"];

        const generateIdentity = () => {
            const first = FIRST_NAMES[Math.floor(Math.random() * FIRST_NAMES.length)];
            const last = NAMES[Math.floor(Math.random() * NAMES.length)];
            const r = Math.random();
            let age;
            if (r < 0.15) age = Math.floor(Math.random() * 12) + "y"; 
            else if (r < 0.75) age = Math.floor(Math.random() * 50) + 18 + "y"; 
            else age = Math.floor(Math.random() * 20) + 70 + "y"; 
            
            const gender = Math.random() > 0.5 ? "M" : "F";
            return { name: `${first} ${last}`, age, gender };
        };

        const PATIENT_DECK = [
            { id: 'P1-001', category: 'P1', injuryLoc: 'chest', text: 'GSW Chest. <C>ABC issue. Needs: Chest Drain, Thoracotomy.', vitals: { hr: 140, sbp: 70, rr: 32, gcs: 14, spo2: 88 } },
            { id: 'P1-002', category: 'P1', injuryLoc: 'abdo', text: 'Blast Abdomen. Rigid. Needs: Damage Control Surgery.', vitals: { hr: 130, sbp: 85, rr: 24, gcs: 15, spo2: 94 } },
            { id: 'P1-003', category: 'P1', injuryLoc: 'chest', text: 'Open Thoracic Wound. Sucking. Needs: Seal, Drain.', vitals: { hr: 120, sbp: 90, rr: 30, gcs: 14, spo2: 90 } },
            { id: 'P1-004', category: 'P1', injuryLoc: 'leg', text: 'Crush Injury >4h. Hyperkalaemia. Needs: ICU.', vitals: { hr: 110, sbp: 100, rr: 20, gcs: 15, spo2: 96 } },
            { id: 'P2-001', category: 'P2', injuryLoc: 'abdo', text: 'Stable Penetrating Abdomen. FAST positive.', vitals: { hr: 95, sbp: 110, rr: 18, gcs: 15, spo2: 98 } },
            { id: 'P2-002', category: 'P2', injuryLoc: 'abdo', text: 'Pelvic #. Binder applied. Stable.', vitals: { hr: 100, sbp: 105, rr: 20, gcs: 15, spo2: 97 } },
            { id: 'P2-003', category: 'P2', injuryLoc: 'head', text: 'TBI. Pupillary asymmetry. Needs: Urgent CT.', vitals: { hr: 60, sbp: 160, rr: 12, gcs: 10, spo2: 96 } },
            { id: 'P3-001', category: 'P3', injuryLoc: 'arm', text: 'Laceration Arm. Controlled. Needs: Suture.', vitals: { hr: 80, sbp: 120, rr: 14, gcs: 15, spo2: 99 } },
            { id: 'P3-002', category: 'P3', injuryLoc: 'head', text: 'Closed Head Injury. Needs: Obs.', vitals: { hr: 76, sbp: 118, rr: 14, gcs: 15, spo2: 100 } },
            { id: 'CBRN-01', category: 'P1', injuryLoc: 'head', text: 'Nerve Agent. Pinpoint pupils. Needs: DECON, Atropine.', vitals: { hr: 45, sbp: 90, rr: 30, gcs: 9, spo2: 85 } }
        ];

        const EVENTS = [
            { title: "Major Incident Declared", effect: "Activate Plan. Clear ED." },
            { title: "Second Wave", effect: "Add 4 patients to Ambulance Bay." },
            { title: "CT Failure", effect: "CT Capacity 0 for this turn." },
            { title: "Mutual Aid", effect: "Gain 5 Staff Resources." },
            { title: "Blood Shortage", effect: "Blood Resources halved." }
        ];

        // --- COMPONENTS ---

        const StickFigure = ({ injuryLoc }) => (
            <svg width="30" height="50" viewBox="0 0 100 100" className="overflow-visible opacity-90">
                <circle cx="50" cy="15" r="12" fill="none" stroke="currentColor" strokeWidth="6" />
                <line x1="50" y1="27" x2="50" y2="60" stroke="currentColor" strokeWidth="6" />
                <line x1="50" y1="35" x2="20" y2="50" stroke="currentColor" strokeWidth="6" />
                <line x1="50" y1="35" x2="80" y2="50" stroke="currentColor" strokeWidth="6" />
                <line x1="50" y1="60" x2="30" y2="95" stroke="currentColor" strokeWidth="6" />
                <line x1="50" y1="60" x2="70" y2="95" stroke="currentColor" strokeWidth="6" />
                {injuryLoc === 'head' && <circle cx="50" cy="15" r="15" stroke="red" strokeWidth="4" fill="none" className="animate-pulse" />}
                {injuryLoc === 'chest' && <circle cx="50" cy="40" r="12" stroke="red" strokeWidth="4" fill="none" className="animate-pulse" />}
                {injuryLoc === 'abdo' && <circle cx="50" cy="55" r="10" stroke="red" strokeWidth="4" fill="none" className="animate-pulse" />}
                {injuryLoc === 'arm' && <circle cx="20" cy="50" r="8" stroke="red" strokeWidth="4" fill="none" className="animate-pulse" />}
                {injuryLoc === 'leg' && <circle cx="30" cy="90" r="8" stroke="red" strokeWidth="4" fill="none" className="animate-pulse" />}
            </svg>
        );

        const VitalsDisplay = ({ vitals }) => {
            const getVitalClass = (val, type) => {
                if (type === 'hr') return (val > 120 || val < 50) ? 'vital-red' : (val > 100 ? 'vital-amber' : 'vital-normal');
                if (type === 'sbp') return (val < 90) ? 'vital-red' : (val < 100 ? 'vital-amber' : 'vital-normal');
                if (type === 'rr') return (val > 30 || val < 10) ? 'vital-red' : (val > 22 ? 'vital-amber' : 'vital-normal');
                return 'text-gray-600';
            };
            return (
                <div className="grid grid-cols-2 gap-x-1 text-[9px] font-mono mt-0.5 bg-white/50 p-0.5 rounded leading-none">
                    <div>HR:<span className={getVitalClass(vitals.hr, 'hr')}>{vitals.hr}</span></div>
                    <div>BP:<span className={getVitalClass(vitals.sbp, 'sbp')}>{vitals.sbp}</span></div>
                    <div>RR:<span className={getVitalClass(vitals.rr, 'rr')}>{vitals.rr}</span></div>
                    <div>SpO2:<span className={getVitalClass(vitals.spo2, 'spo2')}>{vitals.spo2}</span></div>
                </div>
            );
        };

        const PatientCard = ({ patient, onSelect, isSelected, onDragStart }) => {
            const getColorClass = (cat) => {
                if(cat === 'P1') return "p1-bg";
                if(cat === 'P2') return "p2-bg";
                if(cat === 'P3') return "p3-bg";
                return "dead-bg";
            };
            
            const isRevealed = patient.location !== 'amb' || patient.triaged;

            return (
                <div 
                    draggable
                    onDragStart={(e) => onDragStart(e, patient.uniqueId)}
                    onClick={() => onSelect(patient)}
                    className={`p-1.5 rounded shadow-sm border border-black/5 text-xs cursor-grab active:cursor-grabbing mb-1.5 ${getColorClass(patient.category)} ${isSelected ? 'ring-2 ring-blue-600 ring-offset-1' : 'hover:shadow-md'} transition-all relative select-none`}
                >
                    <div className="flex justify-between items-start mb-0.5">
                        <div className="overflow-hidden">
                            <span className="font-bold text-gray-900 block leading-none truncate">{patient.name}</span>
                            <span className="text-[9px] text-gray-600 truncate block">{patient.age} {patient.gender}</span>
                        </div>
                        {isRevealed ? (
                            <span className="px-1 py-0 bg-white/80 rounded text-[9px] font-black border border-black/10">{patient.category}</span>
                        ) : (
                            <span className="px-1 py-0 bg-gray-200 rounded text-[9px] font-bold text-gray-500">?</span>
                        )}
                    </div>
                    
                    {isRevealed ? (
                        <>
                            <div className="flex gap-1.5 items-center">
                                <div className="text-gray-800 text-[9px] leading-tight flex-1 line-clamp-2 h-6">{patient.text}</div>
                            </div>
                            <VitalsDisplay vitals={patient.vitals} />
                        </>
                    ) : (
                        <div className="text-[9px] text-gray-500 italic py-1 text-center">Awaiting Triage...</div>
                    )}

                    <div className="mt-0.5 flex justify-between items-center text-[9px] font-medium text-gray-600 border-t border-black/5 pt-0.5">
                        {patient.treated ? 
                            <span className="text-emerald-700 font-bold flex items-center gap-1">✓ Stable</span> : 
                            <span className="text-amber-700 font-bold flex items-center gap-1">⚠ Unstable</span>
                        }
                        {patient.category === 'P1' && !patient.treated && (
                             <span className="text-red-600 animate-pulse font-black">CRITICAL</span>
                        )}
                    </div>
                </div>
            );
        };

        const ZoneDisplay = ({ zone, patients, onPatientSelect, selectedPatientId, onDrop, onDragOver }) => {
            const zonePatients = patients.filter(p => p.location === zone.id);
            const isFull = zonePatients.length >= zone.capacity;
            const isOverflow = zonePatients.length > zone.capacity;

            return (
                <div 
                    onDragOver={onDragOver}
                    onDrop={(e) => onDrop(e, zone.id)}
                    className={`bg-white rounded-lg shadow-sm border h-full flex flex-col overflow-hidden zone-card ${isOverflow ? 'border-red-500 ring-2 ring-red-200' : 'border-gray-200'}`}
                >
                    <div className={`px-2 py-1.5 border-b flex justify-between items-center ${zone.id === 'morgue' ? 'bg-gray-800 text-white' : 'bg-gray-50 text-gray-700'}`}>
                        <h3 className="font-bold text-[10px] uppercase tracking-wide truncate">{zone.name}</h3>
                        <span className={`text-[9px] font-black px-1.5 py-0.5 rounded ${isFull ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-600'}`}>
                            {zonePatients.length}/{zone.capacity}
                        </span>
                    </div>
                    <div className="flex-1 p-1.5 overflow-y-auto bg-slate-50 min-h-[100px]">
                        {zonePatients.length === 0 ? (
                            <div className="h-full flex items-center justify-center text-gray-300 text-[9px] font-bold uppercase tracking-widest pointer-events-none">Drop Here</div>
                        ) : (
                            zonePatients.map(p => (
                                <PatientCard 
                                    key={p.uniqueId} 
                                    patient={p} 
                                    onSelect={onPatientSelect}
                                    isSelected={selectedPatientId === p.uniqueId}
                                    onDragStart={(e, id) => e.dataTransfer.setData("patientId", id)}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const SitrepForm = ({ turn, patients }) => {
            const p1Count = patients.filter(p => p.category === 'P1' && p.location !== 'discharged' && p.location !== 'morgue').length;
            const p2Count = patients.filter(p => p.category === 'P2' && p.location !== 'discharged' && p.location !== 'morgue').length;
            const p3Count = patients.filter(p => p.category === 'P3' && p.location !== 'discharged' && p.location !== 'morgue').length;
            const total = p1Count + p2Count + p3Count;

            return (
                <div className="space-y-4">
                    <div className="flex items-center gap-2 mb-2 justify-center">
                        <img src={LOGO_URL} className="h-8" />
                        <span className="font-bold text-blue-900">WMEBEM Incident Command</span>
                    </div>
                    <div className="bg-amber-50 border-l-4 border-amber-500 p-3 text-xs text-amber-800">
                        <strong>Command Note:</strong> Ensure accuracy. False reporting costs points.
                    </div>
                    <div className="border rounded bg-white overflow-hidden text-sm">
                        <div className="bg-gray-100 px-4 py-2 font-bold border-b text-center text-gray-600">METHANE Report</div>
                        <div className="p-4 space-y-2">
                            <div className="grid grid-cols-6 gap-2 items-center">
                                <div className="font-bold text-right text-gray-500">M</div>
                                <div className="col-span-5"><input type="text" className="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-xs font-mono" value="MAJOR INCIDENT DECLARED" readOnly /></div>
                            </div>
                            <div className="grid grid-cols-6 gap-2 items-center">
                                <div className="font-bold text-right text-gray-500">N</div>
                                <div className="col-span-5 grid grid-cols-4 gap-2">
                                    <div className="bg-red-50 border border-red-100 rounded p-1 text-center">
                                        <div className="text-[10px] text-red-500 font-bold">P1</div>
                                        <div className="font-bold text-red-700">{p1Count}</div>
                                    </div>
                                    <div className="bg-yellow-50 border border-yellow-100 rounded p-1 text-center">
                                        <div className="text-[10px] text-yellow-600 font-bold">P2</div>
                                        <div className="font-bold text-yellow-700">{p2Count}</div>
                                    </div>
                                    <div className="bg-green-50 border border-green-100 rounded p-1 text-center">
                                        <div className="text-[10px] text-green-600 font-bold">P3</div>
                                        <div className="font-bold text-green-700">{p3Count}</div>
                                    </div>
                                    <div className="bg-gray-50 border border-gray-100 rounded p-1 text-center">
                                        <div className="text-[10px] text-gray-500 font-bold">TOT</div>
                                        <div className="font-bold text-gray-700">{total}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const UserGuide = () => (
            <div className="space-y-4 text-sm text-gray-700">
                <div className="flex items-center gap-3 mb-4 border-b pb-4">
                    <img src={LOGO_URL} className="h-12" />
                    <div>
                        <h3 className="font-bold text-lg text-blue-900">Digital Simulation Guide</h3>
                        <p className="text-xs text-gray-500">WMEBEM Official Training Tool</p>
                    </div>
                </div>
                
                <div>
                    <h4 className="font-bold text-blue-800 mb-1">1. Objectives</h4>
                    <ul className="list-disc pl-5 space-y-1 text-xs">
                        <li>**Triage:** Identify P1 (Red) patients immediately.</li>
                        <li>**Flow:** Keep the Ambulance Bay clear. Blockage = Failure.</li>
                        <li>**Treat:** Use AP to stabilise patients. P1s die if untreated.</li>
                    </ul>
                </div>

                <div>
                    <h4 className="font-bold text-blue-800 mb-1">2. Key Roles (Expanded)</h4>
                    <ul className="space-y-2 text-xs">
                        <li className="bg-slate-50 p-2 rounded border-l-4 border-gray-400">
                            <span className="font-bold block text-gray-800">Command (Silver/Bronze)</span>
                            Strategic oversight & Triage.
                        </li>
                        <li className="bg-blue-50 p-2 rounded border-l-4 border-blue-600">
                            <span className="font-bold block text-blue-800">Nursing Team</span>
                            Coordinate (Huddle), Assessment (Stream P3), & Care (Meds/Obs).
                        </li>
                        <li className="bg-emerald-50 p-2 rounded border-l-4 border-emerald-500">
                            <span className="font-bold block text-emerald-800">Medical Team</span>
                            Procedures, Prescribing & Fast Tracking.
                        </li>
                         <li className="bg-purple-50 p-2 rounded border-l-4 border-purple-500">
                            <span className="font-bold block text-purple-800">Support (Rad/Theatre)</span>
                            Rapid Diagnostics & Surgical logistics.
                        </li>
                        <li className="bg-amber-50 p-2 rounded border-l-4 border-amber-500">
                            <span className="font-bold block text-amber-800">Logistics (Bed Manager)</span>
                            Force Discharge (Clear Wards).
                        </li>
                    </ul>
                </div>
                
                <div>
                    <h4 className="font-bold text-blue-800 mb-1">3. Winning Strategy</h4>
                    <ul className="list-disc pl-5 space-y-1 text-xs">
                         <li>**Prioritise P1s:** They die if untreated for 1 turn.</li>
                         <li>**Clear P3s:** Discharge green patients to score points and clear space.</li>
                         <li>**Use Specialists:** Resus Nurse treats P1s cheaply. Bed Manager clears blocked beds.</li>
                    </ul>
                </div>
            </div>
        );

        // FIXED MODAL FOR MOBILE
        const Modal = ({ title, children, actions }) => (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90dvh] flex flex-col overflow-hidden transform transition-all border border-gray-200">
                    <div className="bg-slate-50 px-6 py-4 flex justify-between items-center border-b shrink-0">
                        <h2 className="text-lg font-bold text-slate-800 tracking-wide">{title}</h2>
                    </div>
                    <div className="p-6 overflow-y-auto flex-1">
                        {children}
                    </div>
                    <div className="bg-gray-50 px-6 py-4 border-t flex justify-end gap-3 shrink-0">
                        {actions}
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [gameState, setGameState] = useState('start');
            const [playerCount, setPlayerCount] = useState(1);
            const [turn, setTurn] = useState(1);
            const [score, setScore] = useState(100);
            const [deaths, setDeaths] = useState(0);
            const [discharged, setDischarged] = useState(0);
            
            const [roleStates, setRoleStates] = useState([]);
            const [currentRoleId, setCurrentRoleId] = useState(null);
            
            const [patients, setPatients] = useState([]);
            const [selectedPatientId, setSelectedPatientId] = useState(null);
            const [resources, setResources] = useState({ staff: 15, blood: 20, vents: 8 });
            
            const [eventLog, setEventLog] = useState([]);
            const [modalContent, setModalContent] = useState(null);

            const currentRole = roleStates.find(r => r.id === currentRoleId);
            const selectedPatient = patients.find(p => p.uniqueId === selectedPatientId);

            const addLog = (msg) => setEventLog(prev => [`T${turn}: ${msg}`, ...prev]);

            // --- ROLE HELPER ---
            const getRoleStyle = (type, isSelected) => {
                let base = "";
                if (type === 'command') base = isSelected ? "bg-slate-200 border-slate-600 text-slate-900" : "hover:bg-slate-50 border-transparent text-slate-700";
                if (type === 'nursing') base = isSelected ? "bg-blue-100 border-blue-600 text-blue-900" : "hover:bg-blue-50 border-transparent text-blue-800";
                if (type === 'medical') base = isSelected ? "bg-emerald-100 border-emerald-600 text-emerald-900" : "hover:bg-emerald-50 border-transparent text-emerald-800";
                if (type === 'support') base = isSelected ? "bg-purple-100 border-purple-600 text-purple-900" : "hover:bg-purple-50 border-transparent text-purple-800";
                if (type === 'logistics') base = isSelected ? "bg-amber-100 border-amber-600 text-amber-900" : "hover:bg-amber-50 border-transparent text-amber-800";
                
                return `${base} border-l-4`;
            };

            // --- ACTIONS ---

            const startGame = () => {
                const initialRoles = ALL_ROLES.map(r => ({ ...r, currentAp: r.ap }));
                setRoleStates(initialRoles);
                setCurrentRoleId(initialRoles[0].id);
                setEventLog([`MAJOR INCIDENT DECLARED. Team size: ${playerCount}`]);
                spawnPatients(5); 
                setGameState('playing');
                setScore(100);
            };

            const spawnPatients = (count) => {
                const newPatients = [];
                for(let i=0; i<count; i++) {
                    const template = PATIENT_DECK[Math.floor(Math.random() * PATIENT_DECK.length)];
                    newPatients.push({
                        ...template,
                        ...generateIdentity(),
                        uniqueId: Date.now() + i + Math.random(),
                        location: 'amb',
                        triaged: false,
                        treated: false,
                        turnsUntreated: 0
                    });
                }
                setPatients(prev => [...prev, ...newPatients]);
            };

            const handleDrop = (e, targetZoneId) => {
                e.preventDefault();
                const patientId = Number(e.dataTransfer.getData("patientId"));
                const patient = patients.find(p => p.uniqueId === patientId);
                
                if (!patient || !currentRole) return;
                if (currentRole.currentAp < 1) {
                    alert("No Action Points remaining!");
                    return;
                }
                if (patient.location === targetZoneId) return;

                setRoleStates(prev => prev.map(r => r.id === currentRoleId ? { ...r, currentAp: r.currentAp - 1 } : r));
                
                let updates = { location: targetZoneId };
                // Triage Logic
                if (['triage', 'resus', 'majors'].includes(targetZoneId)) {
                    if (!patient.triaged) {
                        updates.triaged = true;
                        addLog(`${currentRole.name} Triaged ${patient.name}: ${patient.category}`);
                    }
                }
                
                if (targetZoneId === 'icu' && resources.vents > 0) {
                     setResources(prev => ({ ...prev, vents: prev.vents - 1 }));
                }

                if (targetZoneId === 'discharged') {
                    if (patient.treated) {
                        setScore(s => s + 50);
                        setDischarged(d => d + 1);
                        addLog(`${patient.name} discharged.`);
                    } else {
                        setScore(s => s - 20);
                        addLog(`WARNING: ${patient.name} discharged unstable!`);
                    }
                }

                setPatients(prev => prev.map(p => p.uniqueId === patientId ? { ...p, ...updates } : p));
                setSelectedPatientId(patientId); 
            };

            const handleTreat = () => {
                if (!selectedPatient || currentRole.currentAp < 1 || selectedPatient.treated) return;
                if (selectedPatient.category === 'P1' && resources.blood < 1) {
                    alert("Not enough Blood products!");
                    return;
                }

                setRoleStates(prev => prev.map(r => r.id === currentRoleId ? { ...r, currentAp: r.currentAp - 1 } : r));
                setPatients(prev => prev.map(p => p.uniqueId === selectedPatientId ? { ...p, treated: true } : p));
                
                if (selectedPatient.category === 'P1') {
                    setResources(prev => ({ ...prev, blood: prev.blood - 1 }));
                }
                
                setScore(s => s + 10);
                addLog(`${currentRole.name}: ${currentRole.actionText} on ${selectedPatient.name}.`);
            };

            const useSpecialAbility = () => {
                if (currentRole.currentAp < currentRole.abilityCost) return;

                setRoleStates(prev => prev.map(r => r.id === currentRoleId ? { ...r, currentAp: r.currentAp - currentRole.abilityCost } : r));
                addLog(`${currentRole.name} used ${currentRole.ability}`);

                switch(currentRole.id) {
                    case 'silver': setResources(prev => ({ ...prev, staff: prev.staff + 3 })); break;
                    case 'bronze': setPatients(prev => prev.map(p => p.location === 'amb' ? { ...p, triaged: true } : p)); break;
                    case 'nurse_ic': setRoleStates(prev => prev.map(r => r.id !== 'nurse_ic' ? { ...r, currentAp: Math.min(r.ap, r.currentAp + 1) } : r)); break;
                    case 'nurse_triage': 
                        const p3Untriaged = patients.find(p => p.location === 'amb' && p.category === 'P3' && !p.triaged);
                        if(p3Untriaged) {
                            setPatients(prev => prev.map(p => p.uniqueId === p3Untriaged.uniqueId ? { ...p, location: 'minors', triaged: true } : p));
                            addLog(`Streamed ${p3Untriaged.name} to Minors`);
                        }
                        break;
                    case 'resident': 
                        const p3 = patients.find(p => p.location === 'minors' && !p.treated && p.category === 'P3');
                        if (p3) {
                            setPatients(prev => prev.map(p => p.uniqueId === p3.uniqueId ? { ...p, treated: true } : p));
                            addLog(`Fast Tracked ${p3.name}`);
                        }
                        break;
                    case 'radiology':
                        const needCT = patients.find(p => (p.location === 'resus' || p.location === 'majors') && !p.treated);
                        if(needCT) {
                             setPatients(prev => prev.map(p => p.uniqueId === needCT.uniqueId ? { ...p, location: 'ct' } : p));
                             addLog(`Rapid Scan for ${needCT.name}`);
                        }
                        break;
                    case 'theatre':
                        const surg = patients.find(p => p.location === 'theatre' && p.treated);
                        if (surg) setPatients(prev => prev.map(p => p.uniqueId === surg.uniqueId ? { ...p, location: 'icu' } : p));
                        break;
                    case 'bed_manager':
                         setScore(s => s - 5); // penalty for forcing discharge
                         addLog("Forced Discharge executed. Bed cleared.");
                         break;
                }
            };

            const confirmNextTurn = () => {
                setModalContent(null);
                setTurn(t => t + 1);
                setRoleStates(prev => prev.map(r => ({ ...r, currentAp: r.ap })));

                if (Math.random() > 0.6) {
                    addLog(`Turn ${turn + 1} Started.`);
                }

                setPatients(prev => prev.map(p => {
                    if (p.location === 'morgue' || p.location === 'discharged') return p;
                    let newP = { ...p };
                    if (p.category === 'P1' && !p.treated) {
                        newP.turnsUntreated = (p.turnsUntreated || 0) + 1;
                        if (newP.turnsUntreated > 1) {
                            newP.location = 'morgue';
                            newP.text = "DIED DUE TO DELAYED TREATMENT";
                            setDeaths(d => d + 1);
                            setScore(s => s - 100);
                            addLog(`FATALITY: ${p.name} died awaiting treatment.`);
                        }
                    }
                    return newP;
                }));

                spawnPatients(Math.floor(Math.random() * 3) + 1);
            };
            
            const getRoleSuggestion = (count) => {
                if(count === 1) return "Solo Mode: You control all Command, Nursing, Medical, and Support roles.";
                if(count === 2) return "P1: Command + Medical | P2: Nursing + Support";
                if(count === 3) return "P1: Command | P2: Nursing | P3: Medical + Support";
                if(count >= 4) return "Assign Command, Nursing, Medical, and Support roles to different players.";
                return "";
            };

            // --- RENDERERS ---

            if (gameState === 'start') {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 overflow-y-auto">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border-t-8 border-blue-800 my-auto">
                            <img src={LOGO_URL} alt="WMEBEM Logo" className="h-24 mx-auto mb-6 object-contain" />
                            <h1 className="text-3xl font-black text-slate-900 mb-2 tracking-tight">INCIDENT<span className="text-blue-600">COMMAND</span></h1>
                            <p className="text-slate-500 mb-6 font-medium">WMEBEM Digital Simulation</p>
                            
                            <div className="mb-8">
                                <label className="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Select Team Size</label>
                                <div className="flex flex-wrap justify-center gap-2 mb-4">
                                    {[1, 2, 3, 4, 5, 6, 7, 8].map(num => (
                                        <button 
                                            key={num}
                                            onClick={() => setPlayerCount(num)}
                                            className={`w-10 h-10 rounded-xl font-bold text-lg transition-all ${playerCount === num ? 'bg-blue-600 text-white scale-110 shadow-lg' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                                        >
                                            {num}
                                        </button>
                                    ))}
                                </div>
                                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 min-h-[60px] flex items-center justify-center">
                                    <p className="text-xs text-blue-800 font-medium leading-relaxed">
                                        {getRoleSuggestion(playerCount)}
                                    </p>
                                </div>
                            </div>

                            <button onClick={startGame} className="w-full py-4 bg-blue-700 hover:bg-blue-800 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all transform active:scale-95">
                                Start Simulation
                            </button>
                            <div className="mt-4 text-xs text-slate-400">
                                Version 6.5 • WMEBEM
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen flex flex-col bg-slate-100 overflow-hidden">
                    {/* TOP BAR */}
                    <header className="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shrink-0 z-20 shadow-sm">
                        <div className="flex items-center gap-4">
                            <img src={LOGO_URL} className="logo-h" />
                            <div>
                                <div className="text-xl font-black text-slate-800 leading-none">INCIDENT<span className="text-blue-600">COMMAND</span></div>
                                <div className="text-[10px] font-bold text-gray-400 tracking-widest uppercase">Turn {turn} • {PHASES[Math.min(2, Math.floor(turn/4))]} • {playerCount} Player Mode</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-6">
                            <button onClick={() => setModalContent('guide')} className="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                User Guide
                            </button>
                            <div className="h-8 w-px bg-gray-200"></div>
                            <div className="flex gap-4 text-sm font-bold">
                                <div className="text-emerald-600 flex flex-col items-center leading-none"><span className="text-xs uppercase text-gray-400">Score</span><span className="text-xl">{score}</span></div>
                                <div className="text-blue-600 flex flex-col items-center leading-none"><span className="text-xs uppercase text-gray-400">Saved</span><span className="text-xl">{discharged}</span></div>
                                <div className="text-red-600 flex flex-col items-center leading-none"><span className="text-xs uppercase text-gray-400">Dead</span><span className="text-xl">{deaths}</span></div>
                            </div>
                            <button onClick={() => setModalContent('sitrep')} className="bg-slate-800 hover:bg-slate-900 text-white px-5 py-2 rounded-lg font-bold text-sm shadow transition-all">
                                End Turn →
                            </button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden p-4 gap-4">
                        {/* LEFT: ROLES */}
                        <div className="w-72 flex flex-col gap-3 shrink-0">
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex-1 flex flex-col min-h-0">
                                <div className="bg-slate-50 px-4 py-3 border-b border-gray-100 flex justify-between">
                                    <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">Command Staff</h3>
                                    <span className="text-[10px] text-gray-400 font-bold">{ALL_ROLES.length} Active</span>
                                </div>
                                <div className="overflow-y-auto flex-1 p-2 space-y-2">
                                    {roleStates.map(role => (
                                        <button 
                                            key={role.id} 
                                            onClick={() => { setCurrentRoleId(role.id); setSelectedPatientId(null); }} 
                                            className={`w-full text-left px-3 py-2 rounded transition-all flex justify-between items-center group shadow-sm ${getRoleStyle(role.type, currentRoleId === role.id)}`}
                                        >
                                            <div className="overflow-hidden">
                                                <div className="font-bold text-xs truncate">{role.name}</div>
                                                <div className="text-[10px] opacity-70 leading-tight truncate">{role.desc}</div>
                                            </div>
                                            <div className={`text-[10px] font-black w-6 h-6 rounded flex items-center justify-center shrink-0 ml-2 ${role.currentAp > 0 ? 'bg-white/50 text-current' : 'bg-gray-200 text-gray-400'}`}>
                                                {role.currentAp}
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            {/* ACTION PANEL */}
                            <div className="bg-white rounded-xl shadow-md border border-blue-100 p-4 shrink-0">
                                <h3 className="text-xs font-black text-blue-900 uppercase tracking-widest mb-3">Active: {currentRole?.name}</h3>
                                <div className="grid gap-2">
                                    <button onClick={handleTreat} disabled={!selectedPatient || selectedPatient.treated || currentRole.currentAp < 1} className="w-full py-2 bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-200 disabled:text-gray-400 text-white rounded font-bold text-sm transition-colors flex items-center justify-center gap-2">
                                        {currentRole?.actionText} (1 AP)
                                    </button>
                                    <button onClick={useSpecialAbility} disabled={currentRole.currentAp < currentRole.abilityCost} className="w-full py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-200 disabled:text-gray-400 text-white rounded font-bold text-sm transition-colors flex items-center justify-center gap-2">
                                        {currentRole.ability} ({currentRole.abilityCost} AP)
                                    </button>
                                </div>
                            </div>
                            
                            {/* RESOURCES */}
                            <div className="bg-slate-800 rounded-xl p-4 text-white shrink-0">
                                <div className="grid grid-cols-3 gap-2 text-center">
                                    <div className="bg-slate-700/50 rounded p-1"><div className="text-[10px] text-slate-400 uppercase">Staff</div><div className="font-bold text-lg text-blue-300">{resources.staff}</div></div>
                                    <div className="bg-slate-700/50 rounded p-1"><div className="text-[10px] text-slate-400 uppercase">Blood</div><div className="font-bold text-lg text-red-400">{resources.blood}</div></div>
                                    <div className="bg-slate-700/50 rounded p-1"><div className="text-[10px] text-slate-400 uppercase">Vents</div><div className="font-bold text-lg text-emerald-400">{resources.vents}</div></div>
                                </div>
                            </div>
                        </div>

                        {/* CENTER: BOARD */}
                        <div className="flex-1 bg-white rounded-2xl shadow-inner border border-gray-200 overflow-hidden flex flex-col relative">
                            <div className="flex-1 overflow-y-auto p-4 relative z-10 custom-scrollbar">
                                <div className="grid grid-cols-4 gap-4 h-full auto-rows-min">
                                    {/* Row 1: Intake (Taller single column) */}
                                    <div className="col-span-1 row-span-2 h-[620px]"><ZoneDisplay zone={ZONES[0]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>
                                    
                                    {/* Clinical */}
                                    <div className="col-span-1 h-[300px]"><ZoneDisplay zone={ZONES[1]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>
                                    <div className="col-span-1 h-[300px]"><ZoneDisplay zone={ZONES[2]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>
                                    <div className="col-span-1 h-[300px]"><ZoneDisplay zone={ZONES[3]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>
                                    
                                    {/* Treatment & Flow */}
                                    <div className="col-span-2 h-[300px]"><ZoneDisplay zone={ZONES[4]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>
                                    <div className="col-span-1 h-[300px]"><ZoneDisplay zone={ZONES[5]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>

                                    {/* Wards & Exit */}
                                    <div className="col-span-1 h-[200px]"><ZoneDisplay zone={ZONES[6]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>
                                    <div className="col-span-1 h-[200px]"><ZoneDisplay zone={ZONES[7]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>
                                    <div className="col-span-2 h-[200px]"><ZoneDisplay zone={ZONES[8]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>
                                    <div className="col-span-2 h-[200px]"><ZoneDisplay zone={ZONES[10]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>
                                    <div className="col-span-2 h-[200px]"><ZoneDisplay zone={ZONES[9]} patients={patients} onPatientSelect={(p)=>setSelectedPatientId(p.uniqueId)} selectedPatientId={selectedPatientId} onDrop={handleDrop} onDragOver={e=>e.preventDefault()} /></div>
                                </div>
                            </div>
                        </div>

                        {/* RIGHT: INFO & LOGS */}
                        <div className="w-64 flex flex-col gap-4 shrink-0">
                            <div className="h-1/2 bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col">
                                <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-2">Patient Detail</h3>
                                {selectedPatient ? (
                                    <div className="flex-1 overflow-y-auto">
                                        <div className="flex items-center gap-3 mb-4">
                                            <StickFigure injuryLoc={selectedPatient.injuryLoc} />
                                            <div>
                                                <div className="font-bold text-lg leading-none">{selectedPatient.name}</div>
                                                <div className="text-xs text-gray-500 mt-1">{selectedPatient.age} {selectedPatient.gender}</div>
                                                <span className="inline-block mt-1 px-2 py-0.5 bg-blue-100 text-blue-800 text-[10px] font-bold rounded">{selectedPatient.id}</span>
                                            </div>
                                        </div>
                                        <div className="space-y-3">
                                            <div className="bg-slate-50 p-2 rounded border border-slate-100">
                                                <div className="text-[10px] font-bold text-slate-400 uppercase">Condition</div>
                                                <p className="text-sm text-slate-700 font-medium leading-snug">{selectedPatient.text}</p>
                                            </div>
                                            <VitalsDisplay vitals={selectedPatient.vitals} />
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex-1 flex items-center justify-center text-gray-300 text-sm italic">Select a patient</div>
                                )}
                            </div>
                            <div className="h-1/2 bg-slate-900 rounded-xl shadow-inner p-3 flex flex-col overflow-hidden">
                                <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Incident Log</div>
                                <div className="flex-1 overflow-y-auto space-y-1 font-mono text-[10px] text-emerald-400/90 custom-scrollbar">
                                    {eventLog.map((l, i) => <div key={i} className="border-b border-slate-800 pb-1">{l}</div>)}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* FOOTER */}
                    <footer className="bg-white border-t border-gray-200 p-2 text-[10px] text-gray-500 flex justify-between items-center shrink-0">
                        <div className="flex gap-4">
                            <span>© 2025 WMEBEM. Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">CC BY-NC-SA 4.0</a>.</span>
                            <span>Free to use and modify with attribution.</span>
                        </div>
                        <div className="flex gap-4">
                            <a href="https://www.england.nhs.uk/ourwork/eprr/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-bold">NHS England EPRR</a>
                            <span>•</span>
                            <a href="https://www.england.nhs.uk/publication/clinical-guidelines-for-major-incidents-and-mass-casualty-events/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-bold">Clinical Guidelines</a>
                            <span>•</span>
                            <a href="https://www.england.nhs.uk/wp-content/uploads/2018/12/B0128-clinical-guidelines-for-use-in-a-major-incident-v2-2020.pdf" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-bold">Download PDF</a>
                        </div>
                    </footer>

                    {/* MODALS */}
                    {modalContent === 'sitrep' && (
                        <Modal title={`Turn ${turn} Command SITREP`} actions={<button onClick={confirmNextTurn} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold shadow-lg">Submit & Next Turn</button>}>
                            <SitrepForm turn={turn} patients={patients} />
                        </Modal>
                    )}
                    {modalContent === 'guide' && (
                        <Modal title="WMEBEM Simulation Guide" actions={<button onClick={() => setModalContent(null)} className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded font-bold shadow-lg">Close Guide</button>}>
                            <UserGuide />
                        </Modal>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


